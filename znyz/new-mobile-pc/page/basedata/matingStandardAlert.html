<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>layui</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<body>
		
		<table class="layui-hide" id="farmInfo" lay-filter="farmInfo"></table>

</script>


		<!-- 国际化        -->
		<script src="../../statics/plugins/i18n/i18next.min.js"></script>
		<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
		<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
		<script>
			var authToken = localStorage.getItem("authToken");
			//alert(authToken);
			var user = localStorage.getItem("user");
			
			var farmId = GetQueryString("farmId"); 
			var variety = GetQueryString("variety"); 
			var strain = GetQueryString("strain");
			var parity = GetQueryString("parity"); 
			var pigs_number = GetQueryString("pigs_number");
			

			i18n('../../locales', onLangReady) //国际化
			function onLangReady() {
				if (!checkToken()) {
					alert(i18next.t("timeout"));
					window.top.location.href = '../../login.html';
				}

				layui.use(['form', 'table', 'laydate'], function() {
						var table = layui.table;
						var form = layui.form;
						var laydate = layui.laydate;
						var $ = layui.$;
						getGroupList()
						bindFarmSelectList()
						//方法级渲染
						table.render({
							elem: '#farmInfo',
							url: commonIP + "api/pig/matingstandard/getMatingStandardList?authToken=" + authToken +"&farmId="+farmId+"&variety="+variety+"&strain="+strain+"&parity="+parity+"&pigs_number="+pigs_number//数据请求路径
								,
							parseData: function(res) { //res 即为原始返回的数据
								console.log(res)
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.errcode === '200' ? res.dataSource.list : [] //解析数据列表
								};
							},
							cellMinWidth: 80,
							cols: [
								[ {
										field: 'pigVarietyName',
										title: i18next.t("common.variety"),
										width: '10%'
									}, 
									{
										field: 'isInitialMatch',
										title: i18next.t("common.strain"),
										width: '8%'
									}, {
										field: 'isInitialMatch',
										title: i18next.t("common.fetalTimes"),
										width: '8%'
									}, 
									{
										field: 'score',
										title: i18next.t("matingstandard.bodyConditionRequirement"),
										width: '15%'
									}
									,{field:'remark', title: i18next.t("common.remark"),width:'20%'},
									
								
								]
							],
							done: function(res, page, count) {
								Console.log(res)
								// i18n('../../locales', function() {
								// 	$("[data-field = 'isInitialMatch']").children().each(function() {
								// 		if ($(this).text() == '1') {
								// 			$(this).text(i18next.t("yes"));
								// 		} else if ($(this).text() == '0') {
								// 			$(this).text(i18next.t("no"));
								// 		}
								// 	})
								// }) 
								//国际化

							},
							even: true //开启隔行背景
								,
							page: false //开启分页
								,
							limit: 10 //默认十条数据一页
								,
							limits: [10, 20, 30, 50] //数据分页条
								,
							id: 'testReload'
						});


						function getGroupList() {
						//获取集团下拉列表
						$.ajax({
							url: commonIP + 'api/system/group/getListPage?authToken=' + authToken + '&page=0&limit=0',
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							success: function(res) {
								var dataObj = JSON.parse(res);
								if (dataObj != null && dataObj.dataSource.list.length > 0) {
									var groupOption='<option value=""  ></option>';
									for (var i = 0; i < dataObj.dataSource.list.length; i++) {
										groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource
											.list[i].name + '</option>';
									}
									$("#groupId").append(groupOption);
									form.render('select'); //一定要加form.render();
								}
							}
						});
						form.on('select(groupId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
								/**改变集团后先清空猪场下拉值*/
								document.getElementById("farmId").options.length = 0;
									$('#farmId').val("");
									form.render('select');
									bindFarmSelectList();
							});
						}
						

					function bindFarmSelectList() {
						var groupId = $("#groupId").val();
						if(groupId==null){
							groupId='';
						}
						$.ajax({
							url: commonIP + 'api/system/farm/getListPage?authToken=' + authToken + '&page=0&limit=0&groupId=' + groupId,
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							success: function(res) {
								var dataObj = JSON.parse(res);
								if (dataObj != null && dataObj.dataSource.list.length > 0) {
									var farmOption = '<option value="">' + i18next.t("device.farmValDefault") + '</option>';
									for (var i = 0; i < dataObj.dataSource.list.length; i++) {
										farmOption = farmOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[
											i].name + '</option>';
									}
									$("#farmId").append(farmOption);
									form.render('select'); //一定要加form.render();
								}
							}
						});
					}
					//监听工具条
					table.on('tool(farmInfo)', function(obj) {
						var data = obj.data;
						if (obj.event === 'detail') {
							//layer.msg('ID：'+ data.id + ' 的查看操作');

						} else if (obj.event === 'del') {
							layer.confirm(i18next.t("delConfirm"), function(index) {
								$.ajax({
									url: commonIP + "api/pig/matingstandard/delete?authToken=" + authToken,
									type: 'POST',
									contentType: 'application/json',
									data: JSON.stringify({
										"id": data.id
									}),
									success: function(text) {
										var dataObj = JSON.parse(text);
										if (dataObj.code == 0) {
											layer.msg(dataObj.msg, {
												icon: 6
											});
											obj.del();
											layer.close(index);										 	
													window.location.reload();  
										} else {
											layer.msg(dataObj.msg, {
												icon: 5
											});
										}
									}
								});
							});
						} else if (obj.event === 'edit') {
							var index = layer.open({
								type: 2,
								content: "addMatingStandard.html?id=" + data.id,
								area: ['800px', '700px'],
								maxmin: true
							});
						}
					});

					$('#add').on('click', function() {
						var index = layer.open({
							type: 2,
							content: 'addMatingStandard.html',
							area: ['700px', '600px'],
							maxmin: true
						});
						//					layer.full(index);
					});
					var active = {
						reload: function() {
							//执行重载
							table.reload('testReload', {
								page: {
									curr: 1 //重新从第 1 页开始
								},
								where: {
									farmId: $("#farmId").val(),
									groupId: $("#groupId").val()
								}
							});
						},
					};

					$('#search').on('click', function() {
						active['reload'].call(this);
					}); 
					$('#reset').on('click', function() {
						$('#farmId').empty();
						$('#groupId').empty();
						$('#name').val("");
						$('#code').val("");
						$('#type').val("");
						form.render('select');
						getGroupList()
						bindFarmSelectList();
						
					});
				});
				
				function GetQueryString(name) {
								var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
								var r = window.location.search.substr(1).match(reg);
								if (r != null) return unescape(r[2]);
								return null;
							}
			}
		</script>

	</body>
</html>
