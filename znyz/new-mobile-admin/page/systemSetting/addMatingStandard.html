<html>

	<head>
		<title>Title</title>
		<script src="../../statics/libs/jquery-1.7.2.js"></script>
		<link rel="stylesheet" href="../../statics/css/font-awesome.min.css">
		<link rel="stylesheet" href="../../common/css/cyType.css">
		<link rel="stylesheet" href="../../common/css/extendedStyle.css">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
		<script src="../../statics/plugins/layui/layui.js"></script>
		<script src="../../common/js/whole/cyLayer.js"></script>
		<script src="../../common/js/whole/utils.js"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<div class="layui-field-box">
			<form class="layui-form">
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" data-i18n="common.groupName"></label>
					<div class="layui-input-inline">
						<select id="groupId" name="groupId" lay-verify="required|groupId" lay-filter="groupId" style="height: 38px;border-color: #F0F0F0;"
						 lay-search>
							<option value=""></option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" data-i18n="common.farmName"></label>
					<div class="layui-input-inline">
						<select id="farmId" name="farmId" lay-verify="required|farmId" style="height: 38px;border-color: #F0F0F0;"
						 lay-search>
							<option value=""></option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" data-i18n="common.variety"></label>
					<div class="layui-input-inline">
						<select id="pig_variety_id" name="pigVarietyId" lay-verify="required|pig_variety_id" style="height: 38px;border-color: #F0F0F0;">
							<option value="" data-i18n="pig.varietyValDefault"></option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" data-i18n="common.strain"></label>
					<div class="layui-input-inline">
						<select id="strain" name="strain" style="height: 38px;border-color: #F0F0F0;" lay-verify="required|strain">
							<option value="" data-i18n="pig.strainValDefault"></option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" data-i18n="matingstandard.firstMatch"></label>
					<div class="layui-input-inline">
						<select id="isInitialMatch" name="isInitialMatch" style="height: 38px;border-color: #F0F0F0;" lay-verify="required|isInitialMatch">
							<option value=""></option>
							<option value="0">否</option>
							<option value="1">是</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" data-i18n="matingstandard.bodyConditionRequirement"></label>
					<div class="layui-input-inline">
						<!-- 						<input type="text" id="column_num" name="column_num" data-i18n="[placeholder]house.rowLengh" maxlength="4" oninput="value=value.replace(/[^\d]/g,'')" lay-verify="required|column_num" class="layui-input" autocomplete="off">
 -->
						<input type="text" name="score" id="score" maxlength="3" onkeyup="clearNoNum(this)" class="layui-input"  data-i18n="[placeholder]matingstandard.matingRowLengh"    lay-verify="required|score"  />
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label" data-i18n="common.remark"></label>
					<div class="layui-input-block" style="width: 490px">
						<textarea id="remark" name="remark" data-i18n="[placeholder]house.remarkPlaceholder" class="layui-textarea"
						 maxlength="100" autocomplete="off"></textarea>
					</div>
				</div>
				<div class="page-footer">
					<div class="btn-list">
						<div class="btnlist">
							<button class="layui-btn" lay-submit="" lay-filter="submit" data-i18n="[append]btnSave"><i class="fa fa-floppy-o">&nbsp;</i></button>
							<button class="layui-btn" onclick="$t.closeWindow();" data-i18n="[append]btnBack"><i class="fa fa-undo">&nbsp;</i></button>
						</div>
					</div>
				</div>
			</form>
		</div>

		<!-- 国际化        -->
		<script src="../../statics/plugins/i18n/i18next.min.js"></script>
		<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
		<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
		 <script language="JavaScript" type="text/javascript">
		   function clearNoNum(obj) {
		    //修复第一个字符是小数点 的情况.
		    if(obj.value != '' && obj.value.substr(0, 1) == '.') {
		     obj.value = "";
		    }
		    obj.value = obj.value.replace(/^0*(0\.|[1-9])/, '$1'); //解决 粘贴不生效
		    obj.value = obj.value.replace(/[^\d.]/g, ""); //清除“数字”和“.”以外的字符
		    obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个. 清除多余的     
		    obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
		    obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3'); //只能输入两个小数     
		    if(obj.value.indexOf(".") < 0 && obj.value != "") { //以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
		     if(obj.value.substr(0, 1) == '0' && obj.value.length == 2) {
		      obj.value = obj.value.substr(1, obj.value.length);
		      0
		     }
		    }
		   }
		  </script>
		<script>
			var authToken = localStorage.getItem("authToken");
			//alert(authToken);
			var user = localStorage.getItem("user");

			i18n('../../locales', onLangReady) //国际化
			function onLangReady() {
				if (!checkToken()) {
					alert(i18next.t("timeout"));
					window.top.location.href = '../../login.html';
				}
			}
			layui.use(['form', 'laydate'], function() {
				var form = layui.form;
				var $ = layui.$;
				var laydate = layui.laydate;


				var userId = GetQueryString("id"); //userId为空表示新增，否则是修改
				//alert(userId);
				if (userId != null && userId != '') {
					//	alert(1);
					$.ajax({
						type: "GET",
						url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&page=0&limit=0&id=' + userId,
						parseData: function(res) { //res 即为原始返回的数据
							return {
								"code": res.code, //解析接口状态
								"msg": res.msg, //解析提示文本
								"count": res.count, //解析数据长度
								"data": res.dataSource.list //解析数据列表
							};
						},
						async: false,
						contentType: 'application/json',
						success: function(data) {
							var datas = JSON.parse(data);
							console.log(datas);
							if (datas.errcode == 200) {
								//赋值
								groupId = datas.dataSource.list[0].group_id;
							} else {
								//alert(data.errmsg);
								if (data.errcode == "10005") {
									window.top.location.href = '../../login.html';
								}
							}
						}
					});
				}
				//获取集团下拉列表
				$.ajax({
					url: commonIP + 'api/system/group/getListPage?authToken=' + authToken + '&page=0&limit=0',
					parseData: function(res) { //res 即为原始返回的数据
						return {
							"code": res.code, //解析接口状态
							"msg": res.msg, //解析提示文本
							"count": res.count, //解析数据长度
							"data": res.dataSource.list //解析数据列表
						};
					},
					async: false,
					success: function(res) {
						var dataObj = JSON.parse(res);
						if (dataObj != null && dataObj.dataSource.list.length > 0) {
							var groupOption;
							for (var i = 0; i < dataObj.dataSource.list.length; i++) {
								if (groupId == dataObj.dataSource.list[i].id) {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '" selected="">' +
										dataObj.dataSource.list[i].name + '</option>';
								} else {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource
										.list[i].name + '</option>';
								}
							}
							$("#groupId").append(groupOption);
							form.render('select'); //一定要加form.render();
							BindFarmDropList();
						}
					}
				});

				form.on('select(groupId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
					/**改变集团后先清空猪场下拉值*/
					document.getElementById("farmId").options.length = 0;
					$('#farmId').val("");

					form.render('select');
					BindFarmDropList();
				});

				//获取猪场下拉列表
				function BindFarmDropList() {
					var groupId = $("#groupId").val();
					$.ajax({
						url: commonIP + 'api/system/farm/getListPage?authToken=' + authToken + '&page=0&limit=0&groupId=' + groupId,
						parseData: function(res) { //res 即为原始返回的数据
							return {
								"code": res.code, //解析接口状态
								"msg": res.msg, //解析提示文本
								"count": res.count, //解析数据长度
								"data": res.dataSource.list //解析数据列表
							};
						},
						async: false,
						success: function(res) {
							var dataObj = JSON.parse(res);
							console.log(res);
							if (dataObj != null && dataObj.dataSource.list.length > 0) {
								var farmOption;
								for (var i = 0; i < dataObj.dataSource.list.length; i++) {
									farmOption = farmOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[
										i].name + '</option>';
								}
								$("#farmId").append(farmOption);
								form.render('select'); //一定要加form.render();
							}
						}
					});
				}

				BindVarietyDropList();
				//获取品种下拉列表
				function BindVarietyDropList() {
					$.ajax({
						url: commonIP + 'api/system/option/getOptionListSelect?authToken=' + authToken + '&type=pigVarietyId',
						success: function(res) {
							var dataObj = JSON.parse(res);
							if (dataObj != null && dataObj.dataSource.list.length > 0) {
								var groupOption;
								for (var i = 0; i < dataObj.dataSource.list.length; i++) {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource
										.list[i].name + '</option>';
								}
								$("#pig_variety_id").append(groupOption);
								form.render('select'); //一定要加form.render();
								BindStrainDropList();
							}
						}
					});
				}

				//获取品系下拉列表
				function BindStrainDropList() {
					$.ajax({
						url: commonIP + 'api/system/option/getOptionListSelect?authToken=' + authToken + '&type=strain',
						success: function(res) {
							var dataObj = JSON.parse(res);
							if (dataObj != null && dataObj.dataSource.list.length > 0) {
								var groupOption;
								for (var i = 0; i < dataObj.dataSource.list.length; i++) {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource
										.list[i].name + '</option>';
								}
								$("#strain").append(groupOption);
								form.render('select'); //一定要加form.render();
								BindUpdateList();
							}
						}
					});
				}


				//监听提交
				if (userId == null) //添加
				{
					form.on('submit(submit)', function(res) {
						var farmId = $("#farmId").val();
						if (farmId == null) {
							var warnMessage = "请选择添加栋舍的猪场";
							alert(warnMessage);
							return false;
						}
						var score = $("#score").val();
						if (score == 0 ) {
							var warnMessage = "请录入大于0的正整数";
							alert(warnMessage);
							return false;
						}
						
						
						$.ajax({
							type: 'POST',
							url: commonIP + "api/pig/matingstandard/create?authToken=" + authToken,
							contentType: 'application/json',
							data: JSON.stringify(res.field),
							async: false,
							success: function(data) {
								var dataObj = JSON.parse(data);
								if (dataObj) {
									if (dataObj.errcode == "200") {
										alert(i18next.t("addSucc"));
										layer.close(layer.index);
										window.parent.location.reload();
									} else {
										alert(dataObj.errmsg);
									}
								}
							}
						});

						return false;
					});
				} else //编辑
				{
					BindUpdateList();
					form.on('submit(submit)', function(res) {
						var farmId = $("#farmId").val();
						if (farmId == null) {
							var warnMessage = "请选择添加栋舍的猪场";
							alert(warnMessage);
							return false;
						}


						var score = $("#score").val();
						if (score == 0 ) {
							var warnMessage = "请录入大于0的正整数";
							alert(warnMessage);
							return false;
						}
						//layer.msg(JSON.stringify(res.field));
						$.ajax({
							type: 'POST',
							url: commonIP + "api/pig/matingstandard/update?authToken=" + authToken + "&userid=" + userId,
							contentType: 'application/json',
							data: JSON.stringify({
								"id": userId,
								"farmId": res.field.farmId,
								"groupId": res.field.groupId,
								"pigVarietyId": res.field.pigVarietyId,
								"strain": res.field.strain,
								"isInitialMatch": res.field.isInitialMatch,
								"score": res.field.score,
								"remark": res.field.remark
							}),
							async: false,
							success: function(data) {
								var dataObj = JSON.parse(data);
								console.log(dataObj)
								if (dataObj) {
									if (dataObj.errcode == "200") {
										alert(i18next.t("updateSucc"));
										layer.close(layer.index);
										window.parent.location.reload();
									} else {
										alert(dataObj.errmsg);
									}
								}
							}
						});
						return false;
					});
				}

				function BindUpdateList() {
					//alert(1);
					if (userId != null) //编辑
					{
						$("#groupId").attr("disabled", true);
						$("#farmId").attr("disabled", true);
						//alert(1);
						$.ajax({
							type: "GET",
							url: commonIP + 'api/pig/matingstandard/getMatingStandardList?authToken=' + authToken + '&page=0&limit=0&id=' + userId,
							contentType: 'application/json',
							success: function(data) {
								var datas = JSON.parse(data);
								console.log(datas);
								if (datas.errcode == 200) {
									//赋值
									$("#groupId").val(datas.dataSource.list[0].groupId);
									$("#farmId").val(datas.dataSource.list[0].farmId);
									$("#pig_variety_id").val(datas.dataSource.list[0].pigVarietyId);
									$("#strain").val(datas.dataSource.list[0].strain); //填充内容
									$("#isInitialMatch").val(datas.dataSource.list[0].isInitialMatch);
									form.render('select');

									
									$("#score").val(datas.dataSource.list[0].score);
									$("#remark").val(datas.dataSource.list[0].remark);
								} else {
									alert(data.errmsg);
									if (data.errcode == "10005") {
										window.top.location.href = '../../login.html';
									}
								}
							}
						});
					} else {
						//新增
					}
				}
			});

			$("#row_num").change(function() {
				var rowNum = $("#row_num").val();
				if (rowNum == 0) {
					//alert(1);
					var warnMessage = "请录入大于0的正整数";
					alert(warnMessage);
				}
			});

			$("#column_num").change(function() {
				var columnNum = $("#column_num").val();
				if (columnNum == 0) {
					//alert(1);
					var warnMessage = "请录入大于0的正整数";
					alert(warnMessage);
				}
			});

			function GetQueryString(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r != null) return unescape(r[2]);
				return null;
			}
		</script>
	</body>

</html>
