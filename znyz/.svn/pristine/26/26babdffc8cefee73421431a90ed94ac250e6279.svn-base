
var authToken = localStorage.getItem('authToken');
var user = localStorage.getItem('user');
var houseId = '';
var houseName = '';
var pigsArchivesId = '';
var dayChart= '';
var weekChart= '';
//本日饲喂记录(柱状图)
option = {
	title: {
		text: '本日饲喂(KG)',
		subtext: '',
		top: -4,
		textStyle: {
			fontSize: 12,
		}
	},
    color: ['#0ED5AE'],
    tooltip : {
        trigger: 'axis',
        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
        }
    },
    grid: {
        top: '15%',
		bottom: '15%'
    },
    legend: {
		top: -4,
		data: ['饲喂量']
	},
    xAxis : [
        {
            type : 'category',
            data : ['', '', '', ''],
            axisTick: {
                alignWithLabel: true
            }
        }
    ],
    yAxis : [
        {
            type : 'value'
        }
    ],
    series : [
        {
            name:'饲喂量',
            type:'bar',
            barWidth: '60%',
            data:[0, 0, 0, 0]
        }
    ]
};
//本周饲喂记录(柱状图)
option1 = {
	title: {
		text: '本周饲喂(KG)',
		subtext: '',
		top: -4,
		textStyle: {
			fontSize: 12,
		}
	},
//  color: ['#3398DB'],
	color: ['#0ED5AE'],
    tooltip : {
        trigger: 'axis',
        axisPointer : {            // 坐标轴指示器，坐标轴触发有效
            type : 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
        }
    },
    grid: {
        top: '15%',
		bottom: '15%'
    },
    legend: {
		top: -4,
		data: ['饲喂量']
	},
    xAxis : [
        {
            type : 'category',
            data : ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
            axisTick: {
                alignWithLabel: true
            }
        }
    ],
    yAxis : [
        {
            type : 'value'
        }
    ],
    series : [
        {
            name:'饲喂量',
            type:'bar',
            barWidth: '60%',
            data:[0, 0, 0, 0, 0, 0, 0]
        }
    ]
};
$(function() {
	InitData();
});
function InitData(){
	setInit();
	setInterval("setCurDate()", 1000);
    pigsArchivesId = getUrlParam("pigsArchivesId");
    $("#houseListFooter").addClass("active");
    getHouseById();//根据猪只档案ID查询所在栋舍信息，再显示饲喂曲线
}
function switchKind(kind){
	switch(kind){
		case 1:
			$("#dayList").empty();
			document.getElementById('days').style.display='block'
			document.getElementById('li-week').className='active'
			document.getElementById('weeks').style.display='none'
			document.getElementById('li-month').className=''
//			document.getElementById('historys').style.display='none'
//			document.getElementById('li-history').className=''
			getPigInfo();
			getFeedingDayData();
			break;
		case 2:
			$("#weekList").empty();
			document.getElementById('weeks').style.display='block'
			document.getElementById('li-month').className='active'
			document.getElementById('days').style.display='none'
			document.getElementById('li-week').className=''
//			document.getElementById('historys').style.display='none'
//			document.getElementById('li-history').className=''
			getPigInfo();
			getFeedingWeekData();
			break;
		case 3:
//			document.getElementById('historys').style.display='block'
//			document.getElementById('li-history').className='active'
			document.getElementById('days').style.display='none'
			document.getElementById('li-week').className=''
			document.getElementById('weeks').style.display='none'
			document.getElementById('li-month').className=''
			break;

	}
}
function getHouseById() {
	$.ajax({
		type: "GET",
		url: commonIP + 'api/pig/weight/getPigHouseById',
		data: 'authToken='+authToken+'&pigsArchivesId='+pigsArchivesId,
		contentType: 'application/json',
		dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
		success: function(data) {
			console.log(data)
			if (data) {
				if (data.errcode == 200) {
					houseId = data.dataSource.list[0].houseId;
					houseName = data.dataSource.list[0].houseName;
					switchKind(1);
				}else{
					alert(data.errmsg);
					if(data.errcode=="10005"){
						window.top.location.href = 'wxlogin.html';
					}
				}
			}
		}
	});
}
function getFeedingDayData() {
	dayChart = echarts.init(document.getElementById('dayChart'));
	dayChart.setOption(option);
	var result = '';
	var current_date = getDate();
	$.ajax({
		type: "GET",
		url: commonIP + 'api/pig/feeding/getFeedingDetailForDay',
		data: 'authToken='+authToken+'&house_id='+houseId+'&current_date='+current_date,
		contentType: 'application/json',
		dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
		success: function(data) {
			console.log(data)
			if (data) {
				if (data.errcode == 200) {
					result = result+'<div class="msg siweilist mt5"><ul><li>本日饲喂记录：</li>';
					var total = 0;
					var dataArray = new Array();
					var timeArray = new Array("0:0","0:0","0:0","0:0","0:0");
			        for (var key in data.dataSource.list){
			        	var feeding_time = data.dataSource.list[key].feeding_time;
			        	var timeTmp = feeding_time.substring(11,13);
			        	timeArray[key] = feeding_time.substring(11,16);
			        	if(timeTmp<12){
			        		feeding_time = '上午'+feeding_time.substring(11,16);
			        	}else{
			        		feeding_time = '下午'+feeding_time.substring(11,16);
			        	}
			        	result = result+'<li>'+feeding_time+'分 '+houseName+' 投放饲料 '+data.dataSource.list[key].feeding_total+' 公斤'+
			        			'<br />平均采食量 ：'+data.dataSource.list[key].feeding_avg.toFixed(2)+'公斤</li>';
		        		total = total+ data.dataSource.list[key].feeding_total;
		        		dataArray[key] = data.dataSource.list[key].feeding_total;
			        }
			        result = result+'</ul></div>';
			        if(result.length > 0){
				        $('#dayList').append(result);
			        }
			        $("#dayTotal").html(total);
			        
					// 填入图表数据
					dayChart.setOption({
						xAxis : [
					        {
				            	data : timeArray
					        }
					    ],
						series: [{
							// 根据名字对应到相应的系列
							name: '饲喂量',
							data: dataArray
						}]
					});
				}else{
					if(data.errcode=="10005"){
						alert(data.errmsg);
						window.top.location.href = 'wxlogin.html';
					}
				}
			}
		}
	});
}
function getFeedingWeekData() {
	weekChart = echarts.init(document.getElementById('weekChart'));
	weekChart.setOption(option1);
	var result = '';
	 // 获得本周时间
    var weekStartDate = getWeekStartDate();
    var weekEndDate = getWeekEndDate();
	$.ajax({
		type: "GET",
		url: commonIP + 'api/pig/feeding/getFeedingDetailForWeek',
		data: 'authToken='+authToken+'&house_id='+houseId+'&pigs_archives_id='+pigsArchivesId+'&start_date='+weekStartDate+'&end_date='+weekEndDate,
		contentType: 'application/json',
		dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
		success: function(data) {
			console.log(data)
			if (data) {
				if (data.errcode == 200) {
					result = result+'<div class="msg siweilist mt5"><ul><li>本周饲喂记录：</li>';
					var total = 0;
			        for (var key in data.dataSource.list){
			        	result = result+'<li>本周 '+houseName+' 投放饲料 '+data.dataSource.list[key].feeding_total+' 公斤'+
			        			'<br />本周增重 ：'+data.dataSource.list[key].week_increase.toFixed(2)+'公斤 肉料比 '+data.dataSource.list[key].meat_feed_ratio.toFixed(4)+'</li>';
			        	total = total+data.dataSource.list[key].feeding_total
			        }
			        result = result+'</ul></div>';
			        if(result.length > 0){
				        $('#weekList').append(result);
			        }
			        $("#weekTotal").html(total);
			        getFeedingWeekArray();
				} else{
					if(data.errcode=="10005"){
						window.top.location.href = 'wxlogin.html';
					}
				}
			}
		}
	});
}
function getFeedingWeekArray(){
	var result = '';
	 // 获得本周时间
    var weekStartDate = getWeekStartDate();
    var weekEndDate = getWeekEndDate();
    var current_date = getDate();
	$.ajax({
		type: "GET",
		url: commonIP + 'api/pig/feeding/getFeedingWeekList',
		data: 'authToken='+authToken+'&house_id='+houseId+'&current_date='+current_date,
		contentType: 'application/json',
		dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
		success: function(data) {
			console.log(data)
			if (data) {
				if (data.errcode == 200) {
					//饲喂集合
					var dataArry = data.dataSource.list[0].weekInfo;
					// 填入数据
					weekChart.setOption({
						series: [{
							// 根据名字对应到相应的系列
							name: '饲喂量',
							data: dataArry
						}]
					});
				} else{
					if(data.errcode=="10005"){
						window.top.location.href = 'wxlogin.html';
					}
				}
			}
		}
	});

}
/**
 * 获取当前时间
 */
function getDate(){
	var myDate = new Date();
	//获取当前年
	var year=myDate.getFullYear();
	//获取当前月
	var month=myDate.getMonth()+1;
	//获取当前日
	var date=myDate.getDate(); 
	var now=year+'-'+p(month)+"-"+p(date);
	return now;
}
function p(s) {
    return s < 10 ? '0' + s: s;
}
function switchKindTab(tab,divCon){
	for (var i = 0; i < tab.length; i++) {
		if (tab[i] == this) {
			tab[i].classList.add('active')
			divCon[i].style.display = 'block'
		} else{
			tab[i].classList.remove('active')
			divCon[i].style.display = 'none'
		}
	}
}
//取得猪只信息
function getPigInfo() {
	$.ajax({
		type: "GET",
		url: commonIP + 'api/pig/info/getListPage',
		contentType: 'application/json',
		data: 'authToken=' + authToken + '&pigs_archives_id=' + pigsArchivesId + '&pageNum=1&pageSize=1',
		dataType: 'json', // GET 请求方式需要添加dataType 设定返回数据的格式为json;
		success: function(data) {
			console.log(data)
			if (data) {
				if (data.errcode == 200) {
					$("#PigsNumber").html(data.dataSource.list[0].pigs_number);
					$("#PigInfos").html(data.dataSource.list[0].production_status_name + "/" + data.dataSource.list[0].pigVarietyName + "/" + data.dataSource.list[0].parity + "胎");
				}else{
					alert(data.errmsg);
					if(data.errcode=="10005"){
						window.top.location.href = 'wxlogin.html';
					}
				}
			}
		},
		error: function(err) {

		}
	})
}
function setCurDate() {
	var ndate = getCurDate();
	var divT = document.getElementById("logInfo");
	var divT2 = document.getElementById("logInfo1");
	divT.innerHTML = ndate;
	divT2.innerHTML = ndate;
}