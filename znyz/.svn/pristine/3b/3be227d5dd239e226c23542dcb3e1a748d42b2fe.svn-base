<html>

	<head>
		<title>Title</title>
		<script src="../../statics/libs/jquery-1.7.2.js"></script>
		<link rel="stylesheet" href="../../statics/css/font-awesome.min.css">
		<link rel="stylesheet" href="../../common/css/cyType.css">
		<link rel="stylesheet" href="../../common/css/extendedStyle.css">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
		<script src="../../statics/plugins/layui/layui.js"></script>
		<script src="../../common/js/whole/cyLayer.js"></script>
		<script src="../../common/js/whole/utils.js"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
				<script language="JavaScript" type="text/javascript">    
	function clearNoNum(obj){
		//修复第一个字符是小数点 的情况.
		if(obj.value !=''&& obj.value.substr(0,1) == '.'){
			obj.value="";
		}
		obj.value = obj.value.replace(/^0*(0\.|[1-9])/, '$1');//解决 粘贴不生效
		obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
		obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的     
		obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");    
		obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d).*$/,'$1$2.$3');//只能输入一个小数     
		if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
			if(obj.value.substr(0,1) == '0' && obj.value.length == 2){
				obj.value= obj.value.substr(1,obj.value.length);	0
			}
		}    
	}    
</script>  
	</head>

	<body>
		<div class="layui-field-box">
			<form class="layui-form">
				<div class="layui-form-item">
					<label class="layui-form-label" data-i18n="pigScore.feedType"></label>
					<div class="layui-input-inline">
						<input disabled style="border:1px solid #fff;" type="text" id="feedType" name="feedType" lay-verify="required|feedType" class="layui-input" data-i18n="[placeholder]pigScore.feedTypeText" autocomplete="off" maxlength="10">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label" data-i18n="pigScore.feedAmount"></label>
					<div class="layui-input-inline">
						<input  disabled style="border:1px solid #fff;"type="text" id="feedAmount" name="feedAmount" onkeyup="clearNoNum(this)" lay-verify="required|feedAmount" class="layui-input" data-i18n="[placeholder]pigScore.feedAmountText" autocomplete="off" maxlength="4">
					</div>
					<label class="layui-form-label" data-i18n="pigScore.times"></label>
					<div class="layui-input-inline">
						<input disabled style="border:1px solid #fff;" type="text" id="numberTimes" name="numberTimes" lay-verify="required|numberTimes" class="layui-input" data-i18n="[placeholder]pigScore.feedTimesText" autocomplete="off" maxlength="1" oninput="value=value.replace(/[^\d]/g,'')">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label " data-i18n="common.remarkTextTeet"></label>
					<div class="layui-input-block">
						<textarea type="text" id="remark" name="remark" class="layui-textarea" data-i18n="[placeholder]house.remarkPlaceholder" autocomplete="off" maxlength="100"></textarea>
					</div>
				</div>
				<div class="page-footer">
					<div class="btn-list">
						<div class="btnlist">
							<!-- <button class="layui-btn" lay-submit="" lay-filter="submit" data-i18n="[append]btnSave"><i class="fa fa-floppy-o">&nbsp;</i></button> -->
							<button class="layui-btn" onclick="$t.closeWindow();" data-i18n="[append]btnBack"><i class="fa fa-undo">&nbsp;</i></button>
						</div>
					</div>
				</div>
			</form>
		</div>

		<!-- 国际化        -->
		<script src="../../statics/plugins/i18n/i18next.min.js"></script>
		<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
		<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
		<script>
			var authToken = localStorage.getItem("authToken");
			//alert(authToken);
			var user = localStorage.getItem("user");

			i18n('../../locales', onLangReady) //国际化
			function onLangReady() {
				layui.use(['form', 'laydate'], function() {
					var form = layui.form;
					var $ = layui.$;
					var laydate = layui.laydate;
					if(!checkToken()) {
						alert(i18next.t("timeout"));
						window.top.location.href = '../../login.html';
					}

					var id = GetQueryString("id"); //userId为空表示新增，否则是修改
					$("#numberTimes").change(function() {
						var numberTimes = $("#numberTimes").val();
						if(numberTimes == 0) {
							//alert(1);
							var warnMessage = "请录入大于0的正整数";
							alert(warnMessage);
						}
					});

					getGroupList();
					//获取猪场下拉列表
					function getGroupList() {
						$.ajax({
							url: commonIP + 'api/system/farm/getListPage?authToken=' + authToken + '&page=0&limit=0',
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							async: false,
							success: function(res) {
								var dataObj = JSON.parse(res);
								// console.log(555)
								if(dataObj != null && dataObj.dataSource.list.length > 0) {
									var farmOption;
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
										farmOption = farmOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
									}
									$("#farmId").append(farmOption);
									form.render('select'); //一定要加form.render();
								}
							}
						});

						form.on('select(farmId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
							/**改变集团后先清空猪场下拉值*/
							document.getElementById("stageId").options.length = 0;
							$('#stageId').val("");
							form.render('select');
							selectStage();
						});

					}
					//	selectStage();
					function selectStage() {
						//获取生产阶段下拉列表
						// console.log(555)
						var farmId = $("#farmId").val();
						// alert(farmId)
						if(farmId == null) {
							farmId = '';
						}
						// console.log(555)
						$.ajax({

							url: commonIP + 'api/pig/productionstage/getListPage?authToken=' + authToken + '&farmId=' + farmId + '&page=0&limit=0',
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							async: false,
							success: function(res) {
								// console.log(555)

								var dataObj = JSON.parse(res);
								console.log(dataObj)
								if(dataObj != null && dataObj.dataSource.list.length > 0) {
									var groupOption;

									// console,log(dataObj.dataSource.list.dataSource.list)
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
										groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].stageName + '</option>';
									}
									$("#stageId").append(groupOption);
									form.render('select'); //一定要加form.render();
									BindPigTypeDropList();
								}
							}
						});

					}

					//获取猪只类别下拉列表
					function BindPigTypeDropList() {
						$.ajax({
							url: commonIP + 'api/system/option/getOptionListSelect?authToken=' + authToken + '&type=pigType',
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							async: false,
							success: function(res) {
								var dataObj = JSON.parse(res);
								if(dataObj != null && dataObj.dataSource.list.length > 0) {
									var groupOption;
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
										groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
									}
									// $("#pigType").append(groupOption);
									form.render('select'); //一定要加form.render();
								}
							}
						});
					}

					//监听提交
					if(id == null) { //添加
						$("#feedAmount").change(function() {
							var minBack = $("#feedAmount").val();
							if(minBack <= 0) {
								//alert(1);
								var warnMessage = "请录入大于0的数，小数点最大一位";
								alert(warnMessage);
								return false
							} else {
								if(/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,1})?$/.test(minBack)) {
									return true;
								} else {
									var warnMessage = "请录入大于0的数，小数点最大一位";
									alert(warnMessage);
								}

							}
						});
						form.on('submit(submit)', function(res) {
							var stageId = res.field.stageId;
							if(stageId == null || stageId == "") {
								var warnMessage = "请选择生产阶段";
								alert(warnMessage);
								return false;
							}
							var minBack = $("#feedAmount").val();
							if(minBack <= 0) {
								//alert(1);
								var warnMessage = "请录入大于0的数，小数点最大一位";
								alert(warnMessage);
								return false;
							} else {
								if(/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,1})?$/.test(minBack)) {

								} else {
									var warnMessage = "请录入大于0的数，小数点最大一位";
									alert(warnMessage);
									return false;
								}

							}

							//layer.msg(JSON.stringify(res.field));
							$.ajax({
								type: 'POST',
								url: commonIP + "api/pig/feedstandard/create?authToken=" + authToken,
								contentType: 'application/json',
								data: JSON.stringify(res.field),
								async: false,
								success: function(data) {
									var dataObj = JSON.parse(data);
									//					console.log(dataObj);
									//					console.log(dataObj.errcode);
									if(dataObj) {
										if(dataObj.errcode == "200") {

											alert(i18next.t("addSucc"));
											layer.close(layer.index);
											window.parent.location.reload();
										} else {
											alert(i18next.t("addFailed"));
										}
									}
								}
							});
						});
					} else { //编辑
						BindUpdateList();
						$("#feedAmount").change(function() {
							var minBack = $("#feedAmount").val();
							if(minBack <= 0) {
								var warnMessage = "请录入大于0的数，小数点最大一位";
								alert(warnMessage);
								return false
							} else {
								if(/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,1})?$/.test(minBack)) {
									return true;
								} else {
									var warnMessage = "请录入大于0的数，小数点最大一位";
									alert(warnMessage);
								}

							}
						});
						form.on('submit(submit)', function(res) {
							var stageId = res.field.stageId;
							if(stageId == null || stageId == "") {
								var warnMessage = "请选择生产阶段";
								alert(warnMessage);
								return false;
							}
							var minBack = $("#feedAmount").val();
							if(minBack <= 0) {
								var warnMessage = "请录入大于0的数，小数点最大一位";
								alert(warnMessage);
								return false;
							} else {
								if(/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,1})?$/.test(minBack)) {

								} else {
									var warnMessage = "请录入大于0的数，小数点最大一位";
									alert(warnMessage);
									return false;
								}

							}

							//console.log(1111)
							$.ajax({
								type: 'POST',
								url: commonIP + "api/pig/feedstandard/update?authToken=" + authToken,
								contentType: 'application/json',
								data: JSON.stringify({
									"id": id,
									"farmId": res.field.farmId,
									"stageId": res.field.stageId,
									"pigType": res.field.pigType,
									"feedType": res.field.feedType,
									"feedAmount": res.field.feedAmount,
									"numberTimes": res.field.numberTimes,
									"remark": res.field.remark,
									"stageName": res.field.stageName
								}),
								async: false,
								success: function(data) {
									// alert(data);
									console.log(res.field)
									var dataObj = JSON.parse(data);
									//					console.log(dataObj);
									//					console.log(dataObj.errcode);
									if(dataObj) {
										if(dataObj.errcode == "200") {
											alert(i18next.t("updateSucc"));
											layer.close(layer.index);
											window.parent.location.reload();
										} else {
											alert(i18next.t("updateFailed"));
										}
									}
								}
							});
						});
					}

					function BindUpdateList() {
						if(id != null) { //编辑
							$.ajax({
								type: "GET",
								url: commonIP + 'api/pig/feedstandard/getFeedStandardList?authToken=' + authToken + '&page=0&limit=0&id=' + id,
								parseData: function(res) { //res 即为原始返回的数据
									return {
										"code": res.code, //解析接口状态
										"msg": res.msg, //解析提示文本
										"count": res.count, //解析数据长度
										"data": res.dataSource.list //解析数据列表
									};
								},
								contentType: 'application/json',
								async: false,
								success: function(data) {
									var datas = JSON.parse(data);
									// console.log(datas);
									if(datas.errcode == 200) {
										//赋值
										// alert(datas.dataSource.list[0].stageName)
										$("#farmId").val(datas.dataSource.list[0].farmId);

										$("#stageId").val(datas.dataSource.list[0].stageId);
										$("#pigType").val(datas.dataSource.list[0].pigType);
										form.render('select');
										$("#stageName").val(datas.dataSource.list[0].stageName);
										$("#feedType").val(datas.dataSource.list[0].feedType);
										$("#feedAmount").val(datas.dataSource.list[0].feedAmount);
										$("#numberTimes").val(datas.dataSource.list[0].numberTimes);
										$("#remark").val(datas.dataSource.list[0].remark);
										var farList = datas.dataSource.list[0].stageId;
										// alert(farList)
										//带farmId再查区域
										$.ajax({
											type: 'GET',
											url: commonIP + 'api/pig/productionstage/getListPage?authToken=' + authToken + '&farmId=' + datas.dataSource.list[0].farmId + '&page=0&limit=0',

											contentType: 'application/json',

											success: function(data) {
												// alert(1);
												console.log(data)
												var dataList = JSON.parse(data);
												console.log(dataList)
												if(dataList.errcode == 200) {
													if(dataList != null && dataList.dataSource.list.length > 0) {
														var groupOption;
														for(var i = 0; i < dataList.dataSource.list.length; i++) {
															//	console.log(dataList.dataSource.list[i].id)
															groupOption = groupOption + '<option value="' + dataList.dataSource.list[i].id + '">' + dataList.dataSource.list[i].stageName + '</option>';

															// $("#stageId").val(farList);
														}
														$("#stageId").append(groupOption);
														$("#stageId").val(farList);
														form.render('select');
													}

												}

											}
										})
									} else {
										//alert(data.errmsg);
										if(data.errcode == "10005") {
											window.top.location.href = '../../login.html';
										}
									}
								}
							});
						} else {
							//新增
						}
					}
				});
			}
		</script>
	</body>

</html>