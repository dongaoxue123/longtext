
<html  style="height: 100%;color:#333333;background: #fff;">
<head>
	<meta charset="UTF-8" />
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" /><!--强制让文档的宽度与设备的宽度保持1:1，并且文档最大的宽度比例是1.0，且不允许用户点击屏幕放大浏览-->
	<meta content="yes" name="apple-mobile-web-app-capable" /><!--iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览-->
	<meta content="black" name="apple-mobile-web-app-status-bar-style" /><!--iphone的私有标签，它指定的iphone中safari顶端的状态条的样式-->
	<meta name="format-detection" content="telephone=no" /><!--告诉设备忽略将页面中的数字识别为电话号码-->
	<meta content="false" name="twcClient" id="twcClient" /><!--判断页面是否在本地Native（本地APP）环境中-->	
	<title>测膘系统</title>
	<script src="script/flexible.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/flexible_css.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/dist/dropload.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/masklayer.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" type="text/css" href="iconfont/iconfont.css"/>
	<link rel="stylesheet" type="text/css" href="style/common.css"/>
	<link rel="stylesheet" type="text/css" href="style/style.css"/>
	<link rel="stylesheet" type="text/css" href="script/dist/dropload.css">
	<!--<link rel="stylesheet" href="style/drawer.min.css">-->
	<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<style  type="text/css"> 
		.ovfHiden{overflow: hidden;}
		.choose_Btn{background: #25B4F5;color:#fff}
	</style>
<script>
var ids = "";
$(document).ready(function(){
	//展示筛选窗口
	$("#showQuery").click(function(){
		$('html,body').addClass('ovfHiden'); 
		$("#query").css('display','block'); 
		//局部遮罩层
		
        $("#allDom").jqLoading({ type: 1 });
	})
	
	//按钮样式切换
	$('.matingStage').click(function(){
		var nodeId =$(this).attr("id");
		if($(this).is(".choose_Btn")){
			$(this).removeClass("choose_Btn");
		}else{
			if(nodeId.indexOf("stage") !=-1){
				$(this).parent().children().removeClass("choose_Btn");
			}
				
			$(this).addClass("choose_Btn");
		}
		  	//alert($(this).attr("id"))
	});
		//取消查询按钮
	$(".cancel").click(function(){
		$("#query").css('display','none'); 
		//关闭遮罩层
		$("#allDom").jqLoading("destroy");
		$('html,body').removeClass('ovfHiden'); 
	});
	//确定查询按钮
	$("#confirm").click(function(){
	parityNumStart = $.trim($("#parityNumStart").val());
    parityNumEnd =$.trim($("#parityNumEnd").val());//胎次结束条件查询 
	backfatScoreStart =$.trim($("#backfatScoreStart").val());//评分起始条件查询
	backfatScoreEnd =$.trim($("#backfatScoreEnd").val());//评分结束条件查询 
	$("#query").css('display','none'); 
	var str = '';//显示已选条件列表串
		 $(".choose_Btn").each(function(){
   			var nodeId = $(this).attr("id");
   			if(nodeId =='followStatus'){
   				followStatus ="1";//关注条件查询
   				str += '<span><span>已关注</span></span>';
   			}
   			if(nodeId.indexOf("stage")!="-1"){
   				var num = nodeId.substring("stage".length);
   				matingDateStart =$("#matingDateStart"+num).val();//配种起始条件查询
   				matingDateEnd =$("#matingDateEnd"+num).val();//配种结束条件查询
   				str += '<span><span>配种'+matingDateStart+'~'+matingDateEnd+'天</span></span>'
   			}
   			
 		 });
 	$("#queryList").html(str)
 	getFieldList();
 	//关闭遮罩层
		$("#allDom").jqLoading("destroy");
		$('html,body').removeClass('ovfHiden'); 
		if($("#queryList").html().length==0){
			$("#queryList").hide();
		}else{
		$("#queryList").show();
		}
	});
});
</script>
</head>
<body style="height:100%;">
	<header>
		<h1 id="h1_houseName"></h1>
	</header>
	<main id="allDom">
		<div class="main pd20">
			<!--<select name="data" id="houseId" onchange= "getFieldList()">
			</select>-->
			<div class="button btn_blue">
				<span class="iconfont icon-saoyisao" id='qrcode'></span><span id='qrcode2'>扫码测膘</span>
			</div>
		</div>
		
		<div class="choose_tit flex">
			<span id="fieldInfo"></span>
			<div class="relative" onclick="sort(event)" id="parity">
				<span>胎次</span>
				<div id="paritySort">
					<span class="iconfont icon-arrow-top"></span>
					<span class="iconfont icon-arrow-bottom"></span>
				</div>
			</div>
			<div class="relative" onclick="sort(event)" id="increaseWeight">
				<span>评分</span>
				<div id="increaseScoreSort">
					<span class="iconfont icon-arrow-top"></span>
					<span class="iconfont icon-arrow-bottom"></span>
				</div>
			</div>
			
			<span><a  class="border bd_blue" id="showQuery">筛选</a></span>
		</div>
		
		<div class="main choose_nav" id="queryList" style="display: none">
			<!--
			<span>
				<span>已关注</span><span class="iconfont icon-close1"></span>
			</span>
			<span>
				<span>配种0~35天</span><span class="iconfont icon-close1"></span>
			</span>
			-->
		</div>
		<div id="content">
		    <div id="lists"></div>
		</div>		
		<div class="choose_box" style="display: none;" id="query">
			<ul>
				<li>
					<h4>筛选</h4>
					<span id="followStatus"  class="matingStage">已关注
						
					</span>
				</li>
				<li>
					<h4>妊娠阶段</h4>
					<span id="stage1" class="matingStage" >配种0-35天
						<input type="hidden" name="matingDateStart1" value="0" id="matingDateStart1"/>
						<input type="hidden" name="matingDateEnd1" value="35" id="matingDateEnd1"/>
					</span>
					<span id="stage2" class="matingStage" >配种36-85天
						<input type="hidden" name="matingDateStart2" value="36" id="matingDateStart2"/>
						<input type="hidden" name="matingDateEnd2" value="85" id="matingDateEnd2"/>
					</span>
					<span id="stage3" class="matingStage" >配种86-112天
						<input type="hidden" name="matingDateStart3" value="86" id="matingDateStart3"/>
						<input type="hidden" name="matingDateEnd3" value="112" id="matingDateEnd3"/>
					</span>
				</li>
				<li>
					<h4>胎次</h4>
					<input type="text" name="parityNumStart" id="parityNumStart" value="" /><i>-</i>
					<input type="text" name="parityNumEnd" id="parityNumEnd" value="" /> 胎
				</li>
				<li>
					<h4>评分</h4>
					<input type="text" name="backfatScoreStart" id="backfatScoreStart" value="" /><i>-</i>
					<input type="text" name="backfatScoreEnd" id="backfatScoreEnd" value="" /> 
				</li>
			</ul>
			<div class="main box_btn">
				<a  class="cancel" style="margin-top: ;">取消</a>
				<a id="confirm">确定</a>
			</div>
			
		</div>
		<div class="footer">
			<ul>
				<li id="backfatFooter" onclick="location='fieldList.html'" class="active"><span class="iconfont icon-weibiaoti1"></span><h5>测膘</h5></li>
				<li id="countFooter" onclick="location='count.html'"><span class="iconfont icon-pig"></span><h5>统计</h5></li>
				<li id="setFooter" onclick="location='set.html'"><span class="iconfont icon-shezhi"></span><h5>配置</h5></li>
			</ul>
		</div>
	</main>
</body>
<script>
	var authToken = localStorage.getItem('authToken');
	var page = 0;
	var currDate;
	var farmId = '';
	var house_id = '';
	var paritySort = 0;//胎次排序  0不排序  1正序  2倒叙
	var increaseScoreSort = 0;//增重排序  0不排序  1正序  2倒叙
	var followStatus ="0" //关注条件查询
	var matingDateStart ='';//配种起始条件查询
	var matingDateEnd ='';//配种结束条件查询
	var parityNumStart ='';//胎次起始条件查询
	var parityNumEnd ='';//胎次结束条件查询 
	var backfatScoreStart ='';//评分起始条件查询
	var backfatScoreEnd ='';//评分结束条件查询 
	var uid ='';
	$(document).ready(function(){
		
		// 取得authToken
		if (authToken.length = 0){		
			alert("请重新登录");
			window.top.location.href = 'wxlogin.html';
			return false;
		}
		currDate = getDate();
		var user = localStorage.getItem('user');
		uid = JSON.parse(user).id;
		farmId = JSON.parse(user).farmId;
//		getHouseList();
		backfatScoreStart = getUrlParam('score');
		backfatScoreEnd = getUrlParam('score');
		house_id = getUrlParam('house_id');
		matingDateStart = getUrlParam('matingDateStart');
		matingDateEnd = getUrlParam('matingDateEnd');
		parityNumStart = getUrlParam('parityNumStart');
		parityNumEnd = getUrlParam('parityNumEnd');
		getFieldListInfo();//查询栏位信息
		initQrcode();//微信扫码
		   			
//		$('.drawer').drawer();
//		$('.border bd_blue').click(function(){
//		  	$('.drawer').drawer("open");
//		});
	});
//	function getHouseList(){
//		var user = localStorage.getItem('user');
//		var groupId = JSON.parse(user).groupId;
//		var farmId = JSON.parse(user).farmId;
//		$.ajax({
//			type: "GET",
//			url: commonIP + '/api/system/house/getHouseListPage',
//			contentType: 'application/json',
//			data: 'authToken='+authToken+'&groupId='+groupId+'&farmId='+farmId+'&pageNum=0&pageSize=0',
//			dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
//			success: function(data) {
//				console.log(data)
//				if (data) {
//					if (data.errcode == 200) {	
//						var html = '';
//				        for (var key in data.dataSource.list){
//				        	html = html + '<option value="'+ data.dataSource.list[key].id +'">'+ data.dataSource.list[key].name +'</option>';
//				        	if(key==0){
//				        		houseId = data.dataSource.list[key].id;
//				        	}
//				        }
//				        $("#houseId").html(html);
//				        getFieldListInfo();//查询栏位信息
//					} else {
//						alert(data.errmsg);
//						if(data.errcode =="10005"){
//							window.top.location.href = 'wxlogin.html';
//						}
//					}
//				}
//			}
//		});
//	}
	function getFieldList() {
		page = 0;
		getFieldListInfo();
	 followStatus ="0" //关注条件查询
	 matingDateStart ='';//配种起始条件查询
	 matingDateEnd ='';//配种结束条件查询
	 parityNumStart ='';//胎次起始条件查询
	 parityNumEnd ='';//胎次结束条件查询 
	 backfatScoreStart ='';//评分起始条件查询
	 backfatScoreEnd ='';//评分结束条件查询 
	 house_id = '';//栋舍
	}
	// 取得栏位信息
	function getFieldListInfo() {
		var queryData = '';
		if(followStatus!=null && followStatus !=''){
			queryData+="&followStatus="+followStatus;
		}
		if(matingDateStart!=null && matingDateStart !=''){
			queryData+="&matingDateStart="+matingDateStart;
		}
		if(matingDateEnd!=null && matingDateEnd !=''){
			queryData+="&matingDateEnd="+matingDateEnd;
		}
		if(parityNumStart!=null && parityNumStart !=''){
			queryData+="&parityNumStart="+parityNumStart;
		}
		if(parityNumEnd!=null && parityNumEnd !=''){
			queryData+="&parityNumEnd="+parityNumEnd;
		}
		if(backfatScoreStart!=null && backfatScoreStart !=''){
			queryData+="&backfatScoreStart="+backfatScoreStart;
		}
		if(backfatScoreEnd!=null && backfatScoreEnd !=''){
			queryData+="&backfatScoreEnd="+backfatScoreEnd;
		}
		$('#lists').empty();
	    // 每页展示10个
	    var size = 10;
        $.ajax({
        	type:"GET",
        	url:commonIP +'api/pig/weight/getFieldCount',
        	contentType:'application/json',
        	data:'authToken='+authToken+'&house_id='+house_id+"&uid="+uid+'&farm_id='+farmId+queryData,
        	dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
        	success:function(data){
        		if(data){
				    var res = '';
        			if(data.errcode == 200){
        				res = res+'<span style="margin-left: 15px;">共'+data.dataSource.list[0].field_count+'栏  '+data.dataSource.list[0].pig_count+'头母猪</span>';
        			}else{
        				if(data.errcode == 10005){
							alert(data.errmsg);
							window.top.location.href = 'wxlogin.html';
						}
        			}
        			if(res.length >0){
            			$('#fieldInfo').html(res);
        			}
        		}
        	}
        });
	    // dropload
	    $(".dropload-down").remove();
	    $('#content').dropload({
	        scrollArea : window,
	        loadUpFn:function(me){
	        	location.reload(); 
	        },
	        loadDownFn : function(me){
		        page++;
		        // 拼接HTML
		        var result = '';
		        var user = localStorage.getItem('user');
		        var uid = JSON.parse(user).id
		        $.ajax({
					type: "GET",
					url: commonIP + 'api/pig/weight/getFieldPigInfoList',
					contentType: 'application/json',
					data: 'authToken='+authToken+'&reqType=backfat&farm_id='+farmId+'&pageNum='+page+'&pageSize='+size+'&uid='+uid+'&paritySort='+paritySort+'&increaseScoreSort='+increaseScoreSort+queryData,
					dataType:'json',// GET 请求方式需要添加dataType 设定返回数据的格式为json;
		            success: function(data){
		            	console.log(data);
						if (data && data.errcode == 200) {
							$(".dropload-load").show();
					        for (var key in data.dataSource.list){
								var pigWeight = 0;
								var increaseWeight = 0.00;//周增重
								var score =0;
								if(data.dataSource.list[key].weight_data!=null 
									&& data.dataSource.list[key].weight_data!=''){
									pigWeight = data.dataSource.list[key].weight_data;
								}
								if(data.dataSource.list[key].increaseWeight!=null 
									&& data.dataSource.list[key].increaseWeight!=''){
									increaseWeight = data.dataSource.list[key].increaseWeight;
								}
								if(data.dataSource.list[key].score!=null 
									&& data.dataSource.list[key].score!=''){
									score = data.dataSource.list[key].score;
								}
								result = result+'<div class="weight_list flex" onclick="weightInfo(event)" style="position:relative;">'+
										'<input type="text" id="fieldId" style="display:none" value="'+data.dataSource.list[key].field_id+'">'+
										'<ul class="basic_msg mr20">'+
										'<h1><h2 class="pigs_number" style="color:limegreen;">'+data.dataSource.list[key].pigs_number+'</h2></h1></ul>';
								if(data.dataSource.list[key].pigs_archives_id!=null
					        		&& data.dataSource.list[key].pigs_archives_id!=''){
					        			var pigsArchivesId = data.dataSource.list[key].pigs_archives_id;
										result = result + '<input type="text" id="pigs_archives_id" style="display:none" value="'+data.dataSource.list[key].pigs_archives_id+'">'+
												'<ul class="basic_msg"><li><h3 class="fieldCode">'+data.dataSource.list[key].house_name+' '+data.dataSource.list[key].code+'栏</h3></li>'+
												'<li class="tmp" style="font-size: 18px">'+data.dataSource.list[key].pigVarietyName+'/'+
													data.dataSource.list[key].production_status_name+'/'+
													data.dataSource.list[key].parity+'胎/';
										var weightCreateDate = data.dataSource.list[key].weightCreateDate;
										if(currDate == weightCreateDate){
											result = result +'<a class="weightTmp" style="color:#EE7700;">BCS '+score+'</a>';
										}else{
											result = result +'<a class="weightTmp" style="color:0000BB;">BCS '+score+'</a>';
										}
					        			if(data.dataSource.list[key].attention_id != null 
					        				&& data.dataSource.list[key].attention_id != ""){
											result = result +'</li></ul>'+
												'<div class="btn_corner btn_follow"><a id="'+pigsArchivesId+'" class="rec" onclick="gz(event)">'+
												'<input type="text" id="gz_pigid" style="display:none" value="'+pigsArchivesId+
												'">已关注</a></div>';
										}else{
											result = result +'</li></ul>'+
												'<div class="btn_corner btn_follow btn_unfollow"><a id="'+pigsArchivesId+'" class="rec" onclick="gz(event)">'+
												'<input type="text" id="gz_pigid" style="display:none" value="'+pigsArchivesId+
												'">关注</a></div>';
					        			}
				        		}else{
				        			result = result+'<input type="text" id="pigs_archives_id" style="display:none" value="">'+
											'<ul class="basic_msg"><li><h3 class="pigsNumber">&nbsp</h3></li>'+
											'<li class="tmp">无猪只信息</li></ul>';
				        		}
				        		result = result+'</div>';
					        }
					        $('#lists').append(result);
					        me.resetload();
					        
						} else {
							if(data.errcode == 10015){
								alert(data.errmsg);
								window.top.location.href = 'wxlogin.html';
							}
							me.lock();
                        	// 无数据
                    	    me.noData();
                            me.resetload();
						}
		            },
		            error: function(xhr, type){
		                // 即使加载出错，也得重置
		                me.resetload();
		            }
		        });
	        }
	    });	
	}	
	function sort(e){
//		var target = e.currentTarget;
        var targetId = e.currentTarget.id;
		if (targetId == 'parity'){
			$("#paritySort").empty();
			if(paritySort==0){//胎次排序  0不排序  1正序  2倒叙
				paritySort = 1;
				$("#paritySort").append('<span class="iconfont icon-arrow-top blue"></span><span class="iconfont icon-arrow-bottom"></span>')
			}else if(paritySort==1){
				paritySort = 2;
				$("#paritySort").append('<span class="iconfont icon-arrow-top"></span><span class="iconfont icon-arrow-bottom blue"></span>')
			}else{
				paritySort = 0;
				$("#paritySort").append('<span class="iconfont icon-arrow-top"></span><span class="iconfont icon-arrow-bottom"></span>')
			}
		}else if(targetId == 'increaseWeight'){
			$("#increaseScoreSort").empty();
			if(increaseScoreSort==0){//增重排序  0不排序  1正序  2倒叙
				increaseScoreSort = 1;
				$("#increaseScoreSort").append('<span class="iconfont icon-arrow-top blue"></span><span class="iconfont icon-arrow-bottom"></span>')
			}else if(increaseScoreSort==1){
				increaseScoreSort=2;
				$("#increaseScoreSort").append('<span class="iconfont icon-arrow-top"></span><span class="iconfont icon-arrow-bottom blue"></span>')
			}else{
				increaseScoreSort=0;
				$("#increaseScoreSort").append('<span class="iconfont icon-arrow-top"></span><span class="iconfont icon-arrow-bottom"></span>')
			}
		}
		getFieldList();//切换排序后重新查询
	}
	function weightInfo(e) {
		var pigsArchivesId = '';
		var targetClass = $(e.target).attr("class");
		var houseName = $("#houseId").find("option:selected").text(); 
		if (targetClass == 'weight_list flex'){
			pigsArchivesId = $(e.target).find("#pigs_archives_id").val();
		}else if(targetClass == 'fieldCode' || targetClass == 'pigsNumber' || targetClass == 'weightTmp'
					|| targetClass == 'border bd_red' || targetClass == 'border bd_green'){
			pigsArchivesId = $(e.target).parent().parent().parent().find("#pigs_archives_id").val();
		}else if(targetClass == 'tmp'){
			pigsArchivesId = $(e.target).parent().parent().find("#pigs_archives_id").val();
		}
		if(pigsArchivesId!=null && pigsArchivesId!=''){
			// 跳转页面并传输参数
			window.location.href = 'Backfat.html?pigsArchivesId='+pigsArchivesId+'&houseName='+houseName;					
		}
	}
	
	/*gz 关注*/
	function gz(e) {
		var pigsArchivesId = $(e.target).find("#gz_pigid").val();
		var authToken = localStorage.getItem('authToken');
		var user = localStorage.getItem('user');
		var groupId = JSON.parse(user).groupId;
		var farmId = JSON.parse(user).farmId;
		$.ajax({
			type: "POST",
			url: commonIP + "api/pig/field/attention?authToken="+authToken,
			data: JSON.stringify({
				"pigs_archives_id":pigsArchivesId,
				"group_id":groupId,
				"farm_id":farmId
			}) ,
			contentType: 'application/json',
			success: function(data) {
				var data = JSON.parse(data);
				console.log(data)
				if (data.errcode == 200) {				
					alert(data.errmsg);
//					window.location.reload();
					getFieldList();
				} else {
					alert(data.errmsg);
				}
			}
		});
	}
	
	function initQrcode() { // 根据实际填写接口的配置地点     // 这里的接口地址是基于node-weixin配置的。    
		// 当前的网页请求地址
		var weixinUrl = location.href.split('#')[0];
		$.ajax({
			type: "POST",
			url: commonIP + "api/system/wxserver/getjsConfig?authToken="+authToken,
			data: JSON.stringify({
				"url":weixinUrl
			}) ,
			contentType: 'application/json',
			success: function(data) {
				console.log(data)
				var data = JSON.parse(data);
				if (data.errcode == 200) {
					wx.config({
//							    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
					    appId: data.dataSource.list[0].appId, // 必填，公众号的唯一标识
					    timestamp: data.dataSource.list[0].timestamp, // 必填，生成签名的时间戳
					    nonceStr: data.dataSource.list[0].nonceStr, // 必填，生成签名的随机串
					    signature: data.dataSource.list[0].signature,// 必填，签名，见附录1
					    jsApiList: ['checkJsApi','scanQRCode'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
					});
				}
			}
		});
		wx.ready(function() { 
			$('#qrcode').click(function () {
				wx.scanQRCode({       // 默认为0，扫描效果由微信处理，1则直接返回扫描结果，       
					needResult: 1,        // 可以指定扫二维码还是一维码，默认二者都有       
					scanType: ["qrCode", "barCode"],        
					success: function (res) {         // 当needResult 为 1 时，扫码返回的结果        
						var pigsArchivesId = res.resultStr;  
						// 跳转页面并传输参数
						window.location.href = 'Backfat.html?pigsArchivesId='+pigsArchivesId;
					}     
				}); 
			}); 
			$('#qrcode2').click(function () {
				wx.scanQRCode({       // 默认为0，扫描效果由微信处理，1则直接返回扫描结果，       
					needResult: 1,        // 可以指定扫二维码还是一维码，默认二者都有       
					scanType: ["qrCode", "barCode"],        
					success: function (res) {         // 当needResult 为 1 时，扫码返回的结果        
						var pigsArchivesId = res.resultStr;  
						// 跳转页面并传输参数
						window.location.href = 'Backfat.html?pigsArchivesId='+pigsArchivesId;
					}     
				}); 
			}); 
		});       
		
	}
	
	/**
	 * 获取当前时间
	 */
	function getDate() {
		var myDate = new Date();
		//获取当前年
		var year = myDate.getFullYear();
		//获取当前月
		var month = myDate.getMonth() + 1;
		//获取当前日
		var date = myDate.getDate();
		var now = year + '-' + p(month) + "-" + p(date);
		return now;
	}
	function p(s) {
		return s < 10 ? '0' + s : s;
	}
	
</script>
</html>