<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>猪只行为</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>

	<body>
		<div class="layui-form-item" id="button" style="margin-top: 10px;">
			<div class="layui-form-item" style="padding-right: 20px">
				<label class="layui-form-label">栋舍列表:</label>
				<div class="layui-input-inline">
					<select id="houseId" name="houseId" style="height: 38px;border-color: #F0F0F0;">
						<option value="">请选择栋舍</option>
					</select>
				</div>
				<!--<button class="layui-btn" id="search">查询</button>-->
			</div>
			<div class="layui-form-item" style="padding-right: 20px">
				<label id='total' class='layui-form-label' style="width:170px;"></label>
				<label id='undone' class='layui-form-label' style="width:70px;"></label>
			</div>
		</div>
		<table class="layui-hide" id="hogBatch" lay-filter="hogBatch"></table>
		<!--<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
			<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="done">处理</a>
		</script>-->
		
						<script type="text/html" id="barDemo">
			
			<a class="layui-btn layui-btn-xs" lay-event="edit" data-i18n="btnEdit"></a>
			 {{#  if(d.handleState == 1){ }}
				<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>

			
			  {{#  } else { }}
		
			 <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="done">处理</a>
			  {{#  } }}
			
			<a class="layui-btn layui-btn-primary layui-btn-xs " lay-event="detail" data-i18n="user.changePassword"></a>

		</script>
		<script>
			var farmId;
			var groupId;
			var authToken = localStorage.getItem("authToken");
			var user = localStorage.getItem("user");

			if(!checkToken()) {
				alert("登录超时，请重新登录！");
				window.top.location.href = '../../login.html';
			}
			farmId = JSON.parse(user).farmId;
			groupId = JSON.parse(user).groupId;

			layui.use(['form', 'table', 'laydate'], function() {
					var table = layui.table;
					var form = layui.form;
					var laydate = layui.laydate;
					var $ = layui.$;
					getFieldList()

					//获取栋舍下拉列表
					$.ajax({
						url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&type=00059&page=0&limit=0&farmId=' + farmId,
						success: function(res) {
							var dataObj = JSON.parse(res);
							if(dataObj != null) {
								var datas = dataObj.dataSource.list
								var groupOption;
								for(var i = 0; i < datas.length; i++) {
									groupOption = groupOption + '<option value="' + datas[i].id + '">' + datas[i].name + '</option>';
								}
								$("#houseId").append(groupOption);
								form.render('select'); //一定要加form.render();
							}
						}
					});

					$.ajax({
						url: commonIP + 'api/pig/pigbehavior/getTotalList?authToken='+authToken+'&farmId=' + farmId,
						success: function(res) {
							var dataObj = JSON.parse(res);
							if(dataObj != null) {
								var datas = dataObj.dataSource.list;
								document.getElementById('total').innerHTML = '共'+ datas[0].total + '条异常报警信息';
								document.getElementById('undone').innerHTML = datas[0].totalUndone + '条未处理'; 
							} 
						}
					});
					
					//监听工具条-详情
					table.on('tool(hogBatch)', function(obj) {
						var data = obj.data;
						if(obj.event == 'detail') {
							var index = layer.open({
								type: 2,
								content: "alarmDetail.html?type=1&id=" + data.id + '&fieldId=' + data.fieldId + '&clbj=' + data.handleState,
								area: ['630px', '800px'],
								maxmin: true
							});
						}else if(obj.event === 'done'){
							var index = layer.open({
								type: 2,
								content: "alarmPigDone.html?type=1&id=" + data.id + '&fieldId=' + data.fieldId + '&clbj=' + data.handleState,
								area: ['630px', '800px'],
								maxmin: true
							});
						}
					});
					
			function changeHouse() {
				getFieldList()
			}

			function getFieldList() {
				getFieldListInfo();

			}
			// 取得栏位信息
			function getFieldListInfo() {
				getList()
			}
			
			function getList() {
					//方法级渲染
					var houseId = $("#houseId").val();
					table.render({
						elem: '#hogBatch',
						url:  commonIP + "api/pig/pigbehavior/getListPage?authToken="+authToken+"&farmId=" + farmId + "&houseId=" + houseId  //数据请求路径
						,parseData: function(res){ //res 即为原始返回的数据
						    return {
						    	"code": res.code, //解析接口状态
				      			"msg": res.msg, //解析提示文本
				      			"count": res.count, //解析数据长度
						    	"data": res.errcode === '200' ? res.dataSource.list : [] //解析数据列表
						    };
			  		   },
						cellMinWidth: 80,
						cols: [
							[{
									type: 'numbers',
									width: '2%'
								}, {
									field: 'houseName',
									title: '栋舍名称',
									width: '8%'
								},{
									field: 'fieldName',
									title: '栏位名称',
									width: '8%'
								},{
									field: 'breeder',
									title: '饲养员',
									width: '10%'
								}, {
									field: 'alarmInfo',
									title: '报警信息',
									width: '8%'
								}, {
									field: 'alarmTime',
									title: '报警时间',
									width: '12%'
								}, {
									field: 'handleState',
									title: '处理状态',
									templet: function(row){
										return row.handleState=='0' ? '未处理' : '已处理'
									},
									width: '8%'
								}, {
									field: 'handler',
									title: '处理人员',
									width: '8%'
								}, {
									field: 'handleTime',
									title: '处理时间',
									width: '12%',
								}, {
									field: 'suggestion',
									title: '处理意见',
									width: '10%'
								},  {
									fixed: 'right',
									title: '处理',
									width: '10%',
									align: 'center',
									toolbar: '#barDemo'
								} //一个工具栏  具体请查看layui官网
							]
						],
						page: true //开启分页
							,
						limit: 10 //默认十条数据一页
							,
						limits: [10, 20, 30, 50] //数据分页条
							,
						id: 'testReload',
						done: function(res, curr, count){
							currPage = curr;
							var that = this.elem.next()
							
							$.each(res.data, function (index, obj) {
					           if(obj.handleState == '0'){
					                that.find(".layui-table-box tbody tr[data-index='" + index + "']").css("background-color", "#D3D3D3");
					                that.find(".layui-table-box tbody tr[data-index='" + index + "'] td[data-field='handleState']").css("color", "red");
					           }else{
					           		that.find(".layui-table-box tbody tr[data-index='" + index + "']  .layui-btn-danger").css("display", "none");
					           }
							})
						}
					});
				}
				
			$('#houseId').on('change', function() {
					changeHouse()
				});
			
		})
		</script>
	</body>

</html>