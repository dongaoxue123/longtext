<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>批次管理</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>

	<body>
		<div class="layui-form-item" id="button" style="margin-top: 10px;">
			<div class="layui-form-item" style="padding-right: 20px">
				<!--
	作者：717854567@qq.com
	时间：2019-07-05
	描述：
-->
				<div class="layui-form" style="padding-right: 50px">
					<label class="layui-form-label">栋舍名称</label>

					<select id="houseId" name="houseId" lay-search lay-verify="" lay-filter="houseId" style="height: 100px;padding-right: 20px">
						<option value="">请选择</option>
					</select>
				</div>
				<!--<div class="layui-form">
					<label class="layui-form-label">批次编码</label>

					<select id="batchId" name="batchId" lay-verify="required|batchId" lay-search lay-filter="batchId" style="height: 50px;border-color: #F0F0F0;">
						<option value="">请选择批次</option>
					</select>
				</div>-->

				<!--<label class="layui-form-label">批次出生日期</label>
				<div class="layui-input-inline">
					<input type="text" id="bronDate" name="bronDate" class="layui-input" disabled>
				</div>
				<label class="layui-form-label">批次基本信息</label>
				<div class="layui-input-inline">
					<input type="text" id="birthDate" name="birthDate" class="layui-input" disabled>
				</div>-->
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label">开始时间</label>
					<div class="layui-input-inline">
						<input type="text" id="startTime" name="startTime" class="layui-input">
					</div>
					<!--<label class="layui-form-label">结束时间</label>
					<div class="layui-input-inline">
						<input type="text" id="endTime" name="endTime" class="layui-input">
					</div>-->
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<button class="layui-btn" id="reset">重置</button>
					<button class="layui-btn" lay-submit="" lay-filter="submit"><i class="fa fa-floppy-o">&nbsp;</i>保存</button>
				</div>
			</div>
			<table class="layui-hide" id="hogBatch" lay-filter="hogBatch"></table>
			<script type="text/html" id="barDemo">
				<!--  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">分布</a>-->
				<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
			</script>
			<script>
				var farmId;
				var groupId;
				var authToken = localStorage.getItem("authToken");
				//alert(authToken);
				var user = localStorage.getItem("user");

				if(!checkToken()) {
					alert("登录超时，请重新登录！");
					window.top.location.href = '../../login.html';
				}
				farmId = JSON.parse(user).farmId;
				groupId = JSON.parse(user).groupId;
				var pigSimulationUser = "000000000000000081c0e8c240064710";
				layui.use(['form', 'table', 'laydate'], function() {
					var table = layui.table;
					var form = layui.form;
					var laydate = layui.laydate;
					var $ = layui.$;
					//方法级渲染
					table.render({});

					//监听工具条
					table.on('tool(hogBatch)', function(obj) {
						var data = obj.data;
						if(obj.event === 'detail') {
							var index = layer.open({
								type: 2,
								content: "printPigInfo.html?id=" + data.batchId,
								area: ['800px', '650px'],
								maxmin: true
							});
						} else if(obj.event === 'del') {
							layer.confirm('确定删除此行数据吗', function(index) {
								$.ajax({
									url: commonIP + "api/pig/info/delete?authToken=" + authToken,
									type: 'POST',
									contentType: 'application/json',
									data: JSON.stringify({
										"batchId": data.batchId
									}),
									success: function(text) {
										var dataObj = JSON.parse(text);
										if(dataObj.code == 0) {
											layer.msg(dataObj.msg, {
												icon: 6
											});
											obj.del();
											layer.close(index);
										} else {
											layer.msg(dataObj.msg, {
												icon: 5
											});
										}
									}
								});
							});
						} else if(obj.event === 'edit') {
							var index = layer.open({
								type: 2,
								content: "addHogBatch.html?batchId=" + data.batchId,
								area: ['800px', '600px'],
								maxmin: true
							});
						}
					});

					//绑定栋舍
					$.ajax({
						url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + "&farmId=" + farmId + "&type=00059",
						async: false,
						success: function(res) {
							var dataObj = JSON.parse(res);
							if(dataObj != null && dataObj.dataSource.list.length > 0) {
								var groupOption;
								for(var i = 0; i < dataObj.dataSource.list.length; i++) {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
								}
								$("#houseId").append(groupOption);
								form.render('select'); //一定要加form.render();

							}
						}
					});
					//绑定批次
					$.ajax({
						url: commonIP + 'api/pig/hogbatch/getHogBatchList?batchStatus=1&authToken=' + authToken + "&farmId=" + farmId,
						async: false,
						success: function(res) {
							var dataObj = JSON.parse(res);
							if(dataObj != null && dataObj.dataSource.list.length > 0) {
								var groupOption;
								for(var i = 0; i < dataObj.dataSource.list.length; i++) {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].batchId + '">' + dataObj.dataSource.list[i].batchCode + '</option>';
								}
								$("#batchId").append(groupOption);
								form.render('select'); //一定要加form.render();
								BindBatchIdMessage();
							}
						}
					});

					form.on('select(batchId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
						/**改变集团后先清空猪场下拉值*/
						//document.getElementById("batchId").options.length = 0;
						BindBatchIdMessage();
					});

					//绑定批号信息
					function BindBatchIdMessage() {
						var batchId = $('#batchId').val();
					//	alert(batchId);
					//	console.log(batchId)
						$('#bronDate').val("");
						$('#birthDate').val("");

						if(batchId !== null || batchId !== undefined || batchId !== '') {
						//	alert(1)
						} else {
						//	alert(3)
						}

						if(batchId !== null || batchId !== undefined || batchId !== '') {
						//	alert(2)

							$.ajax({
								url: commonIP + 'api/pig/hogbatch/getHogBatchPage?authToken=' + authToken + "&batchId=" + batchId,
								async: false,
								success: function(res) {
									//console.log(res);
									var dataObj = JSON.parse(res);
									console.log(dataObj);
									if(dataObj != null && dataObj.dataSource.list.length > 0) {

										var message = "品系:" + dataObj.dataSource.list[0].strainName + ",品种:" + dataObj.dataSource.list[0].pigVarietyName;

										$("#bronDate").val(dataObj.dataSource.list[0].bornDate);
										$("#birthDate").val(message);

										form.render('select'); //一定要加form.render();
									}
								}

							});
						} else {
							alert(4)
						}
					}

					form.on('submit(submit)', function(res) {

						//alert(farmId);
						//alert($("#startTime").val());
						///alert($("#endTime").val());
					//	alert($("#houseId").val());
					//	alert($("#batchId").val());
						//						alert(pigSimulationUser);
						//layer.msg(JSON.stringify(res.field));
						$.ajax({
							type: 'POST',
							url: commonIP + "api/znyz/hogbatchsimulation/createSimulationData?authToken=" + authToken + "&startTime=" + $("#startTime").val() +
								"&endTime=" + $("#endTime").val() + "&farmId=" + farmId + "&houseId=" + $("#houseId").val() + "&batchId=" + $("#batchId").val(),
							contentType: 'application/json',
							data: JSON.stringify(res.field),
							async: false,
							success: function(data) {
								var dataObj = JSON.parse(data);
								if(dataObj) {
									if(dataObj.errcode == "200") {
										alert("添加成功！");
										//layer.close(layer.index);
										//	window.parent.location.reload();
									} else {
										alert(dataObj.errmsg);
									}
								}
							}
						});
						return false;
					});
					//创建时间 日期控件
					laydate.render({
						elem: '#startTime' //指定元素
							,
						theme: 'molv',
						calendar: true //重要节日
					});
					//创建时间 日期控件
					laydate.render({
						elem: '#endTime' //指定元素
							,
						theme: 'molv',
						calendar: true //重要节日
							,
						format: 'yyyy/M/d HH:mm:ss'
					});
					$('#search').on('click', function() {
						active['reload'].call(this);
					});

					$('#reset').on('click', function() {

						$('#houseId').val("");

						$('#batchId').val("");

						$('#bronDate').val("");
						$('#birthDate').val("");
						$('#batchStatus').val("");
						/*$("#farmId option:first").prop("selected", 'selected');  */
					});
				});
			</script>
	</body>

</html>