
<html>
<head>
    <title>Title</title>
    <script src="../../statics/libs/jquery-1.7.2.js"></script>
    <link rel="stylesheet" href="../../statics/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../common/css/cyType.css">
    <link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
    <script src="../../statics/plugins/layui/layui.js"></script>
    <script src="../../common/js/whole/cyLayer.js"></script>
    <script src="../../common/js/whole/utils.js"></script>
    <script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<div class="layui-field-box">
    <form class="layui-form">
        <div class="layui-form-item" style="padding-right: 20px">
            <label class="layui-form-label" data-i18n="user.password"></label>
            <div class="layui-input-block">
                <input type="password" id="password" name="password" lay-verify="required|password"  data-i18n="[placeholder]user.passwordPlaceholder" maxlength="20" class="layui-input">
            </div>
        </div>
        <div class="page-footer">
            <div class="btn-list">
                <div class="btnlist">
					<button class="layui-btn" lay-submit="" lay-filter="submit" data-i18n="[append]btnSave" style="background: rgb(2, 145, 277);"></button>
					<button class="layui-btn" lay-submit="" lay-filter="submit" data-i18n="[append]btnSave" style="background: #fff;"></button>
					<!-- <button class="layui-btn" lay-filter="cancle" data-i18n="[append]btnBack"><i class="fa fa-undo">&nbsp;</i></button>                 -->
				</div>
            <!-- <button  data-i18n="[append]btnBack" class="layui-layer-ico layui-layer-close layui-layer-close1" href="javascript:;"></button> -->
			</div>
        </div>
    </form>
</div>

<!-- 国际化        -->
	<script src="../../statics/plugins/i18n/i18next.min.js"></script>
	<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
	<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
<script>
	var authToken=localStorage.getItem("authToken");
	//alert(authToken);
	var user =localStorage.getItem("user");
    var groupId;
    var farmId;
    var name;
    var loginName;
    i18n('../../locales', onLangReady) //国际化
		function onLangReady() {
			
    
    layui.use(['form','laydate'], function(){
        var form = layui.form;
        var $ = layui.$;
        var laydate = layui.laydate;
		if(!checkToken()){
	  		alert(i18next.t("timeout"));
	 			window.top.location.href = '../../login.html';
		}

		var userId = GetQueryString("id");//userId为空表示新增，否则是修改

	    if(userId != null)//编辑
	    {
	    	$.ajax({
			type: "GET",
			url: commonIP + 'api/system/user/get?authToken='+authToken+'&page=0&limit=0&id='+userId,
			contentType: 'application/json',
			async: false,
			success: function(data) {
				var datas = JSON.parse(data);
				console.log(datas);
				if (datas.errcode == 200) {
					//赋值
					groupId = datas.dataSource.list[0].groupId;
					farmId = datas.dataSource.list[0].farmId;
					name = datas.dataSource.list[0].name;
					loginName = datas.dataSource.list[0].loginName;
				} else {
					//alert(data.errmsg);
					if(data.errcode=="10005"){
							window.top.location.href = '../../login.html';
					}
				}
			}
			});
	    }
	    else
	    {
	    	//新增
	    }
        form.on('submit(cancle)', function(res){
			var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
			parent.layer.close(index);  
            window.parent.location.reload(); 
        });
        
		form.on('submit(submit)', function(res){
        //layer.msg(JSON.stringify(res.field));
   		$.ajax({  
            type: 'POST',
			url: commonIP + "api/system/user/update?authToken="+authToken,
			contentType: 'application/json',
			data: JSON.stringify({
					"id":userId,
					"groupId":groupId,
					"farmId":farmId,
					"name":name,
					"loginName":loginName,
					"password":res.field.password
				}) ,
			async: false,
			success: function(data) {
				var dataObj = JSON.parse(data);
//					console.log(dataObj);
//					console.log(dataObj.errcode);
				if (dataObj) {
					if (dataObj.errcode == "200") {
				     alert(i18next.t("updateSucc"));
                     layer.close(layer.index);  
                     window.parent.location.reload();  
					} else {
					 alert(dataObj.errmsg);
					}
				}
			}
         });
         return false;
      });
    });
    }
	function GetQueryString(name)
	{
	     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	     var r = window.location.search.substr(1).match(reg);
	     if(r!=null)return  unescape(r[2]); return null;
	}
	function closeForm()
	{
	
		$t.closeWindow();
	     // layer.close(); 
	}
	 
</script>
</body>
</html>
