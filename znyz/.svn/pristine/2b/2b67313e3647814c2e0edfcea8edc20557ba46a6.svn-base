<html>

	<head>
		<title>Title</title>
		<script src="../../statics/libs/jquery-1.7.2.js"></script>
		<link rel="stylesheet" href="../../statics/css/font-awesome.min.css">
		<link rel="stylesheet" href="../../common/css/cyType.css">
		<link rel="stylesheet" href="../../common/css/extendedStyle.css">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
		<script src="../../statics/plugins/layui/layui.js"></script>
		<script src="../../common/js/whole/cyLayer.js"></script>
		<script src="../../common/js/whole/utils.js"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<div class="layui-field-box">
			<form class="layui-form">
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" style="width: 120px" data-i18n="common.pigNumber"></label>
					<div class="layui-input-inline">
						<select id="pigNumbers" name="pigNumbers" lay-verify="required" lay-filter="pigNumbers" style="height: 38px;border-color: #F0F0F0;" lay-search>
							<option value=""></option>
						</select>
					</div>
					<label class="layui-form-label layui-required" style="width: 120px" data-i18n="转出猪舍|转出栏位"></label>
					<div class="layui-input-inline">
						<input type="text" autocomplete="off" id="pigLocation" lay-verify="required" disabled="disabled" name="pigLocation" class="layui-input">
					</div>
				</div>
		
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" style="width: 120px" data-i18n="changeField.changeToHouse"></label>
					<div class="layui-input-inline">
						<select id="newHouseId" name="newHouseId" lay-verify="required|newHouseId" lay-filter="newHouseId" style="height: 38px;border-color: #F0F0F0;" lay-search>
							<option value=""></option>
						</select>
					</div>
					<label class="layui-form-label layui-required" style="width: 120px" data-i18n="changeField.changeToField"></label>
					<div class="layui-input-inline">
						<select id="newFieldId" name="newFieldId" ay-verify="required|newFieldId" style="height: 38px;border-color: #F0F0F0;" lay-search>
							<option value=""></option>
						</select>
					</div>
				</div>
				<div class="layui-form-item" style="padding-right: 20px">
					<label class="layui-form-label layui-required" style="width: 120px" data-i18n="changeField.changeDate"></label>
					<div class="layui-input-inline">
						<input type="text" autocomplete="off" id="changeHouseTime" lay-verify="required" name="changeHouseTime" class="layui-input">
					</div>
					<label class="layui-form-label" style="width: 120px" data-i18n="common.remark"></label>
					<div class="layui-input-inline">
						<input type="text" autocomplete="off" data-i18n="[placeholder]common.remarkText" maxlength="100" id="remark" name="remark" class="layui-input">
					</div>
				</div>
				<div class="page-footer">
					<div class="btn-list">
						<div class="btnlist">
							<button class="layui-btn" lay-submit="" lay-filter="submit" data-i18n="[append]btnSave"><i class="fa fa-floppy-o">&nbsp;</i></button>
							<button class="layui-btn" onclick="$t.closeWindow();" data-i18n="[append]btnBack"><i class="fa fa-undo">&nbsp;</i></button>
						</div>
					</div>
				</div>
			</form>
		</div>

		<!-- 国际化        -->
		<script src="../../statics/plugins/i18n/i18next.min.js"></script>
		<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
		<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
		<script>
			var farmId;
			var groupId;
			var authToken = localStorage.getItem("authToken");
			//alert(authToken);
			var user = localStorage.getItem("user");
			i18n('../../locales', onLangReady) //国际化
			function onLangReady() {
				layui.use(['form', 'laydate'], function() {
					var form = layui.form;
					var $ = layui.$;
					var laydate = layui.laydate;
					if(!checkToken()) {
						alert(i18next.t("timeout"));
						window.top.location.href = '../../login.html';
					}
					farmId = JSON.parse(user).farmId;
					groupId = JSON.parse(user).groupId;

					//创建时间 日期控件
					laydate.render({
						elem: '#changeHouseTime' //指定元素
							,
						theme: 'molv',
						calendar: true //重要节日
					});

					var page = 1;
					var pageSize = 30;
					var pigsType = '00034';

					//获取猪只下拉列表
					$.ajax({
						//  url: commonIP + 'api/pig/info/getListPage?authToken='+authToken +'&farm_id='+farmId + '&page='+page+'&limit='+pageSize+'&pigs_type=00032',
						url: commonIP + 'api/pig/info/getListPage?authToken=' + authToken + '&farm_id=' + farmId + '&page=' + 0 + '&limit=' + 0,

						success: function(res) {

							var dataObj = JSON.parse(res);
							if(dataObj != null && dataObj.dataSource.list.length > 0) {
								var groupOption;
								for(var i = 0; i < dataObj.dataSource.list.length; i++) {
									groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].pigs_archives_id + '">' + dataObj.dataSource.list[i].pigs_number + '</option>';
								}
								$("#pigNumbers").append(groupOption);
								form.render('select'); //一定要加form.render();
								//	BindHouseDropList()
							}
						}
					});
 	
					//绑定栋舍
					$.ajax({
						
						url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&page=0&limit=0&farmId=' + farmId,
						//url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&page=0&limit=0&farmId=' + farmId,
						async: false,
						success: function(res) {
							var dataObj = JSON.parse(res);
							if(dataObj.errcode == 10016) {
								return
							} else {
								if(dataObj != null && dataObj.dataSource.list.length > 0) {
									var groupOption;
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
									
										if(groupId == dataObj.dataSource.list[i].id) {
											groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '" selected="">' + dataObj.dataSource.list[i].name + '</option>';
										} else {
											groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
										}
									}
									$("#newHouseId").append(groupOption);
									form.render('select'); //一定要加form.render();

								}
							}
						}
					});

					form.on('select(newHouseId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
						document.getElementById("newFieldId").options.length = 0;
						//document.getElementById("batchId").options.length = 0;
						$('#newFieldId').empty();
						form.render('select');

						BindRfId();
					});

					//绑定rfId
					function BindRfId() {

						var houseId = $('#newHouseId').val();
					//	alert(houseId);
						if(houseId == "") {
							return;
						}
						$.ajax({
							url: commonIP + 'api/pig/field/getFieldListPage?authToken=' + authToken + "&house_id=" + houseId,
							async: false,
							success: function(res) {
								// console.log(res)
								var dataObj = JSON.parse(res);
								if(dataObj.errcode == 10016) {
									return
								} else {
									console.log(dataObj)
									if(dataObj != null && dataObj.dataSource.list.length > 0) {
										var groupOption;
										for(var i = 0; i < dataObj.dataSource.list.length; i++) {
											groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].code + '</option>';
										}
										$("#newFieldId").append(groupOption);
										form.render('select'); //一定要加form.render();
										//  BindHogBatch();
									}
								}

							}
						});
					}

					//						//获取栋舍下拉列表
					//						function BindHouseDropList() {
					//							$.ajax({
					//								url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&page=0&limit=0&farmId=' + farmId,
					//								success: function(res) {
					//									var dataObj = JSON.parse(res);
					//									if(dataObj != null && dataObj.dataSource.list.length > 0) {
					//										var groupOption;
					//										for(var i = 0; i < dataObj.dataSource.list.length; i++) {
					//											groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
					//										}
					//										$("#newHouseId").append(groupOption);
					//										form.render('select'); //一定要加form.render();
					//										
					//									}
					//								}
					//							});
					//						}
					//						
					//						form.on('select(houseId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
					//							document.getElementById("rfId").options.length = 0;
					//							//document.getElementById("batchId").options.length = 0;
					//							$('#rfId').empty();
					//							form.render('select');
					//
					//							BindRfId();
					//						});
					//
					//						//   form.on('select(newHouseId)', function (data) {    
					//						//绑定rfId
					//						function BindRfId() { //var houseId = $('#houseId').val();
					//
					//							var newHouseId = $("#newHouseId").val();
					//							if(newHouseId == "") {
					//								return;
					//							}
					//							//根据栋舍获取当前栏位
					//							$.ajax({
					//								url: commonIP + 'api/pig/field/getFieldListPage?authToken=' + authToken + '&farmId=' + farmId + '&house_id=' + newHouseId + '&page=0&limit=0',
					//								success: function(res) {
					//									var dataObj = JSON.parse(res);
					//									if(dataObj != null && dataObj.dataSource.list.length > 0) {
					//										var groupOption;
					//										for(var i = 0; i < dataObj.dataSource.list.length; i++) {
					//											groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].code + '</option>';
					//										}
					//										$("#newFieldId").append(groupOption);
					//										form.render('select'); //一定要加form.render();
					//									}
					//								}
					//							});
					//						});

					form.on('select(pigNumbers)', function(data) {
						var pigId = $("#pigNumbers").val();
						//获取当前猪只位置
						$.ajax({
							url: commonIP + 'api/pig/info/getListPage?authToken=' + authToken + '&pigs_archives_id=' + pigId + '&page=1&limit=10',
							success: function(res) {
								var dataObj = JSON.parse(res);
								for(var i = 0; i < dataObj.dataSource.list.length; i++) {
									var b = dataObj.dataSource.list[i].houseName;
									if(b == "") {
										var a = i18next.t("common.noLocation");
										$("#pigLocation").val(a);
									} else {
										var a = b + "|" + dataObj.dataSource.list[i].code;
										$("#pigLocation").val(a);
									}
								}
							}
						});
					});

					form.on('submit(submit)', function(res) {
						if(confirm("请您确认信息无误？")) {
							var pigId = $("#pigNumbers").val();
							$.ajax({
								url: commonIP + 'api/pig/info/getListPage?authToken=' + authToken + '&pigs_archives_id=' + pigId + '&page=1&limit=10',
								success: function(res) {
									var dataObj = JSON.parse(res);
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
										var oldHouseId = dataObj.dataSource.list[i].houseId;
										var oldFieldId = dataObj.dataSource.list[i].fieldId;
										var pigsArchivesId = dataObj.dataSource.list[i].pigs_archives_id;
										var newHouseId = $('#newHouseId').val();
										var newFieldId = $('#newFieldId').val();
										var changeHouseTime = $('#changeHouseTime').val();
										var remark = $('#remark').val();

										$.ajax({
											type: 'POST',
											url: commonIP + "api/pig/changehouse/create?authToken=" + authToken,
											contentType: 'application/json',
											data: JSON.stringify({
												"groupId": groupId,
												"farmId": farmId,
												"oldHouseId": oldHouseId,
												"oldFieldId": oldFieldId,
												"pigsArchivesId": pigsArchivesId,
												"changeHouseTime": changeHouseTime,
												"remark": remark,
												"newHouseId": newHouseId,
												"newFieldId": newFieldId
											}),
											async: false,
											success: function(data) {
												var dataObj = JSON.parse(data);
												console.log(dataObj);
												if(dataObj) {
													if(dataObj.errcode == "200") {
														alert(i18next.t("addSucc"));
														layer.close(layer.index);
														window.parent.location.reload();
													} else {
														alert(dataObj.errmsg);
														// alert(i18next.t("addFailed"));
													}
												}
											}
										});
									}
								}
							});
						}
						return false;
					});

				});
			}
		</script>
	</body>

</html>