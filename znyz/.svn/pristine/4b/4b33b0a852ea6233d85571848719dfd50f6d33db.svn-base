<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" /><!--强制让文档的宽度与设备的宽度保持1:1，并且文档最大的宽度比例是1.0，且不允许用户点击屏幕放大浏览-->
	<meta content="yes" name="apple-mobile-web-app-capable" /><!--iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览-->
	<meta content="black" name="apple-mobile-web-app-status-bar-style" /><!--iphone的私有标签，它指定的iphone中safari顶端的状态条的样式-->
	<meta name="format-detection" content="telephone=no" /><!--告诉设备忽略将页面中的数字识别为电话号码-->
	<meta content="false" name="twcClient" id="twcClient" /><!--判断页面是否在本地Native（本地APP）环境中-->	
	<title>测膘系统</title>
	<script src="script/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/flexible.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/flexible_css.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" type="text/css" href="style/style.css"/>
	<link rel="stylesheet" type="text/css" href="style/common.css"/>
</head>
<body>
	<div class="page_top">
		<img src="style/logo.png" width="100" class="logo" style="margin-top: 15px;"/>
	</div>
	<div class="login msg">
     	<ul class="weight_msg user_msg msg">
			<li><img src="" id="headimgurl" style="width: 100px; height: 100px;margin-top: -50px;margin-left: 20px;"/></li>
			<!--<li><h4><a id ="nickname"></a> <span>厂长</span></h4></li>-->
        	<li>
          		<select name="factory" id="farm_username" style="width:auto;text-indent: 0;padding: 0 5%;margin: 0;"></select>
            </li>
     	</ul>
	</div>
	<div class="enter"><h3 onclick="login()">进入猪场</h3></div>
	</div>   
	<div class="change">
		<h5 onclick="accountLogin()">切换账号</h5>
	</div>
	<script>
	 	var openId = localStorage.getItem('openId');
		$(document).ready(function () {
			var user = localStorage.getItem('user');
		 	var code = getUrlParam('code');
		 	if(code!=null && openId==null){
				$.ajax({
					type: "POST",
					url: commonIP + "api/users/newLoginByWeiXin",
					data: JSON.stringify({
						"code":code
					}) ,
					contentType: 'application/json',
					success: function(data) {
						if (data.errcode == 200) {
							openId = data.openId;
							for (var i=0;i<data.dataSource.total;i++) {
								if(data.dataSource.list[i] != null 
									&& data.dataSource.list[i].user!=null
									&& data.dataSource.list[i].user.id != null){
									$('#farm_username').append('<option style="text-align:center;" value='+data.dataSource.list[i].user.id+'>'+
									data.dataSource.list[i].user.farmName+'：'+data.dataSource.list[i].user.name+'</option>');
								}
								if(data.dataSource.list[i] != null 
									&& data.dataSource.list[i].wxUser!=null
									&& data.dataSource.list[i].wxUser.headimgurl != null){
									$('#headimgurl').attr("src",data.dataSource.list[i].wxUser.headimgurl);
								}
			                } 
			                localStorage.setItem('openId',openId);
						} else {
							if(data.errcode == '400'){
								openId = data.openId;
								window.top.location.href = 'login.html?openId='+openId;
							}else if(data.errcode == '40029'){
								alert('无效的微信code');
							}
						}
					}
				});
		 	}else if(openId != null){
		 		$.ajax({
					type: "POST",
					url: commonIP + "api/users/getUserByOpenid",
					data: JSON.stringify({
					"openId":openId
					}) ,
					contentType: 'application/json',
					dataType: 'json',
					success: function(data) {
						if (data.errcode == 200) {
							for (var i=0;i<data.dataSource.total;i++) {
								if(data.dataSource.list[i] != null 
									&& data.dataSource.list[i].userId != null){
									$('#farm_username').append('<option style="text-align:center;" value='+data.dataSource.list[i].userId+'>'+
									data.dataSource.list[i].farmName+'：'+data.dataSource.list[i].userName+'</option>');
								}
								if(data.dataSource.list[i] != null 
									&& data.dataSource.list[i].headimgurl != null){
									$('#headimgurl').attr("src",data.dataSource.list[i].headimgurl);
								}
			                } 
						}
					}
				});
			}
		});
		// 登录
		function login() {
			var userId=$('#farm_username').val();				
			$.ajax({
				type: "POST",
				url: commonIP + "api/users/newLoginByWeiXin",
				data: JSON.stringify({
					"id":userId,
					"openId":openId
				}) ,
				contentType: 'application/json',
				success: function(data) {
					if (data.errcode == 200) {
						var authToken = data.dataSource.list[0].authToken;
						// 设置登录后的authToken
						localStorage.setItem('authToken',authToken);					
						// 设置登录用户信息
						localStorage.setItem('user',JSON.stringify(data.dataSource.list[0].user));
						localStorage.setItem('wxUser',JSON.stringify(data.dataSource.list[0].wxUser));
						localStorage.setItem('openId',openId);
						//获取用户角色信息
						checkRole(authToken,userId);
					} else {
						alert(data.errmsg);
					}
				}
			});
		}
		function checkRole(authToken,userId){
			$.ajax({
				type: "GET",
				url: commonIP + 'api/system/userrole/get',
				data: 'authToken='+authToken+'&userId='+userId,
				contentType: 'application/json',
				dataType: 'json',
				success: function(data) {
					if (data.errcode == 200) {
						if(data.dataSource.total<=0){
							alert("该用户没有指定角色，请联系管理员！");
						}else if(data.dataSource.total==1){
							localStorage.setItem('roleId',data.dataSource.list[0].roleId);
							localStorage.setItem('roleName',data.dataSource.list[0].roleName);
							window.location.href = 'fieldList.html';
						}else{
							window.location.href = 'roleSelect.html';
						}
					}else{
						alert("该用户没有指定角色，请联系管理员！");
					}
				}
			});
		}
		//账号密码登录
		function accountLogin(){
			window.top.location.href = 'login.html?openId='+openId;
		}
	</script>
</body>
</html>