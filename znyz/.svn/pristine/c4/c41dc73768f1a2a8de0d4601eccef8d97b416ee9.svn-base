<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>月体重图表</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	</head>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="../basedata/assets/js/jquery.min.js"></script>
	<script src="../basedata/echarts/echarts.js"></script>
	<style>
		.chart_con {
			margin: 30px 0 0 30px;
			width: 750px;
			height: 560px;
		}
	</style>

	<body>
		<div class="chart_con" id="monthChart">
		</div>

		<script>
			//本月测重记录(折线图)
			var monthOption = {
				title: {
					text: '本月测重(KG)',
					subtext: '',
					top: -4,
					textStyle: {
						fontSize: 12,
					}
				},

				grid: {
					top: '15%',
					bottom: '15%'
				},
				tooltip: {
					trigger: 'axis'
				},
				legend: {
					top: -4,
					data: ['体重', '背膘']
				},
				toolbox: {
					show: false,
					feature: {
						dataZoom: {
							yAxisIndex: 'none'
						},
						dataView: {
							readOnly: false
						},
						magicType: {
							type: ['line', 'bar']
						},
						restore: {},
						saveAsImage: {}
					}
				},
				xAxis: {
					type: 'category',
					boundaryGap: false
				},
				yAxis: [{
						name: '体重(kg)',
						type: 'value',
					},
					{
						name: '背膘(kg)',
						type: 'value'
					}
				],
				
				series: [{
					name: '体重',
					type: 'line',
//					data: [0, 0, 0, 0, 0],
//					symbolSize: 5,
					markPoint: {
						symbol: 'pin',
						symbolSize: [60, 60],
						data: [{
							type: 'max',
							name: '最大值'
						}]
					},
					markLine: {
						data: [{
							type: 'average',
							name: '平均值'
						}]
					}
				}]
			};

			var farmId;
			var groupId;
			var authToken = localStorage.getItem("authToken");
			var user = localStorage.getItem("user");
			var id = GetQueryString("id");
			if(!checkToken()) {
				alert("登录超时，请重新登录！");
				window.top.location.href = '../../login.html';
			}
			farmId = JSON.parse(user).farmId;
			groupId = JSON.parse(user).groupId;

			$(function() {
				GetMonthWeightInfo()
			})
			//取得月猪重信息
			function GetMonthWeightInfo() {
				monthChart = echarts.init(document.getElementById('monthChart'));
				monthChart.setOption(monthOption);
				var currentDate = getDate();
				$.ajax({
					type: "GET",
					url: commonIP + 'api/pig/bodyinformation/getWeightBackFatMonthList',
					contentType: 'application/json',
					data: 'authToken=' + authToken + '&pigsArchivesId=' + id + '&currentDate=' + currentDate,
					dataType: 'json', // GET 请求方式需要添加dataType 设定返回数据的格式为json;
					success: function(data) {
						console.log(data);
						if(data) {
							if(data.errcode == 200) {
								// 重量集合
								var weightDataArry = data.dataSource.list[0].monthWeightInfo;
								var fatDataArry = data.dataSource.list[0].monthFatInfo;
								var minWeight = 0;
								var maxWeight = 0;
								var first = true;
//								for(var i = 0; i < weightDataArry.length; i++) {
								for(var i = 0; i < 15; i++) { //移动项目演示专用
									if(weightDataArry[i] != null) {
										if(first) {
											minWeight = weightDataArry[i];
											maxWeight = weightDataArry[i];
											first = false;
										} else {
											if(weightDataArry[i] < minWeight) {
												minWeight = weightDataArry[i];
											}
											if(weightDataArry[i] > maxWeight) {
												maxWeight = weightDataArry[i];
											}
										}
									}
								}
								minWeight = parseInt(minWeight) - 1 
								maxWeight = parseInt(maxWeight) + 1 
								if(minWeight < 0) {
									minWeight = 0;
								}
								if(maxWeight < 0) {
									maxWeight = 0;
								}
								// 当前重量
								var CurrentWeight = parseInt(data.dataSource.list[0].currWeight);
								var CurrentWeightFloat = parseFloat(data.dataSource.list[0].currWeight);

								var lastDate = data.dataSource.list[0].lastDate;

								// 区间增重
								var TwAddWeight = parseInt(data.dataSource.list[0].increaseWeight);
								if(TwAddWeight == 0) {
									TwAddWeight = 1;
								}
								var TwAddWeightFloat = parseFloat(data.dataSource.list[0].increaseWeight);
								
								var xData = new Array()
								for(let i = 0; i < 31; i++) {
									xData.push(parseInt(i) + 1 + '日')
								}
								monthChart.setOption({
									xAxis: {
										data: xData
									},
									yAxis: [{
											max: maxWeight, //135,
											min: minWeight //125,
										},
										{
											min: 18,
											max: 19
										}
									],
									series: [{
										// 根据名字对应到相应的系列
										name: '体重',
										type: 'line',
										data: weightDataArry
									}, {
										// 根据名字对应到相应的系列
										name: '背膘',
										type: 'line',
										yAxisIndex: 1,
										data: fatDataArry
									}]
								});
							} else {
								if(data.errcode == "10005") {
									alert(data.errmsg);
									window.top.location.href = 'wxlogin.html';
								}
							}
						}
					},
					error: function(err) {

					}
				})
			}
		</script>
	</body>

</html>