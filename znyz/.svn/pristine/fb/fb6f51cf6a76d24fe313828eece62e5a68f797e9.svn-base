<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>layui</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	
	
	
		<script language="JavaScript" type="text/javascript"> 		
	function clearNoNum(textbox) {
		var IllegalString = "[`~!#$^&*()=|{}':;',\\[\\].<>/?~！#￥……&*（）——|{}【】‘；：”“'。，、%？]‘’";
		var textboxvalue = textbox.value;
		var index = textboxvalue.length - 1;
	
		var s = textbox.value.charAt(index);
	
		if (IllegalString.indexOf(s) >= 0) {
			s = textboxvalue.substring(0, index);
			textbox.value = s;
		}
 
	} 

	</script>
	
	
	<style>
		body .skin-class .layui-layer-btn .layui-layer-btn0 {
			border-color: rgb(2, 145, 277);
			background-color: rgb(2, 145, 277);
			color: #fff;
			width: 30px;
			height: 36px;
			line-height: 36px;
			position: absolute;
			top: 183px;
			right: 12px;		
		}
	</style>
	<body>
		<div class="layui-form-item" id="button" style="margin-top: 10px;">
			<form class="layui-form">
				<label class="layui-form-label" data-i18n="[prepend]common.groupName">:</label>
				<div class="layui-input-inline">
					<select id="groupId" name="groupId" lay-filter="groupId" style="height: 25px;border-color: #F0F0F0;" lay-search>
						<option value=""></option>
					</select>
				</div>
				<label class="layui-form-label" data-i18n="[prepend]common.farmName">:</label>
				<div class="layui-input-inline">
					<select id="farmId" name="farmId" style="height: 25px;border-color: #F0F0F0;" lay-search>
						<option value=""></option>
					</select>
				</div>

				<label class="layui-form-label" data-i18n="[prepend]user.personName">:</label>
				<div class="layui-input-inline">
					<input class="layui-input" id="name" name="name" autocomplete="off" onkeyup="clearNoNum(this)">
				</div>

				<label class="layui-form-label" data-i18n="[prepend]user.loginName">:</label>
				<div class="layui-input-inline">
					<input class="layui-input" id="loginName" name="loginName" autocomplete="off" onkeyup="clearNoNum(this)">
				</div>

			</form>
			<button class="layui-btn" id="search" data-i18n="btnSearch"></button>

			<button class="layui-btn" id="reset" data-i18n="btnReset"></button>

			<button class="layui-btn" id="add" data-i18n="btnAdd"></button>
		</div>
		<table class="layui-hide" id="userInfo" lay-filter="userInfo"></table>
		<script type="text/html" id="barDemo">
			
			<a class="layui-btn layui-btn-xs" lay-event="edit" data-i18n="btnEdit"></a>
			 {{#  if(d.delFlag == 1){ }}
				<a class="layui-btn  layui-btn-xs " id="use" lay-event="use" >启用</a>
			
			  {{#  } else { }}
		
			  <a class="layui-btn layui-btn-danger layui-btn-xs" id="nouse" lay-event="nouse">禁用</a>
			  {{#  } }}
			
			<a class="layui-btn layui-btn-primary layui-btn-xs " lay-event="detail" data-i18n="user.changePassword"></a>

		</script>

		<!-- 国际化    	<a class="layui-btn layui-btn-danger layui-btn-xs layui-btn-disabled" id="nouse" lay-event="nouse">禁用</a>
				  <a class="layui-btn  layui-btn-xs layui-btn-disabled" id="use" lay-event="use" >启用</a>
		-->
		<script src="../../statics/plugins/i18n/i18next.min.js"></script>
		<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
		<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
		<script>
			var authToken = localStorage.getItem("authToken");
			var user = localStorage.getItem("user");
			i18n('../../locales', onLangReady) //国际化
			function onLangReady() {
				if(!checkToken()) {
					alert(i18next.t("timeout"));
					window.top.location.href = '../../login.html';
				}

				layui.use(['form', 'table', 'laydate'], function() {
					var table = layui.table;
					var form = layui.form;
					var laydate = layui.laydate;
					var $ = layui.$;
					getGroupList();
					//方法级渲染
					table.render({

						elem: '#userInfo',
						url: commonIP + "api/system/user/get?authToken=" + authToken //数据请求路径
							,
						parseData: function(res) {
							//	console.log(res)
							//res 即为原始返回的数据
							return {
								"code": res.code, //解析接口状态
								"msg": res.msg, //解析提示文本
								"count": res.count, //解析数据长度
								"data": res.errcode === '200' ? res.dataSource.list : [] //解析数据列表
							};
						},
						cellMinWidth: 80,
						cols: [
							[{
									type: 'numbers',
									width: '5%'
								}, {
									field: 'groupName',
									title: i18next.t("common.groupName"),
									width: '10%'
								}
								//,{field:'farmName', title:i18next.t("common.farmName"),width:'10%'}
								, {
									field: 'farmName',
									title: i18next.t("common.farmName"),
									width: '10%'
								}, {
									field: 'name',
									title: i18next.t("user.personName"),
									width: '10%'
								}, {
									field: 'loginName',
									title: i18next.t("user.loginName"),
									width: '10%'
								}, 
								{
									field: 'roleName',
									title: i18next.t("role.getRoleName"),
									width: '10%'
								}, 
								{
									field: 'phone',
									title: i18next.t("user.phone"),
									width: '10%'
								}, 
								{
									field: 'updateTime',
									title: i18next.t("common.updateTime"),
									width: '15%'
								}, {
									field: 'delFlag',
									title: i18next.t("common.currentState"),
									width: '7%'
								}, {
									fixed: 'right',
									title: i18next.t("opt"),
									width: '13%',
									align: 'center',
									toolbar: '#barDemo'
								} //一个工具栏  具体请查看layui官网
							]
						],
						even: true //开启隔行背景
							,
						page: true //开启分页
							,
						limit: 10 //默认十条数据一页
							,
						limits: [10, 20, 30, 50] //数据分页条
							,
						id: 'testReload',
						done: function(res, curr, count) {
							console.log(res);
							console.log(curr);
							
							i18n('../../locales', function() {
									$("[data-field = 'delFlag']").children().each(function() {
										//$("#use").addClass("layui-btn-disabled")
										//$("#nouse").addClass("layui-btn-disabled")
										
										if($(this).text() == '1') {
										$(this).text(i18next.t("group.unusable"));
										//	Console.log($(this));
										//		Console.log($(this.document));
										//	$(this).document.getElementById("use").disabled=ture;

											//$(this).text(i18next.t("group.unusable"));
											//layui-btn-disabled
										//	$(this).attribute("dosabled",ture);
										//	$("#use").addClass("layui-btn-disabled")
										}
										if($(this).text() == '0') {
											$(this).text(i18next.t("group.usable"));
										//	$(this).document.getElementById("use").disabled=ture;
										//	$(this).attribute("dosabled",ture);
										// $("script~use").addClass("layui-btn-disabled")
										//	$("#nouse").addClass("layui-btn-disabled")
										}

									})
									
						


								}) //国际化
								// for( i=0;i<count;i++){
								// 	delFlag=res.data[i].delFlag;
								// 	if(delFlag == '0'){
								// 		$("#nouse").addClass("layui-btn-disabled")
								// 	}
								// 	if(delFlag == '1'){
								// 		$("#use").addClass("layui-btn-disabled")
								// 	}
								// }
								
								

						},

					});
					//监听工具条
					table.on('tool(userInfo)', function(obj) {
						var data = obj.data;
						var delFlag = data.delFlag;
						if(obj.event === 'detail') {
							var index = layer.open({
								skin: 'skin-class',
								type: 2,
								content: "updatePassword.html?id=" + data.id,
								btn: ['返回'],
								area: ['450px', '250px'],
								maxmin: true
							});
						} else if(obj.event === 'use') {
							if(delFlag == 1 & delFlag !=null & delFlag != ''){
							layer.confirm(i18next.t("是否启用该用户"), function(index) {
								$.ajax({
									url: commonIP + "api/system/user/delete?authToken=" + authToken,
									type: 'POST',
									contentType: 'application/json',
									data: JSON.stringify({
										"id": data.id,
										"delFlag": data.delFlag
									}),
									success: function(text) {
										var dataObj = JSON.parse(text);
										alert("启用成功")
										active['reload'].call(this);
											table.reload('testReload', {
								page: {
									curr: 1 //重新从第 1 页开始
								},
								where: {
									groupId: $("#groupId").val(),
									farmId: $('#farmId').val(),
									name: $('#name').val(),
									loginName: $('#loginName').val()
								},
								
							});
										layer.close(index);
//										if(dataObj.code == 0) {
//											layer.msg(dataObj.msg, {
//												icon: 6
//											});
//											obj.success();
//											layer.close(index);
//										} else {
//											layer.msg(dataObj.msg, {
//												icon: 5
//											});
//										}
									}
								});
							});
							}
							
						} else if(obj.event === 'nouse') {
							if(delFlag == 0 & delFlag !=null & delFlag != ''){
							layer.confirm(i18next.t("是否禁用该用户"), function(index) {
								$.ajax({
									url: commonIP + "api/system/user/delete?authToken=" + authToken,
									type: 'POST',
									contentType: 'application/json',
									data: JSON.stringify({
										"id": data.id,
										"delFlag": data.delFlag
									}),
									success: function(text) {
										var dataObj = JSON.parse(text);
										alert("禁用成功")
										layer.close(index);
								table.reload('testReload', {
								page: {
									curr: 1 //重新从第 1 页开始
								},
								where: {
									groupId: $("#groupId").val(),
									farmId: $('#farmId').val(),
									name: $('#name').val(),
									loginName: $('#loginName').val()
								}
							});
//										if(dataObj.code == 0) {
//											layer.msg(dataObj.msg, {
//												icon: 6
//											});
//										//	obj.del();
//										obj.success();
//											layer.close(index);
//										} else {
//											layer.msg(dataObj.msg, {
//												icon: 5
//											});
//										}
									}
								});
							});
							active['reload'].call(this);
							}
						} else if(obj.event === 'edit') {
							var index = layer.open({
								type: 2,
								content: "addUserInfo.html?id=" + data.id,
								area: ['450px', '450px'],
								maxmin: true
							});
						}
					});

					$('#add').on('click', function() {
						var index = layer.open({
							type: 2,
							content: 'addUserInfo.html',
							area: ['450px', '450px'],
							maxmin: true
						});
						//					layer.full(index);
					});
					var active = {
						reload: function() {
							//执行重载
							table.reload('testReload', {
								page: {
									curr: 1 //重新从第 1 页开始
								},
								where: {
									groupId: $("#groupId").val(),
									farmId: $('#farmId').val(),
									name: $('#name').val(),
									loginName: $('#loginName').val()
								}
							});
						},
					};

					//获取猪场下拉
					function bindFarmSelectList() {
						var groupId = $('#groupId').val();

						$.ajax({
							url: commonIP + 'api/system/farm/getListPage?authToken=' + authToken + '&page=0&limit=0&groupId=' + groupId,
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							success: function(res) {
								var dataObj = JSON.parse(res);
								if(dataObj != null && dataObj.dataSource.list.length > 0) {
									var farmOption = '<option value="">' + i18next.t("device.farmValDefault") + '</option>';
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
										farmOption = farmOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
									}
									$("#farmId").append(farmOption);
									form.render('select'); //一定要加form.render();
								}
							}
						});
					}

					function getGroupList() {
						//获取集团下拉列表
						$.ajax({
							url: commonIP + 'api/system/group/getListPage?authToken=' + authToken + '&page=0&limit=0',
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							success: function(res) {
								var dataObj = JSON.parse(res);

								if(dataObj != null && dataObj.dataSource.list.length > 0) {
									var groupOption;
									for(var i = 0; i < dataObj.dataSource.list.length; i++) {
										groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[i].name + '</option>';
									}
									$("#groupId").append(groupOption);
									form.render('select'); //一定要加form.render();
									bindFarmSelectList();
								}
							}
						});
						form.on('select(groupId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
							/**改变集团后先清空猪场下拉值*/
							document.getElementById("farmId").options.length = 0;
							$('#farmId').empty();

							form.render("select");
							bindFarmSelectList();
						});
					}
					//创建时间 日期控件
					laydate.render({
						elem: '#createDate' //指定元素
							,
						range: true //是否开启范围选择，即双控件
							,
						theme: 'molv',
						calendar: true //重要节日
							//		  	,mark: {'2018-5-14': '生日','2018-5-28': '纪念日'} //日期备注，如重要事件或活动标记
					});
					$('#search').on('click', function() {
						active['reload'].call(this);
					});
					$('#reset').on('click', function() {
						$('#createDate').val("");
						//清空后重新刷新下拉菜单
						$('#groupId').val("");
						$('#farmId').empty();
						$('#name').val("");
						$('#loginName').val("");
						form.render("select");
						getGroupList()
						bindFarmSelectList()
						/*$("#farmId option:first").prop("selected", 'selected');  */
					});
				});
			}
		</script>

	</body>

</html>