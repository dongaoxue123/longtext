
<html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
            <title>Title</title>
            <script src="statics/libs/jquery-1.7.2.js"></script>
            <link rel="stylesheet" href="statics/css/font-awesome.min.css">
            <link rel="stylesheet" href="common/css/cyType.css">
            <link rel="stylesheet" href="common/css/extendedStyle.css">
            <link rel="stylesheet" href="statics/plugins/layui/css/layui.css" media="all">
            <link rel="shortcut icon" type="image/x-icon" href="statics/img/favicon.ico" media="screen"/>
            <link rel="stylesheet" href="statics/plugins/layui/css/layui.css">
            <link rel="stylesheet" href="statics/plugins/layer/skin/default/layer.css">
            <link rel="stylesheet" href="statics/css/font-awesome.min.css">
            <link rel="stylesheet" href="statics/css/index.css">
            <link rel="stylesheet" href="common/css/cyStyle.css">
            <link rel="stylesheet" href="statics/plugins/ContextJS/css/context.standalone.green.css">
            <script src="statics/plugins/layui/layui.js"></script>
            <script src="common/js/whole/cyLayer.js"></script>
            <script src="common/js/whole/utils.js"></script>
            <script src="js/common.js" type="text/javascript" charset="utf-8"></script>
        </head>
        <body>
        <div class="layui-field-box">
            <form class="layui-form">
                <div class="layui-form-item" style="padding-right: 20px">
                    <label class="layui-form-label" data-i18n="user.oldPassword"></label>
                    <div class="layui-input-block">
                        <input type="password" id="password" name="password" lay-verify="required|password"  data-i18n="[placeholder]user.oldPhonePassword" maxlength="100" class="layui-input">
                    </div>
                    <label class="layui-form-label" data-i18n="user.newPassword" style="margin-top: 10px;"></label>
                    <div class="layui-input-block" style="margin-top: 10px;">
                        <input type="password" id="newPassword" name="newPassword" lay-verify="required|newPassword"  data-i18n="[placeholder]user.newPasswordPlaceholder" maxlength="20" class="layui-input">
                    </div>
                    <label class="layui-form-label" data-i18n="user.surePassword" style="margin-top: 10px;"></label>
                    <div class="layui-input-block" style="margin-top: 10px;">
                            <input type="password" id="surePassword" name="surePassword" lay-verify="required|surePassword"  data-i18n="[placeholder]user.surePhonePassword" maxlength="20" class="layui-input">
                    </div>
                </div>
                <div class="page-footer">
                    <div class="btn-list">
                        <div class="btnlist">
                            <button class="layui-btn" lay-submit="" lay-filter="submit" data-i18n="保存" style="background: rgb(2, 145, 277);"></button>
                            <button class="layui-btn" id="canel" style="background: rgb(2, 145, 277);" data-i18n="返回"></button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- 国际化        -->
            <script src="statics/plugins/i18n/i18next.min.js"></script>
            <script src="statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
            <script src='statics/plugins/i18n/loc-i18next.min.js'></script>
            <script src="sha256.js"></script>
        <script>
            var authToken=localStorage.getItem("authToken"); 
            var user1 =localStorage.getItem("user");
            var user = JSON.parse(user1);
            var groupId;
            var farmId;
            var name;
            var loginName;
            i18n('locales', onLangReady) //国际化
                function onLangReady() {
                    
            
            layui.use(['form','laydate'], function(){
                var form = layui.form;
                var $ = layui.$;
                var laydate = layui.laydate;
                if(!checkToken()){
                      alert(i18next.t("timeout"));
                         window.top.location.href = '../../login.html';
                }
        
                var userId = user.id;//userId为空表示新增，否则是修改
                $("#newPassword").change(function() {
                                var minLenght = $("#newPassword").val();
                                console.log(minLenght)
                                if(minLenght.length < 6) {
                                    //alert(1);
                                    var warnMessage = "密码请设置6到20位之间";
                                    alert(warnMessage);
                                } else {
                                    return true
                            
                                }
                            });
                // if(userId != null)//编辑
                // {
                    $.ajax({
                    type: "GET",
                    url: commonIP + 'api/system/user/get?authToken='+authToken+'&page=0&limit=0&id='+userId,
                    contentType: 'application/json',
                    async: false,
                    success: function(data) {
                        var datas = JSON.parse(data);
                        console.log(datas);
                        if (datas.errcode == 200) {
                            //赋值
                            
                            password = datas.dataSource.list[0].password;
                            console.log(password)

                            groupId = datas.dataSource.list[0].groupId;
                            farmId = datas.dataSource.list[0].farmId;
                            name = datas.dataSource.list[0].name;
                            loginName = datas.dataSource.list[0].loginName;
                        } else {
                            //alert(data.errmsg);
                            if(data.errcode=="10005"){
                                    window.top.location.href = '../../login.html';
                            }
                        }
                    }
                    });
                // }
                
                form.on('submit(submit)', function(res,){
                            console.log(res)
                            var minLenght = $("#password").val();
                            var newWord = $("#newPassword").val();
                            var sureWord = $("#surePassword").val();
                            console.log(minLenght)
                            console.log(password)
                            console.log(sha256_digest(minLenght))
                                if (newWord === sureWord) {
                                    // return true
                                } else {
                                    alert ('确认密码错误，请重试')
                                    return false
                                } if (sha256_digest(minLenght) === password) {
                                    console.log(minLenght)
                                    // return true
                                } else if (sha256_digest(minLenght) !== password) {
                                    alert ('原密码不正确，请重试')
                                    return false
                                } else if(newWord.length < 6) {
                                    //alert(1);
                                    var warnMessage = "密码请设置6到20位之间";
                                    alert(warnMessage);
                                    return;		
                                }



                //layer.msg(JSON.stringify(res.field));
                console.log(111)
                   $.ajax({  
                    type: 'POST',
                    url: commonIP + "api/system/user/update?authToken="+authToken,
                    contentType: 'application/json',
                    data: JSON.stringify({
                            "id":userId,
                            "groupId":groupId,
                            "farmId":farmId,
                            "name":name,
                            "loginName":loginName,
                            "Password":res.field.newPassword
                        }) ,
                    async: false,
                    success: function(data) {
                        
                        var dataObj = JSON.parse(data);
                        console.log(dataObj)
        //					console.log(dataObj);
        //					console.log(dataObj.errcode);
                        if (dataObj) {
                            if (dataObj.errcode == "200") {
                             alert('修改成功');
                             layer.close(layer.index);  
                             window.parent.location.reload();  
                            } else {
                             alert(dataObj.errmsg);
                            }
                        }
                    }
                 });
                 return false;
              });
            });
            }
            function GetQueryString(name)
            {
                 var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                 var r = window.location.search.substr(1).match(reg);
                 if(r!=null)return  unescape(r[2]); return null;
            }
            function closeForm()
            {
            
                $t.closeWindow();
                 // layer.close(); 
            }
            $('#canel').on('click', function() {
                layer.close(layer.index);  
                             window.parent.location.reload();  
						//					layer.full(index);
					});
        </script>
        </body>
        </html>
        