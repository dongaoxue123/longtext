<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>猪只异常</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>

	<body>
		<div class="layui-form-item" id="button" style="margin-top: 10px;">
			<div class="layui-form-item" style="padding-right: 20px">
				<label class="layui-form-label">栋舍列表:</label>
				<div class="layui-input-inline">
					<select id="houseId" name="houseId" style="height: 38px;border-color: #F0F0F0;">
						<option value="">请选择栋舍</option>
					</select>
				</div>
			</div>
			<div class="layui-form-item" style="padding-right: 20px">
				<label id='field-total' class='layui-form-label' style="width:200px;">共3条异常报警信息，1条未处理</label>
			</div>
		</div>
		<table class="layui-hide" id="hogBatch" lay-filter="hogBatch"></table>
		<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
			<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="done">处理</a>
		</script>
		<script>
			var farmId;
			var authToken = localStorage.getItem("authToken");
			var user = localStorage.getItem("user");

			if(!checkToken()) {
				alert("登录超时，请重新登录！");
				window.top.location.href = '../../login.html';
			}
			farmId = JSON.parse(user).farmId;

			layui.use(['form', 'table', 'laydate'], function() {
				var table = layui.table;
				var form = layui.form;
				var laydate = layui.laydate;
				var $ = layui.$;
				getList()

				//获取栋舍下拉列表
				$.ajax({
					url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&type=00059&page=0&limit=0&farmId=' + farmId,
					success: function(res) {
						var dataObj = JSON.parse(res);
						if(dataObj != null) {
							var datas = dataObj.dataSource.list
							var groupOption;
							for(var i = 0; i < datas.length; i++) {
								groupOption = groupOption + '<option value="' + datas[i].id + '">' + datas[i].name + '</option>';
							}
							$("#houseId").append(groupOption);
							form.render('select'); //一定要加form.render();
						}
					}
				});

				//监听工具条-详情
				table.on('tool(hogBatch)', function(obj) {
					var data = obj.data;
					if(obj.event === 'detail') {
						var index = layer.open({
							type: 2,
							content: "alarmDetail.html?type=1&id=" + data.xh + '&clbj=' + data.state,
							area: ['630px', '800px'],
							maxmin: true
						});
					} else if(obj.event === 'done') {
						var index = layer.open({
							type: 2,
							content: "alarmDone.html?type=1&id=" + data.xh + '&clbj=' + data.state,
							area: ['630px', '800px'],
							maxmin: true
						});
					}
				});

				function changeHouse() {
					getList()
				}

				function getList() {
					//方法级渲染
					var houseId = $("#houseId").val();
					table.render({
						elem: '#hogBatch',
						url: "../../json/pigAbnormal.json",

						request: {
							pageName: 'pageNum',
							limitName: 'pageSize',
						},
						cellMinWidth: 80,
						cols: [
							[{
									type: 'numbers',
									width: '2%'
								}, {
									field: 'fieldId',
									title: '栋舍名称',
									width: '8%'
								}, {
									field: 'breeder',
									title: '饲养员',
									width: '10%'
								}, {
									field: 'alarm',
									title: '报警信息',
									width: '8%'
								}, {
									field: 'createTime',
									title: '报警时间',
									width: '12%'
								}, {
									field: 'state',
									title: '处理状态',
									templet: function(row) {
										return row.state === '0' ? '未处理' : '已处理'
									},
									width: '8%'
								}, {
									field: 'operator',
									title: '处理人员',
									width: '8%'
								}, {
									field: 'updateTime',
									title: '处理时间',
									width: '12%',
								}, {
									field: 'remark',
									title: '处理意见',
									width: '10%'
								}, {
									fixed: 'right',
									title: '处理',
									width: '10%',
									align: 'center',
									toolbar: '#barDemo'
								} //一个工具栏  具体请查看layui官网
							]
						],
						page: true //开启分页
							,
						limit: 10 //默认十条数据一页
							,
						limits: [10, 20, 30, 50] //数据分页条
							,
						id: 'testReload',
						done: function(res, curr, count) {
							currPage = curr;
							var that = this.elem.next()
							$.each(res.data, function(index, obj) {
								if(obj.state === '0') {
									that.find(".layui-table-box tbody tr[data-index='" + index + "']").css("background-color", "#D3D3D3");
									that.find(".layui-table-box tbody tr[data-index='" + index + "'] td[data-field='state']").css("color", "red");
								} else {
									that.find(".layui-table-box tbody tr[data-index='" + index + "']  .layui-btn-danger").css("display", "none");
								}
							})
						}
					});
				}

				$('#houseId').on('change', function() {
					changeHouse()
				});

			})
		</script>
	</body>

</html>