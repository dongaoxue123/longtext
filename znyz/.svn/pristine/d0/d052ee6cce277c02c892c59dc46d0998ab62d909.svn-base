
<html>
<head>
    <title>Title</title>
    <script src="../../statics/libs/jquery-1.7.2.js"></script>
    <link rel="stylesheet" href="../../statics/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../common/css/cyType.css">
    <link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
    <script src="../../statics/plugins/layui/layui.js"></script>
    <script src="../../common/js/whole/cyLayer.js"></script>
    <script src="../../common/js/whole/utils.js"></script>
    <script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<div class="layui-field-box">
    <form class="layui-form">
    	<div class="layui-form-item">
            <label class="layui-form-label">所属集团</label>
            <div class="layui-input-inline">
    	 		<select id="group_id" name="group_id" lay-verify="required" lay-filter="group_id">
		    	</select>
		    </div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">猪场</label>
            <div class="layui-input-inline">
                <select id="farm_id" name ="farm_id" lay-verify="required|farm_id" lay-filter="farm_id">
		    	</select>
            </div>
       </div>
        <div class="layui-form-item">
            <label class="layui-form-label">阶段名称</label>
            <div class="layui-input-inline">
                <input type="text" id="stageName" name="stageName" lay-verify="required|stageName" class="layui-input"placeholder="阶段名称">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">开始时间</label>
            <div class="layui-input-inline">
                <input type="number" id="matingStartTime" name="matingStartTime" lay-verify="required|matingStartTime" class="layui-input" placeholder="配种开始时间(天数)">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">结束时间</label>
            <div class="layui-input-inline">
                <input type="number" id="matingEndTime" name="matingEndTime" class="layui-input"placeholder="配种结束时间(天数)">
            </div>
        </div>
        <div class="page-footer">
            <div class="btn-list">
                <div class="btnlist">
                    <button class="layui-btn" lay-submit="" lay-filter="submit"><i class="fa fa-floppy-o">&nbsp;</i>保存</button>
                    <button class="layui-btn" onclick="$t.closeWindow();"><i class="fa fa-undo">&nbsp;</i>返回</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
	var authToken=localStorage.getItem("authToken");
	//alert(authToken);
	var user =localStorage.getItem("user");
 	var groupId ='';
    layui.use(['form','laydate'], function(){
        var form = layui.form;
        var $ = layui.$;
        var laydate = layui.laydate;
		
		if(!checkToken()){
	  		alert("登录超时，请重新登录！");
	 			window.top.location.href = '../../login.html';
		}
		
		var id = GetQueryString("id");//id为空表示新增，否则是修改
		if(id!=null && id!=''){
			$.ajax({
				type: "GET",
				url: commonIP + 'api/pig/productionstage/getListPage?authToken='+authToken+'&page=0&limit=0&id='+id,
				parseData: function(res){ //res 即为原始返回的数据
			    return {
			    	"code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			      "data": res.dataSource.list //解析数据列表
			    };
  			},
				async:false,
				contentType: 'application/json',
				success: function(data) {
					var datas = JSON.parse(data);
					console.log(datas);
					if (datas.errcode == 200) {
						//赋值
						groupId = datas.dataSource.list[0].group_id;
					} else {
						if(data.errcode=="10005"){
							window.top.location.href = '../../login.html';
						}
					}
				}
			});
		}
	    //获取集团下拉列表
	   	$.ajax({
	        url: commonIP + 'api/system/group/getListPage?authToken='+authToken+'&page=0&limit=0',
	        parseData: function(res){ //res 即为原始返回的数据
			    return {
			    	"code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			      "data": res.dataSource.list //解析数据列表
			    };
  			},
	        async: false,
            success: function (res) {
	        	var dataObj = JSON.parse(res);
	    	    if(dataObj!=null && dataObj.dataSource.list.length>0){
	                var groupOption;
	                for (var i = 0; i < dataObj.dataSource.list.length; i++) {
	            		if(groupId==dataObj.dataSource.list[i].id){
	                		groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'" selected="">'+dataObj.dataSource.list[i].name+'</option>';
	                	}else{
		            		groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
	                	}
	                }
	                $("#group_id").append(groupOption);
	                form.render('select');//一定要加form.render();
	                bindFarmSelectList();//猪场下拉联动
	        	}
        	}
	    }); 
	    form.on('select(group_id)', function (data) { //进行监听 看元素是否变化，获取下一个下拉框数据
	    	/**改变集团后先清空猪场下拉值*/
	    	document.getElementById("farm_id").options.length = 0;
	        bindFarmSelectList();
	    });
		//获取猪场下拉列表
		function bindFarmSelectList(){
			groupId = $("#group_id").val();
		   	$.ajax({
		        url: commonIP + 'api/system/farm/getListPage?authToken='+authToken+'&groupId='+groupId+'&page=0&limit=0',
		        parseData: function(res){ //res 即为原始返回的数据
			    return {
			    	"code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			      "data": res.dataSource.list //解析数据列表
			    };
  			},
		        async: false,
	            success: function (res) {
		        	var dataObj = JSON.parse(res);
		        	if(dataObj!=null && dataObj.dataSource.list.length>0){
		                var farmOption;
		                for (var i = 0; i < dataObj.dataSource.list.length; i++) {
		            		farmOption = farmOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
		                }
		                $("#farm_id").append(farmOption);
		                form.render('select');//一定要加form.render();
	        	    }
	        	}
		    }); 
	    }
        //监听提交
        if(id == null){//添加
	        form.on('submit(submit)', function(res){
		        //layer.msg(JSON.stringify(res.field));
	       		$.ajax({  
	                type: 'POST',
					url: commonIP + "api/pig/productionstage/create?authToken="+authToken,
					contentType: 'application/json',
					data: JSON.stringify(res.field),
					async: false,
					success: function(data) {
						var dataObj = JSON.parse(data);
	//					console.log(dataObj);
	//					console.log(dataObj.errcode);
						if (dataObj) {
							if (dataObj.errcode == "200") {
						     alert("添加成功！");
	                         layer.close(layer.index);  
	                         window.parent.location.reload();  
							} else {
							 alert("添加失败！");
							}
						}
					}
	            });
	            return false;
           });
        }else{//编辑
			BindUpdateList();
			form.on('submit(submit)', function(res){
		        //layer.msg(JSON.stringify(res.field));
	       		$.ajax({  
	                type: 'POST',
					url: commonIP + "api/pig/productionstage/update?authToken="+authToken,
					contentType: 'application/json',
					data: JSON.stringify({
							"id":id,
							"group_id":res.field.group_id,
							"farm_id":res.field.farm_id,
							"matingStartTime":res.field.matingStartTime,
							"matingEndTime":res.field.matingEndTime,
							"stageName":res.field.stageName
						}) ,
					async: false,
					success: function(data) {
						var dataObj = JSON.parse(data);
	//					console.log(dataObj);
	//					console.log(dataObj.errcode);
						if (dataObj) {
							if (dataObj.errcode == "200") {
						     alert("修改成功！");
	                         layer.close(layer.index);  
	                         window.parent.location.reload();  
							} else {
							 alert("修改失败！");
							}
						}
					}
	            });
	            return false;
           });
		}
        function BindUpdateList(){
		    if(id != null)//编辑
		    {
		    	$.ajax({
					type: "GET",
					url: commonIP + 'api/pig/productionstage/getListPage?authToken='+authToken+'&page=0&limit=0&id='+id,
					parseData: function(res){ //res 即为原始返回的数据
					    return {
					    	"code": res.code, //解析接口状态
		      			"msg": res.msg, //解析提示文本
		      			"count": res.count, //解析数据长度
					      "data": res.dataSource.list //解析数据列表
					    };
		  			},
					contentType: 'application/json',
					success: function(data) {
						var datas = JSON.parse(data);
						console.log(datas);
						if (datas.errcode == 200) {
							//赋值
							$("#group_id").val(datas.dataSource.list[0].group_id);
							$("#farm_id").val(datas.dataSource.list[0].farm_id);
							form.render('select');
		
							$("#matingStartTime").val(datas.dataSource.list[0].matingStartTime);
							$("#matingEndTime").val(datas.dataSource.list[0].matingEndTime);
							$("#stageName").val(datas.dataSource.list[0].stageName);
						} else {
							//alert(data.errmsg);
							if(data.errcode=="10005"){
									window.top.location.href = '../../login.html';
							}
						}
					}
				});
		    }
		    else
		    {
		    	//新增
		    }
        }
    });
</script>
</body>
</html>
