<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>守望者设备详细信息</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../js/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
	<body>
	    <div>
			<tr>
				<td id="code">
					设备编号：
					<label id="lbl1" ></label>
				</td>
			</tr>
		</div>
		<div>
			<tr>
				<td id="state">
					当前状态：
					<label id="lbl2" ></label>
				</td>
			</tr>
		</div>
		<div>	
		<button class="layui-btn" id="foreward">向前</button>
		<button class="layui-btn" id="pause">暂停</button>
		<button class="layui-btn" id="backward">向后</button>
		<button class="layui-btn" id="go">前进</button>
		<button class="layui-btn" id="stop">停止</button>
		<button class="layui-btn" id="back">后退</button>
		</div>
		<div style="margin: 10px;">
		  <button class="layui-btn" id="openDeepCamera">开启深度摄像头直播</button>
		  <button class="layui-btn" id="closeDeepCamera">关闭深度摄像头直播</button>
		</div>
		<div style="margin: 10px;">
		  <button class="layui-btn" id="openCamera">开启盘点摄像头直播</button>
		  <button class="layui-btn" id="closeCamera">关闭盘点摄像头直播</button>
		</div>
		<div style="margin: 10px;">
		  <button class="layui-btn" id="startUploadPicture">开始上传图片</button>
		  <button class="layui-btn" id="endUploadPicture">停止上传图片</button>
		</div>
		<table class="layui-hide" id="deviceInfo" lay-filter="deviceInfo"></table>
		<script>
			$(document).ready(function() {
			 selectRetInfo();
		     //setInterval("selectRetInfo()", 1000*5);//5秒查询一次设备状态
	       });
	        function selectRetInfo() { 	
				$.ajax({
					type: "GET",
					url: commonIP + 'api/system/device/selectRetInfo?code='+GetQueryString("code"),
					contentType: 'application/json',
					data: 'authToken=' + authToken,
					dataType: 'json', // GET 请求方式需要添加dataType 设定返回数据的格式为json;
					async:false,
					success: function(result) {
						console.log(result);
						$("#lbl1").text(result.dataSource.list[0].code);
						$("#lbl2").text(result.dataSource.list[0].currentState);
					}
				});
			}
		</script>
		<script type="text/javascript">
			var authToken = localStorage.getItem("authToken");
			var user = localStorage.getItem("user");
			
			if(!checkToken()) {
				alert("登录超时，请重新登录！");
				window.top.location.href = '../../login.html';
			}

			layui.use(['form', 'table', 'laydate'], function() {
				var table = layui.table;
				var form = layui.form;
				var laydate = layui.laydate;
				var $ = layui.$;
				table.render({
					elem: '#deviceInfo',
					url: commonIP + "api/system/device/getDetailPage?authToken=" + authToken + '&page=0&limit=0&id=' + GetQueryString("id") //数据请求路径
						,
					parseData: function(res) { //res 即为原始返回的数据
						return {
							"code": 0, //解析接口状态
							"msg": '', //解析提示文本
							"count": 1, //解析数据长度
							"data": parseCol(res) //解析数据列表
						};
					},
					cellMinWidth: 80,
					cols: [
						[	{
								field: 'name',
								title: '猪场名称',
								width: '30%'
							}, {
								field: 'value',
								title: '猪场名称',
								width: '30%'
							}
						]
					],
					done: function(res, curr, count){
//						console.log(new Date())
						$('th').hide();//表头隐藏的样式
					},
					even: true //开启隔行背景
						,
					page: false //开启分页
						,
					limit: 20 //默认十条数据一页
						,
					limits: [10, 20, 30, 50] //数据分页条
						,
					id: 'testReload'
				});
				
				//定时刷新表格
				/*timer = setInterval(function(){tableReload()}, 6000)
				function tableReload(){
					table.reload("testReload")
				}*/
				
				//表格列转换
				function parseCol(data){
					let aDatas = new Array()
					for(let key in data){
						aDatas.push({name: key, value: data[key]})
					}
					return aDatas;
				}
				
				//发送命令
				function sendOrder(control, collection) {
					let param = getOrderParam(control, collection)
					$.ajax({
						url: commonIP + 'api/xlqx/fanout/fanoutSendMsg?msg="' +  param + '"',
						parseData: function(res) { //res 即为原始返回的数据
							return {
								"code": res.code, //解析接口状态
								"msg": res.msg, //解析提示文本
								"count": res.count, //解析数据长度
								"data": res.dataSource.list //解析数据列表
							};
						},
						success: function(res) {
						}
					});
				}
				
				//发送上传命令
				function sendUploadOrder(control) {
					$.ajax({
						url: commonIP + 'api/xlqx/fanout/fanoutSendMsg?msg="' +  control + '"',
						parseData: function(res) { //res 即为原始返回的数据
							return {
								"code": res.code, //解析接口状态
								"msg": res.msg, //解析提示文本
								"count": res.count, //解析数据长度
								"data": res.dataSource.list //解析数据列表
							};
						},
						success: function(res) {
						}
					});
				}
				
				function getOrderParam(control, collection){
					return 'code:' + GetQueryString("code") + ',control:' + control + ',collection:' + collection;
				}
				
				//向前
				$('#foreward').on('click', function() {
					let YN = confirm('是否发送向前采集指令？')
					if(YN){
						sendOrder(1, 1);
					}
				});
				//暂停
				$('#pause').on('click', function() {
					let YN = confirm('是否发送暂停采集指令？')
					if(YN){
						sendOrder(2, 1);
					}
				});
				//向后
				$('#backward').on('click', function() {
					let YN = confirm('是否发送向后采集指令？')
					if(YN){
						sendOrder(0, 1);
					}
				});
				//前进
				$('#go').on('click', function() {
					let YN = confirm('是否发送前进指令？')
					if(YN){
						sendOrder(1, 0);
					}
				});
				//停止
				$('#stop').on('click', function() {
					let YN = confirm('是否发送停止指令？')
					if(YN){
						sendOrder(2, 0);
					}
				});
				//后退
				$('#back').on('click', function() {
					let YN = confirm('是否发送后退指令？')
					if(YN){
						sendOrder(0, 0);
					}
				});
				//开始上传图片
				$('#startUploadPicture').on('click', function() {
					let YN = confirm('是否开始上传指令？')
					if(YN){
						sendUploadOrder("start");
					}
				});
				//停止上传图片
				$('#endUploadPicture').on('click', function() {
					let YN = confirm('是否结束上传指令？')
					if(YN){
						sendUploadOrder("end");
					}
				});
			})
		</script>
		
	</body>

</html>