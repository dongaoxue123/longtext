<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>layui</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">

	</head>
	<script src="../../statics/plugins/layui/layui.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<body>
		<div class="layui-form-item" id="button" style="margin-top: 10px;">
			<form class="layui-form">
				<label class="layui-form-label">集团名称:</label>
				<div class="layui-input-inline">
					<select id="groupId" name="groupId" lay-filter="groupId" style="height: 38px;border-color: #F0F0F0;" lay-search>
						<option value="" data-i18n="farm.groupValDefault"></option>
					</select>
				</div>
				<label class="layui-form-label">猪场名称:</label>
				<div class="layui-input-inline">
					<select id="farmId" name="farmId" lay-filter="farmId" style="height: 38px;border-color: #F0F0F0;" lay-search>
					</select>
				</div>
				<label class="layui-form-label">栋舍列表:</label>
				<div class="layui-input-inline">
					<select id="houseId" name="houseId" style="height: 38px;border-color: #F0F0F0;" lay-search>
					</select>
				</div>
				<label class="layui-form-label">信息时间:</label>
				<div class="layui-input-inline">
					<input class="layui-input" id="creatTime" name="creatTime" class="layui-input">
				</div>
			</form>
		</div>
		<div class="layui-form-item" id="button" style="margin-top: 10px;">
			<label class="layui-form-label" style="width: 100px;">设备识别名称:</label>
			<div class="layui-input-inline">
				<input class="layui-input" id="code" name="code" autocomplete="off">
			</div>
			<button class="layui-btn" id="search">查询</button>

			<button class="layui-btn" id="reset">重置</button>

		</div>
		<table class="layui-hide" id="deviceInfo" lay-filter="deviceInfo"></table>
		<script>
			var farmId;
			var authToken = localStorage.getItem("authToken");
			//alert(authToken);
			var user = localStorage.getItem("user");
			if (!checkToken()) {
				alert("登录超时，请重新登录！");
				window.top.location.href = '../../login.html';
			}

			layui.use(['form', 'table', 'laydate'], function() {
				var table = layui.table;
				var form = layui.form;
				var laydate = layui.laydate;
				var $ = layui.$;

				//创建时间 日期控件
				laydate.render({
					elem: '#creatTime' //指定元素
						,
					theme: 'molv',
					calendar: true //重要节日
				});

				//方法级渲染
				table.render({
					elem: '#deviceInfo',
					url: commonIP + "api/system/device/getDeviceInfo?authToken=" + authToken //数据请求路径
						,
					parseData: function(res) { //res 即为原始返回的数据
						return {
							"code": res.code, //解析接口状态
							"msg": res.msg, //解析提示文本
							"count": res.count, //解析数据长度
							"data": res.errcode === '200' ? res.dataSource.list : [] //解析数据列表
						};
					},
					cellMinWidth: 80,
					cols: [
						[{
								type: 'numbers',
								width: '3%'
							}, {
								field: 'code',
								title: '设备名称',
								width: '10%'
							}, {
								field: 'type',
								title: '类型',
								width: '5%'
							}, {
								field: 'content',
								title: '内容',
								width: '50%'
							}, {
								field: 'time',
								title: '时间',
								width: '30%'
							}
							//		      ,{fixed: 'right',title: '操作', width:'20%',  align:'center', toolbar: '#barDemo'}//一个工具栏  具体请查看layui官网
						]
					],
					even: true //开启隔行背景
						,
					page: true //开启分页
						,
					limit: 10 //默认十条数据一页
						,
					limits: [10, 20, 30, 50] //数据分页条
						,
					id: 'testReload'
				});

				//获取集团下拉列表
				$.ajax({
					url: commonIP + 'api/system/group/getListPage?authToken=' + authToken + '&page=0&limit=0',
					parseData: function(res) { //res 即为原始返回的数据
						return {
							"code": res.code, //解析接口状态
							"msg": res.msg, //解析提示文本
							"count": res.count, //解析数据长度
							"data": res.dataSource.list //解析数据列表
						};
					},
					success: function(res) {
						var dataObj = JSON.parse(res);
						if (dataObj != null && dataObj.dataSource.list.length > 0) {
							var groupOption = '<option value="">请选择集团</option>';
							for (var i = 0; i < dataObj.dataSource.list.length; i++) {
								groupOption = groupOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[
									i].name + '</option>';
							}
							$("#groupId").append(groupOption);
							form.render('select'); //一定要加form.render();
							bindFarmSelectList();

						}
					}
				});

				form.on('select(groupId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
					/**改变集团后先清空猪场下拉值*/
					document.getElementById("farmId").options.length = 0;
					document.getElementById("houseId").options.length = 0;
					$("#farmId").val("");
					$("#houseId").val("");
					form.render('select'); //一定要加form.render();
					bindFarmSelectList();
				});

				//获取猪场下拉
				function bindFarmSelectList() {
					var groupId = $("#groupId").val();
					$.ajax({
						url: commonIP + 'api/system/farm/getListPage?authToken=' + authToken + '&page=0&limit=0&groupId=' + groupId,
						parseData: function(res) { //res 即为原始返回的数据
							return {
								"code": res.code, //解析接口状态
								"msg": res.msg, //解析提示文本
								"count": res.count, //解析数据长度
								"data": res.dataSource.list //解析数据列表
							};
						},
						success: function(res) {
							var dataObj = JSON.parse(res);

							if (dataObj != null && dataObj.dataSource.list.length > 0) {
								var farmOption = '<option value="">请选择猪场</option>';
								for (var i = 0; i < dataObj.dataSource.list.length; i++) {
									farmOption = farmOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource.list[
										i].name + '</option>';
								}
								$("#farmId").append(farmOption);
								form.render('select'); //一定要加form.render();
							}
						}
					});
				}

				form.on('select(farmId)', function(data) { //进行监听 看元素是否变化，获取下一个下拉框数据
					/**改变集团后先清空猪场下拉值*/
					document.getElementById("houseId").options.length = 0;
					$("#houseId").val("");
					form.render('select'); //一定要加form.render();
					bindHouseSelectList();
				});

				//获取栋舍下拉列表
				function bindHouseSelectList() {
					var farmId = $("#farmId").val();
					if (farmId == null || farmId == '') {
						$("#houseId").html('');
						form.render('select'); //一定要加form.render();
					} else {
						$.ajax({
							url: commonIP + 'api/system/house/getHouseListPage?authToken=' + authToken + '&page=0&limit=0&farmId=' +
								farmId,
							parseData: function(res) { //res 即为原始返回的数据
								return {
									"code": res.code, //解析接口状态
									"msg": res.msg, //解析提示文本
									"count": res.count, //解析数据长度
									"data": res.dataSource.list //解析数据列表
								};
							},
							success: function(res) {
								var dataObj = JSON.parse(res);
								if (dataObj != null && dataObj.dataSource.list.length > 0) {
									var houseOption = '<option value="">请选择栋舍</option>';
									for (var i = 0; i < dataObj.dataSource.list.length; i++) {
										houseOption = houseOption + '<option value="' + dataObj.dataSource.list[i].id + '">' + dataObj.dataSource
											.list[i].name + '</option>';
									}
									$("#houseId").html(houseOption);
									form.render('select'); //一定要加form.render();
								}
							}
						});
					}
				}

				var active = {
					reload: function() {
						//执行重载
						table.reload('testReload', {
							page: {
								curr: 1 //重新从第 1 页开始
							},
							where: {
								groupId: $("#groupId").val(),
								farmId: $("#farmId").val(),
								houseId: $("#houseId").val(),
								code: $("#code").val(),
								creatTime: $("#creatTime").val()
							}
						});
					},
				};

				//创建时间 日期控件
				laydate.render({
					elem: '#createDate' //指定元素
						,
					range: true //是否开启范围选择，即双控件
						,
					theme: 'molv',
					calendar: true //重要节日
					//		  	,mark: {'2018-5-14': '生日','2018-5-28': '纪念日'} //日期备注，如重要事件或活动标记
				});
				$('#search').on('click', function() {
					active['reload'].call(this);
				});
				$('#reset').on('click', function() {
					$('#groupId').val("");
					$('#farmId').val("");
					$('#name').val("");
					$('#code').val("");
					$('#houseId').val("");
					
					form.render('select');
					bindFarmSelectList();
					bindHouseSelectList();
					/*$("#farmId option:first").prop("selected", 'selected');  */
				});
			});
		</script>

	</body>
</html>
