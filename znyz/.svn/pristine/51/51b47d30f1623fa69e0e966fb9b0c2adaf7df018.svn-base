<html style="height: 100%;color:#333333;background: #fff;">

	<head>
		<meta charset="UTF-8" />
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
		<!--强制让文档的宽度与设备的宽度保持1:1，并且文档最大的宽度比例是1.0，且不允许用户点击屏幕放大浏览-->
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<!--iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览-->
		<meta content="black" name="apple-mobile-web-app-status-bar-style" />
		<!--iphone的私有标签，它指定的iphone中safari顶端的状态条的样式-->
		<meta name="format-detection" content="telephone=no" />
		<!--告诉设备忽略将页面中的数字识别为电话号码-->
		<meta content="false" name="twcClient" id="twcClient" />
		<!--判断页面是否在本地Native（本地APP）环境中-->
		<title>妊娠母猪体况统计</title>
		<script src="script/flexible.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/flexible_css.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/masklayer.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="iconfont/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="style/common.css" />
		<link rel="stylesheet" type="text/css" href="style/style.css" />
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script src="script/echarts.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			.ovfHiden {
				overflow: hidden;
				height: 100%;
			}
			
			.choose_Btn {
				background: #25B4F5;
				color: #fff
			}
		</style>
		<script>
			var ids = "";
			$(document).ready(function() {
				//展示筛选窗口
				$("#showQuery").click(function() {
					$('html,body').addClass('ovfHiden');
					$("#query").css('display', 'block');
					//局部遮罩层

					$("#allDom").jqLoading({
						type: 1
					});
				})

				//按钮样式切换
				$('.matingStage').click(function() {
					var nodeId = $(this).attr("id");
					if ($(this).is(".choose_Btn")) {
						$(this).removeClass("choose_Btn");
					} else {
						if (nodeId.indexOf("stage") != -1) {
							$(this).parent().children().removeClass("choose_Btn");
						}

						$(this).addClass("choose_Btn");
					}
					//alert($(this).attr("id"))
				});
				//取消查询按钮
				$(".cancel").click(function() {
					$("#query").css('display', 'none');
					//关闭遮罩层
					$("#allDom").jqLoading("destroy");
				});
				//确定查询按钮
				$("#confirm").click(function() {
					parityNumStart = $.trim($("#parityNumStart").val());
					parityNumEnd = $.trim($("#parityNumEnd").val()); //胎次结束条件查询 
					backfatScoreStart = $.trim($("#backfatScoreStart").val()); //评分起始条件查询
					backfatScoreEnd = $.trim($("#backfatScoreEnd").val()); //评分结束条件查询 
					house_id = $.trim($("#houseId").val()); //栋舍
					var seleName = $("select option:selected").text();
					$("#query").css('display', 'none');
					var str = ''; //显示已选条件列表串
					str +='<span><span>'+seleName+'</span></span>'
					$(".choose_Btn").each(function() {
						var nodeId = $(this).attr("id");
						if (nodeId == 'followStatus') {
							followStatus = "1"; //关注条件查询
							str += '<span><span>已关注</span></span>';
						}
						if (nodeId.indexOf("stage") != "-1") {
							var num = nodeId.substring("stage".length);
							matingDateStart = $("#matingDateStart" + num).val(); //配种起始条件查询
							matingDateEnd = $("#matingDateEnd" + num).val(); //配种结束条件查询
							str += '<span><span>配种' + matingDateStart + '~' + matingDateEnd + '天</span></span>'
						}

					});
					
					$("#queryList").html(str)
					getFieldList();
					//关闭遮罩层
					$("#allDom").jqLoading("destroy");
				});

			});
		</script>
	</head>

	<body style="height:100%;">

		<header>
			<span class="iconfont icon-arrow-left" onclick="location='houseList.html'"></span>
			<h1 id="h1_houseName" align="center">妊娠体况评分统计</h1>
		</header>
		<main id="allDom">

			<div class="choose_tit flex">

				<span style="position: absolute; right: 0px; bottom: 0px;"><a  class="border bd_blue" id="showQuery" >筛选</a></span>
			</div>

			<div class="main choose_nav" id="queryList">
				<!--
			<span>
				<span>已关注</span><span class="iconfont icon-close1"></span>
			</span>
			<span>
				<span>配种0~35天</span><span class="iconfont icon-close1"></span>
			</span>
			-->
			</div>
			<div id="container" style="height: 100%"></div>
			<div class="choose_box" style="display: none;" id="query">
				<ul>
					<!--<li>
						<h4>筛选</h4>
						<span id="followStatus" class="matingStage">已关注
						
					</span>
					</li>-->
					<li>
						<h4>栋舍区间</h4>
						<div id="houseSpan" class="houseSpan">
							<select id="houseId" name="house_id" style="width: 70px;">
								
								<option value="0">全部栋舍</option>
							</select>
						</div>
					</li>
					<li>
						<h4>妊娠阶段</h4>
						<span id="stage1" class="matingStage">配种0-35天
						<input type="hidden" name="matingDateStart1" value="0" id="matingDateStart1"/>
						<input type="hidden" name="matingDateEnd1" value="35" id="matingDateEnd1"/>
					</span>
						<span id="stage2" class="matingStage">配种36-85天
						<input type="hidden" name="matingDateStart2" value="36" id="matingDateStart2"/>
						<input type="hidden" name="matingDateEnd2" value="85" id="matingDateEnd2"/>
					</span>
						<span id="stage3" class="matingStage">配种86-112天
						<input type="hidden" name="matingDateStart3" value="86" id="matingDateStart3"/>
						<input type="hidden" name="matingDateEnd3" value="112" id="matingDateEnd3"/>
					</span>
					</li>
					<li>
						<h4>胎次</h4>
						<input type="text" name="parityNumStart" id="parityNumStart" value="" /><i>-</i>
						<input type="text" name="parityNumEnd" id="parityNumEnd" value="" /> 胎
					</li>
					<!--
                    	作者：offline
                    	时间：2018-06-19
                    	描述：
                   
					<li>
						<h4>评分</h4>
						<input type="text" name="backfatScoreStart" id="backfatScoreStart" value="" /><i>-</i>
						<input type="text" name="backfatScoreEnd" id="backfatScoreEnd" value="" />
					</li> -->
				</ul>
				<div class="main box_btn">
					<a class="cancel" style="margin-top: ;">取消</a>
					<a id="confirm">确定</a>
				</div>

			</div>
			<div class="footer">
				<ul>
					<li id="backfatFooter" onclick="location='fieldList.html'" class="active"><span class="iconfont icon-weibiaoti1"></span>
						<h5>测膘</h5></li>
					<li id="countFooter" onclick="location='count.html'"><span class="iconfont icon-pig"></span>
						<h5>统计</h5></li>
					<li id="setFooter" onclick="location='set.html'"><span class="iconfont icon-shezhi"></span>
						<h5>配置</h5></li>
				</ul>
			</div>
		</main>
	</body>
	<script>
		var authToken = localStorage.getItem('authToken');
		var page = 0;
		var currDate;
		var farmId = '';
		var paritySort = 0; //胎次排序  0不排序  1正序  2倒叙
		var increaseWeightSort = 0; //增重排序  0不排序  1正序  2倒叙
		var followStatus = "0" //关注条件查询
		var matingDateStart = ''; //配种起始条件查询
		var matingDateEnd = ''; //配种结束条件查询
		var parityNumStart = ''; //胎次起始条件查询
		var parityNumEnd = ''; //胎次结束条件查询 
		var backfatScoreStart = ''; //评分起始条件查询
		var backfatScoreEnd = ''; //评分结束条件查询 
		var house_id = ''; //栋舍
		$(document).ready(function() {
			// 取得authToken
			if (authToken.length = 0) {
				alert("请重新登录");
				window.top.location.href = 'wxlogin.html';
				return false;
			}
			currDate = getDate();
			var user = localStorage.getItem('user');
			farmId = JSON.parse(user).farmId;
			getHouseList();
			getFieldList(); //查询评分统计
		});

		//查询栋舍
		function getHouseList() {
			var user = localStorage.getItem('user');
			var groupId = JSON.parse(user).groupId;
			var farmId = JSON.parse(user).farmId;
			$.ajax({
				type: "GET",
				url: commonIP + '/api/system/house/getHouseListPage',
				contentType: 'application/json',
				data: 'authToken=' + authToken + '&groupId=' + groupId + '&farmId=' + farmId + '&pageNum=0&pageSize=0',
				dataType: 'json', // GET 请求方式需要添加dataType 设定返回数据的格式为json;
				success: function(data) {
					console.log(data)
					if (data) {
						if (data.errcode == 200) {
							var html = '';
							for (var key in data.dataSource.list) {
								html = html + '<option value="' + data.dataSource.list[key].id + '">' + data.dataSource.list[key].name + '</option>';
								if (key == 0) {
									houseId = data.dataSource.list[key].id;
								}
							}
							$("#houseId").append(html);
						} else {
							alert(data.errmsg);
							if (data.errcode == "10005") {
								window.top.location.href = 'wxlogin.html';
							}
						}
					}
				}
			});
		}

		function getFieldList() {
			initPie();
//			followStatus = "0" //关注条件查询
//			matingDateStart = ''; //配种起始条件查询
//			matingDateEnd = ''; //配种结束条件查询
//			parityNumStart = ''; //胎次起始条件查询
//			parityNumEnd = ''; //胎次结束条件查询 
//			backfatScoreStart = ''; //评分起始条件查询
//			backfatScoreEnd = ''; //评分结束条件查询 
//			house_id = ''; //栋舍
		}
		// 加载饼状图
		function initPie() {
			var queryData = '';
			if (followStatus != null && followStatus != '') {
				queryData += "&followStatus=" + followStatus;
			}
			if (matingDateStart != null && matingDateStart != '') {
				queryData += "&matingDateStart=" + matingDateStart;
			}
			if (matingDateEnd != null && matingDateEnd != '') {
				queryData += "&matingDateEnd=" + matingDateEnd;
			}
			if (parityNumStart != null && parityNumStart != '') {
				queryData += "&parityNumStart=" + parityNumStart;
			}
			if (parityNumEnd != null && parityNumEnd != '') {
				queryData += "&parityNumEnd=" + parityNumEnd;
			}
			if (backfatScoreStart != null && backfatScoreStart != '') {
				queryData += "&backfatScoreStart=" + backfatScoreStart;
			}
			if (backfatScoreEnd != null && backfatScoreEnd != '') {
				queryData += "&backfatScoreEnd=" + backfatScoreEnd;
			}
			if (house_id != null && house_id != '') {
				queryData += "&house_id=" + house_id;
			}
			$.ajax({
				type: "GET",
				url: commonIP + 'api/pig/pigStatistics/getBodyScoreStatistics',
				contentType: 'application/json',
				data: 'authToken=' + authToken + '&farm_id=' + farmId + queryData,
				dataType: 'json', // GET 请求方式需要添加dataType 设定返回数据的格式为json;
				success: function(data) {
					if (data) {
						var res = '';
						if (data.errcode == 200) {
							var dom = document.getElementById("container");
							var myChart = echarts.init(dom);
							var app = {};
							var valData = data.dataSource.list[0];
							option = null;
							option = {
								tooltip: {
									trigger: 'item',
									formatter: "{a} <br/>{b}分: {c}头猪({d}%)"
								},
								legend: {
									orient: 'vertical',
									left: 'left',
									data: valData.tieleName,
									formatter:'{name} 分'
								},
								series: [{
									name: '体况评分',
									type: 'pie',
									radius: '50%',
									center: ['50%', '43%'],
									data: valData.data,
									itemStyle: {
										emphasis: {
											shadowBlur: 10,
											shadowOffsetX: 0,
											shadowColor: 'rgba(0, 0, 0, 0.5)'
										},
										normal:{ 
                       						 label:{ 
                         							show: true, 
                        				    		formatter: '{b}分 : {c}个 ({d}%)' ,
                        				    		textStyle : {
														fontWeight : 'normal',
														fontSize : 7
													}
                       							 }, 
                      					     labelLine :{show:true} 
                   						 } 
									}
								}]
							};;
							myChart.on('click', function(params) {
								
								if (params.componentType === 'markPoint') {
								
									// 点击到了 markPoint 上
									if (params.seriesIndex === 5) {
										// 点击到了 index 为 5 的 series 的 markPoint 上。
									}
								} else if (params.componentType === 'series') {
									var score = params.name;
									window.location.href = 'fieldList.html?score='+score+"&parityNumStart="+parityNumStart+"&parityNumEnd="+parityNumEnd+"&matingDateStart="+matingDateStart+"&matingDateEnd="+matingDateEnd+"&house_id="+house_id;
								}

							});

							if (option && typeof option === "object") {
								myChart.setOption(option, true);
							}

						} else {
							if (data.errcode == 10005) {
								alert(data.errmsg);
								window.top.location.href = 'wxlogin.html';
							}
						}
						if (res.length > 0) {
							$('#fieldInfo').html(res);
						}
					}
				}
			});
		}

		/**
		 * 获取当前时间
		 */
		function getDate() {
			var myDate = new Date();
			//获取当前年
			var year = myDate.getFullYear();
			//获取当前月
			var month = myDate.getMonth() + 1;
			//获取当前日
			var date = myDate.getDate();
			var now = year + '-' + p(month) + "-" + p(date);
			return now;
		}

		function p(s) {
			return s < 10 ? '0' + s : s;
		}
	</script>

</html>