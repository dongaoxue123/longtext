<!doctype html>
<html style="height: 100%;color:#333333;background: #fff;">

	<head>
		<meta charset="UTF-8" />
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
		<!--强制让文档的宽度与设备的宽度保持1:1，并且文档最大的宽度比例是1.0，且不允许用户点击屏幕放大浏览-->
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<!--iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览-->
		<meta content="black" name="apple-mobile-web-app-status-bar-style" />
		<!--iphone的私有标签，它指定的iphone中safari顶端的状态条的样式-->
		<meta name="format-detection" content="telephone=no" />
		<!--告诉设备忽略将页面中的数字识别为电话号码-->
		<meta content="false" name="twcClient" id="twcClient" />
		<!--判断页面是否在本地Native（本地APP）环境中-->
		<title>测重系统</title>
		<script src="script/flexible.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/flexible_css.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="script/common.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="iconfont/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="style/style.css" />
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<style type="text/css">  
	        *{  
	            margin: 0;  
	            padding: 0;  
	        }  
	        html,body{  
	            background: #fff;  
	        }  
	        .btn{  
	            position: fixed;  
	            bottom: 0;  
	            width: 100%;  
	            height: 50px;  
	            background: #eee;  
	        }  
	        .btn input{  
	            width: 100%;  
	            height: 100%;  
	            font: 20px/50px 'microsoft yahei';  
	        }
	        .audio_btn{  
	            position: fixed;  
	            top: 5px;  
	            width: 100%;  
	            height: 100px;  
	            background: #eee;  
	        }  
	        .audio_btn input{  
	            width: 100%;  
	            height: 50%;  
	            font: 20px/50px 'microsoft yahei';  
	        }   
	    </style>  
	</head>

	<body style="height:100%;">
		<main>
	        <audio id="media" src="../zzx-audio/test.mp3" autoplay="" preload=""></audio>
	        <div class="audio_btn" >
    			<input type="button" name="playAudio" id="playAudio" onclick="playAudio()" value="播放/暂停"> 
    			<input type="button" name="replayAudio" id="replayAudio" onclick="replayAudio()" value="重新播放">  
	        </div>
			<div class="btn">  
		        <input type="button" name="messageBtn" id="messageBtn" value="按住 说话">  
		    </div>  
		</main>
		<script>
			// 当前的网页请求地址
			var weixinUrl = document.location.toString();
			var authToken = localStorage.getItem('authToken');// 取得authToken
//			var btnRecord = $('#record');
			var startTime = 0;
			var recordTimer = 300;
 			var btnElem=document.getElementById("messageBtn");//获取ID  
        	var posStart = 0;//初始化起点坐标  
        	var posEnd = 0;//初始化终点坐标  
       		var posMove = 0;//初始化滑动坐标  
       		var playFlag = false;
			$(document).ready(function() {
				$.ajax({
					type: "POST",
					url: commonIP + "api/wxserver/getjsConfig?authToken="+authToken,
					data: JSON.stringify({
						"url":weixinUrl
					}) ,
					contentType: 'application/json',
					success: function(data) {
						console.log(data)
						var data = JSON.parse(data);
						if (data.errcode == 200) {
							wx.config({
//							    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
							    appId: data.dataSource.list[0].appId, // 必填，公众号的唯一标识
							    timestamp: data.dataSource.list[0].timestamp, // 必填，生成签名的时间戳
							    nonceStr: data.dataSource.list[0].nonceStr, // 必填，生成签名的随机串
							    signature: data.dataSource.list[0].signature,// 必填，签名，见附录1
							    jsApiList: [
							    'checkJsApi',
							    'scanQRCode',
							    'startRecord',
								'stopRecord',
								'onRecordEnd',
								'playVoice',
								'pauseVoice',
								'stopVoice',
								'uploadVoice',
								'downloadVoice'
							    ] 
							});
						}
					}
				});
				wx.ready(function() { 
					btnElem.addEventListener("touchstart", function(event) {  
		                event.preventDefault();//阻止浏览器默认行为  
		                posStart = 0;  
		                posStart = event.touches[0].pageY;//获取起点坐标  
		                btnElem.value = '松开 结束';
		                startTime = new Date().getTime();
		                // 延时后录音，避免误操作
		                recordTimer = setTimeout(function () {
		                    wx.startRecord({
		                        success: function () {
		                            localStorage.rainAllowRecord = 'true';
		                            //style="display:block"
		                            $(".voice_icon").css("display", "block");
		                        },
		                        cancel: function () {
		                            layer.open({
		                                content: '用户拒绝了录音授权',
		                                btn: '确定',
		                                shadeClose: false,
		                            });
		                        }
		                    });
		                }, 300);
		            });  
		            btnElem.addEventListener("touchmove", function(event) {  
		                event.preventDefault();//阻止浏览器默认行为  
		                posMove = 0;  
		                posMove = event.targetTouches[0].pageY;//获取滑动实时坐标  
		                if(posStart - posMove < 200){  
		                    btnElem.value = '松开 结束';  
		                }else{  
		                    btnElem.value = '松开手指，取消发送';  
		                }  
		            });  
		            btnElem.addEventListener("touchend", function(event) {
		                event.preventDefault();  
		                posEnd = 0;  
		                posEnd = event.changedTouches[0].pageY;//获取终点坐标  
		                btnElem.value = '按住 说话';
		                if(posStart - posEnd < 200 ){ 
			                // 间隔太短
			                if (new Date().getTime() - startTime < 300) {
			                    startTime = 0;
			                    // 不录音
			                    clearTimeout(recordTimer);
			                } else { // 松手结束录音
			                    wx.stopRecord({
			                        success: function (res) {
			                            // 上传到服务器
			                            uploadVoice(res.localId);
			                        },
			                        fail: function (res) {
			                            //alert(JSON.stringify(res));
			                            layer.open({
			                                content: JSON.stringify(res),
			                                btn: '确定',
			                                shadeClose: false,
			                            });
			                        }
			                    });
			                }
		                }else{
		                	wx.stopRecord({
		                        success: function (res) {
		                        },
		                    });
		                }
		            });
		        });
		        //此方法必须有，之后才能播放语音文件
				document.addEventListener("WeixinJSBridgeReady", function () {
					
				}, false);
			});
			function playAudio(){
				var audio = document.getElementById('media');
				if(audio!==null){             
				    //检测播放是否已暂停.audio.paused 在播放器播放时返回false.
				  	if(audio.paused){
			      		audio.play();//audio.play();// 这个就是播放  
				  	}else{
					    audio.pause();// 这个就是暂停
				  	}
			  	}
			}
			function replayAudio(){
				var audio = document.getElementById('media');
				if(audio.paused){
					audio.currentTime = 0;
					audio.play();
			  	}else{
		      		audio.currentTime = 0;
			  	}
			}
			function uploadVoice(localId) {
		        //调用微信的上传录音接口把本地录音先上传到微信的服务器
		        //不过，微信只保留3天，而我们需要长期保存，我们需要把资源从微信服务器下载到自己的服务器
		       	wx.uploadVoice({
		           localId: localId, // 需要上传的音频的本地ID，由stopRecord接口获得
		           isShowProgressTips: 1, // 默认为1，显示进度提示
		           success: function (res) {
		               if(res.serverId!=null && res.serverId !=''){
			                downLoadVoice(res.serverId);//根据录音在微信服务器上的id（res.serverId），下载录音到本地
		               }else{
		               		alert('上传失败！');
		               }
		            }
		        });
		    }
	        function downLoadVoice(mediaId){
	        	$.ajax({
					type: "GET",
					url: commonIP + "api/wxserver/downLoadVoice?authToken="+authToken+'&mediaId='+mediaId,
					contentType: 'application/json',
					success: function(data) {
						console.log(data)
						var data = JSON.parse(data);
						if (data.errcode == 200) {
							alert('保存成功！');
						}else{
							alert(data.errmsg);
						}
					}
				});
	        }
		</script>
	</body>

</html>