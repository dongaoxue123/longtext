
<html>
<head>
    <title>Title</title>
    <script src="../../statics/libs/jquery-1.7.2.js"></script>
    <link rel="stylesheet" href="../../statics/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../common/css/cyType.css">
    <link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
    <script src="../../statics/plugins/layui/layui.js"></script>
    <script src="../../common/js/whole/cyLayer.js"></script>
    <script src="../../common/js/whole/utils.js"></script>
    <script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
<div class="layui-field-box">
    <form class="layui-form">
    	<div class="layui-form-item" style="padding-right: 20px">
            <label class="layui-form-label">所属集团</label>
            <div class="layui-input-inline">
    	 		<select id="groupId" name="groupId" lay-verify="required|groupId" lay-filter="groupId" style="height: 38px;border-color: #F0F0F0;">
		    	</select>
		    </div>
            <label class="layui-form-label">猪场</label>
            <div class="layui-input-inline">
                <select id="farmId" name ="farmId" lay-verify="required|farmId" lay-filter="farmId" style="height: 38px;border-color: #F0F0F0;">
		    	</select>
            </div>
        </div>
        <div class="layui-form-item" style="padding-right: 20px">
        	<label class="layui-form-label">栋舍列表</label>
            <div class="layui-input-inline">
                <select id="houseId" name="houseId" lay-verify="required|houseId" style="height: 38px;border-color: #F0F0F0;">
		    	</select>
            </div>
        	<label class="layui-form-label">设备名称</label>
            <div class="layui-input-inline">
                <input type="text" id="code" name="code" lay-verify="required|code" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" style="padding-right: 20px">
        	<label class="layui-form-label">设备类型</label>
            <div class="layui-input-inline">
                <select id="deviceType" name="deviceType" style="height: 38px;border-color: #F0F0F0;">
		        	<option value="0">守望者</option>
		        	<option value="1">采集盒</option>
		    	</select>
            </div>
            <label class="layui-form-label StateShow1" style="display: none">状态</label>
            <div class="layui-input-inline StateShow2" style="display: none">
                <select id="state" name="state" style="height: 38px;border-color: #F0F0F0;">
		        	<option value="0">可用</option>
		        	<option value="1">不可用</option>
		    	</select>
            </div>
        </div>
        <div class="page-footer">
            <div class="btn-list">
                <div class="btnlist">
                    <button class="layui-btn" lay-submit="" lay-filter="submit"><i class="fa fa-floppy-o">&nbsp;</i>保存</button>
                    <button class="layui-btn" onclick="$t.closeWindow();"><i class="fa fa-undo">&nbsp;</i>返回</button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
	var farmId;
	var authToken=localStorage.getItem("authToken");
	//alert(authToken);
	var user =localStorage.getItem("user");
 
    layui.use(['form','laydate'], function(){
        var form = layui.form;
        var $ = layui.$;
        var laydate = layui.laydate;
        
		if(!checkToken()){
  			alert("登录超时，请重新登录！");
 			window.top.location.href = '../../login.html';
		}

        //创建时间 日期控件
    	laydate.render({
		  	elem: '#factoryTime' //指定元素
		  	,theme: 'molv'
		  	,calendar: true //重要节日
		});
		var userId = GetQueryString("id");//userId为空表示新增，否则是修改
		if(userId!=null && userId!=''){
		    	$.ajax({
				type: "GET",
				url: commonIP + 'api/system/device/getListPage?authToken='+authToken+'&page=0&limit=0&id='+userId,
				parseData: function(res){ //res 即为原始返回的数据
			    return {
			    "code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			    "data": res.dataSource.list //解析数据列表
			    };
  			    },
				async: false,
				contentType: 'application/json',
				success: function(data) {
					$(".StateShow1").css("display","block");
                    $(".StateShow2").css("display","block");
					var datas = JSON.parse(data);
					console.log(datas);
					if (datas.errcode == 200) {
						//赋值
						groupId = datas.dataSource.list[0].groupId;
					} else {
						alert(data.errmsg);
						if(data.errcode=="10005"){
								window.top.location.href = '../../login.html';
						}
					}
				}
				});
		}
	    //获取集团下拉列表
	   	$.ajax({
	        url: commonIP + 'api/system/group/getListPage?authToken='+authToken+'&page=0&limit=0',
	        parseData: function(res){ //res 即为原始返回的数据
			    return {
			    "code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			    "data": res.dataSource.list //解析数据列表
			    };
  			    },
	        async: false,
            success: function (res) {
        	var dataObj = JSON.parse(res);
    	    if(dataObj!=null && dataObj.dataSource.list.length>0){
                var groupOption;
                for (var i = 0; i < dataObj.dataSource.list.length; i++) {
	            	if(groupId==dataObj.dataSource.list[i].id){
                		groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'" selected="">'+dataObj.dataSource.list[i].name+'</option>';
                	}else{
	            		groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
                	}
                }
                $("#groupId").append(groupOption);
                form.render('select');//一定要加form.render();
                BindFarmDropList();
        	  }
        }
	    });
	    
        form.on('select(groupId)', function (data) { //进行监听 看元素是否变化，获取下一个下拉框数据
	 	   	/**改变集团后先清空猪场下拉值*/
	    	document.getElementById("farmId").options.length = 0;
	    	document.getElementById("houseId").options.length = 0;
	    	BindFarmDropList();
        });
        
        form.on('select(farmId)', function (data) { //进行监听 看元素是否变化，获取下一个下拉框数据
	 	   	/**改变猪场后先清空栋舍下拉值*/
	    	document.getElementById("houseId").options.length = 0;
	    	BindHouseDropList();
        });
        
		//获取猪场下拉列表
		function BindFarmDropList(){
			var groupId = $("#groupId").val();
		   	$.ajax({
		        url: commonIP + 'api/system/farm/getListPage?authToken='+authToken+'&page=0&limit=0&groupId=' + groupId,
		        parseData: function(res){ //res 即为原始返回的数据
			    return {
			    "code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			    "data": res.dataSource.list //解析数据列表
			    };
  			    },
		        async: false,
	            success: function (res) {
	        	var dataObj = JSON.parse(res);
	        	if(dataObj!=null && dataObj.dataSource.list.length>0){
	                var farmOption;
	                for (var i = 0; i < dataObj.dataSource.list.length; i++) {
		            	farmOption = farmOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
	                }
	                $("#farmId").append(farmOption);
	                form.render('select');//一定要加form.render();
	                BindHouseDropList();
	        	  }
	        }
		    }); 
		}
        
        //获取栋舍下拉列表
        function BindHouseDropList(){
        	var farmId = $("#farmId").val();
		   	$.ajax({
		        url: commonIP + 'api/system/house/getHouseListPage?authToken='+authToken+'&page=0&limit=0&farmId='+ farmId,
		        parseData: function(res){ //res 即为原始返回的数据
			    return {
			    "code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			    "data": res.dataSource.list //解析数据列表
			    };
  			    },
		        async: false,
		        success: function (res) {
		    	var dataObj = JSON.parse(res);
			    if(dataObj!=null && dataObj.dataSource.list.length>0){
		            var groupOption;
		            for (var i = 0; i < dataObj.dataSource.list.length; i++) {
		            	groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
		            }
		            $("#houseId").append(groupOption);
		            form.render('select');//一定要加form.render();
		    	  }
		    }
	    }); 
	    }
        
        //监听提交
        if(userId == null)//添加
		{
	        form.on('submit(submit)', function(res){
       		$.ajax({  
                type: 'POST',
				url: commonIP + "api/system/device/create?authToken="+authToken,
				contentType: 'application/json',
				data: JSON.stringify(res.field),
				async: false,
				success: function(data) {
					var dataObj = JSON.parse(data);
					if (dataObj) {
						if (dataObj.errcode == "200") {
					     alert("添加成功！");
                         layer.close(layer.index);  
                         window.parent.location.reload();  
						} else {
						 alert(dataObj.errmsg);
						}
					}
				}
             }); 
             return false;
           });
        }
		else//编辑
		{
			BindUpdateList()
			form.on('submit(submit)', function(res){
       		$.ajax({  
                type: 'POST',
				url: commonIP + "api/system/device/update?authToken="+authToken,
				contentType: 'application/json',
				data: JSON.stringify({
						"id":userId,
						"groupId":res.field.groupId,
						"farmId":res.field.farmId,
						"houseId":res.field.houseId,
						"code":res.field.code,
						"deviceType":res.field.deviceType,
						"state":res.field.state
					}) ,
				async: false,
				success: function(data) {
					var dataObj = JSON.parse(data);
					if (dataObj) {
						if (dataObj.errcode == "200") {
					     alert("修改成功！");
                         layer.close(layer.index);  
                         window.parent.location.reload();  
						} else {
						 alert(dataObj.errmsg);
						}
					}
				}
             }); 
             return false;
           });
		}
        function BindUpdateList(){
		    if(userId != null)//编辑
		    {
		    	$.ajax({
				type: "GET",
				url: commonIP + 'api/system/device/getListPage?authToken='+authToken+'&page=0&limit=0&id='+userId,
				parseData: function(res){ //res 即为原始返回的数据
			    return {
			    "code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			    "data": res.dataSource.list //解析数据列表
			    };
  			    },
				async: false,
				contentType: 'application/json',
				success: function(data) {
					$(".StateShow1").css("display","block");
                    $(".StateShow2").css("display","block");
					var datas = JSON.parse(data);
					console.log(datas);
					if (datas.errcode == 200) {
						//赋值
						$("#groupId").val(datas.dataSource.list[0].groupId);
						$("#farmId").val(datas.dataSource.list[0].farmId);
                        $("#houseId").val(datas.dataSource.list[0].houseId);
                        $("#deviceType").val(datas.dataSource.list[0].deviceType);
						form.render('select');

						$("#code").val(datas.dataSource.list[0].code);
						$("#state").val(datas.dataSource.list[0].state);
					} else {
						alert(data.errmsg);
						if(data.errcode=="10005"){
								window.top.location.href = '../../login.html';
						}
					}
				}
				});
		    }
		    else
		    {
		    	//新增
		    }
        }
    });
    
	
	function GetQueryString(name)
	{
	     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	     var r = window.location.search.substr(1).match(reg);
	     if(r!=null)return  unescape(r[2]); return null;
	}

	/**
	 * 编辑功能赋值
	 */
	function BindData(userId) {

	}

</script>
</body>
</html>
