var idArr = new Array(); //暂存图片id集合
var map = new Map(); //图片容器， key：图片id；value：图片地址
var id = 0;
var count = 0; //图片个数
var authToken; //token
var user; //登录用户
$(document).ready(function() {
	// 取得authToken
	authToken = localStorage.getItem('authToken');
	//alert(authToken)
	if (authToken == null) {
		alert("请重新登录");
		window.top.location.href = 'wxlogin.html';
		return false;
	}
	user = localStorage.getItem('user');

	//上传图片
	$('#file').change(function() {
		var formData = new FormData($('form')[0]);
		$.ajax({
			url: commonIP + 'api/znyz/pig/uploadFile?type=2', //接收页面
			type: 'POST',
			/*xhr: function() { //XHR事件
				alert(1)
			    myXhr = $.ajaxSettings.xhr();
			    if(myXhr.upload){ //检测是否有此方法属性
			        myXhr.upload.addEventListener('progress',progressHandlingFunction, false); // 设置进度
			    }
			    return myXhr;
			},*/
			//Ajax事件
			beforeSend: function() {},
			success: function(data) {
				//alert(data)
				var jsonData = JSON.parse(data);
				idArr[id] = id; //图片下标 ，也是map的key
				map.put(id, jsonData.resourceUrl);
				if (jsonData.resourceUrl == "error") {
					return;
				}
				$(".plus").before('<li id="' + id + '"><span class="iconfont icon-close1" id="deletePic"></span><img src="' + jsonData.resourceUrl + '" /></li>');
				id++;
				count++;
				if (count == 5) {
					$(".plus").hide();
				}
			},
			error: function() {
				alert("系统错误，请联系管理员")
			},
			// Form数据
			data: formData,
			cache: false,
			contentType: false,
			processData: false
		});
	});

	//删除图片
	$("#img_setting").on("click", "span", function(obj) {
		var arrId = $(this).parent().attr("id");
		//$('#deletePic').parent().remove();
		$('#' + arrId).remove();
		map.remove(arrId);
		$(".plus").show();
		count--;
	});

	// 单击+号 触发file元素的click事件
	$(document).on("click", "#triggerUpload", function() {
		console.log(this);
		$("#file").trigger("click");
	});

	//修改查询信息
	var kid = getUrlParam('id'); //猪体况主键
	if (kid != null && kid != '') {
		$.ajax({
			type: "GET",
			url: commonIP + "api/pig/historyRemarks/get",
			contentType: 'application/json',
			data: 'authToken=' + authToken + '&id=' + kid,
			dataType: 'json', // GET 请求方式需要添加dataType 设定返回数据的格式为json;
			success: function(data) {
				console.log(data);
				if (data && data.errcode == 200) {
					var textMessage = data.dataSource.list[0].textMessage;
					$("#record").val(textMessage);
					if (data.dataSource.list[0].pic1 != null && data.dataSource.list[0].pic1 != '') {
						idArr[0] = 0; //图片下标 ，也是map的key
						map.put(0, data.dataSource.list[0].pic1);
						id++;
						count++;
						$(".plus").before('<li id="0"><span class="iconfont icon-close1" id="deletePic"></span><img src="' + data.dataSource.list[0].pic1 + '" /></li>');
					}
					if (data.dataSource.list[0].pic2 != null && data.dataSource.list[0].pic2 != '') {
						idArr[1] = 1; //图片下标 ，也是map的key
						map.put(1, data.dataSource.list[0].pic2);
						count++;
						id++;
						$(".plus").before('<li id="1"><span class="iconfont icon-close1" id="deletePic"></span><img src="' + data.dataSource.list[0].pic2 + '" /></li>');
					}
					if (data.dataSource.list[0].pic3 != null && data.dataSource.list[0].pic3 != '') {
						idArr[2] = 2; //图片下标 ，也是map的key
						map.put(2, data.dataSource.list[0].pic3);
						count++;
						id++;
						$(".plus").before('<li id="2"><span class="iconfont icon-close1" id="deletePic"></span><img src="' + data.dataSource.list[0].pic3 + '" /></li>');
					}
					if (data.dataSource.list[0].pic4 != null && data.dataSource.list[0].pic4 != '') {
						idArr[3] = 3; //图片下标 ，也是map的key
						map.put(3, data.dataSource.list[0].pic4);
						count++;
						id++;
						$(".plus").before('<li id="3"><span class="iconfont icon-close1" id="deletePic"></span><img src="' + data.dataSource.list[0].pic4 + '" /></li>');
					}
					if (data.dataSource.list[0].pic5 != null && data.dataSource.list[0].pic5 != '') {
						idArr[4] = 4; //图片下标 ，也是map的key
						map.put(4, data.dataSource.list[0].pic5);
						count++;
						id++;
						$(".plus").before('<li id="4"><span class="iconfont icon-close1" id="deletePic"></span><img src="' + data.dataSource.list[0].pic5 + '" /></li>');
					}
					if (count == 5) {
					$(".plus").hide();
					}
				} else {
					if (data.errcode == 10005) {
						alert(data.errmsg);
						window.top.location.href = 'wxlogin.html';
					}
				}
			},
			error: function(xhr, type) {}
		});
	}

});

/**
 * 模拟map方法
 */
function Map() {  
	this.obj = {};  
	this.count = 0;
}
Map.prototype.put = function(key, value) {  
	var oldValue = this.obj[key];  
	if (oldValue == undefined) {    
		this.count++;  
	}  
	this.obj[key] = value;
}
Map.prototype.get = function(key) {  
	return this.obj[key];
}
Map.prototype.remove = function(key) {  
	var oldValue = this.obj[key];  
	if (oldValue != undefined) {    
		this.count--;    
		delete this.obj[key];  
	}
}
Map.prototype.size = function() {  
	return this.count;
}

/** 
 * 保存
 */
function BtnClickSave() {
	//图片路径集合 用"|"分隔
	var prctureStr = "";
	
	for (j = 0; j < idArr.length; j++) {
		var url = map.get(idArr[j]);
		if (typeof(url) == "undefined") {
			continue;
		}
		prctureStr = prctureStr + url;
		if (j + 1 < idArr.length) {
			prctureStr = prctureStr + ",";
		}

	}
	//alert(prctureStr);
	//登录用户id
	var userId = JSON.parse(user).id;
	var textMessage = $("#record").val();
	var pigId = getUrlParam('pid'); //猪主键
	var kid = getUrlParam('id'); //体况主键
	if (textMessage == null || textMessage == '') {
		alert("请填写体况备注信息!");
		return;
	}
	if (typeof(kid) == undefined || kid == null || kid == '') {
		//添加
		$.ajax({
			type: "POST",
			url: commonIP + "api/pig/historyRemarks/create?authToken=" + authToken,
			data: JSON.stringify({
				"createUser": userId,
				"updateUser": userId,
				"pictureStr": prctureStr,
				"textMessage": textMessage,
				"pigId": pigId
			}),
			contentType: 'application/json',
			success: function(data) {
				var data = JSON.parse(data);
				if (data.errcode == 200) {
					alert('保存成功');
					//clear();

					window.location.href = 'historyRemark.html?pid=' + getUrlParam('pid');

				} else {
					alert(data.errmsg);
					if (data.errcode == "10005") {
						window.top.location.href = 'wxlogin.html';
						//window.location.href = 'login.html';
					}
				}
			}
		});
	} else {

		//修改
		$.ajax({
			type: "POST",
			url: commonIP + "api/pig/historyRemarks/update?authToken=" + authToken,
			data: JSON.stringify({
				"updateUser": userId,
				"pictureStr": prctureStr,
				"textMessage": textMessage,
				"id": kid
			}),
			contentType: 'application/json',
			success: function(data) {
				var data = JSON.parse(data);
				if (data.errcode == 200) {
					alert('保存成功');
					//clear();

					window.location.href = 'historyRemark.html?pid=' + getUrlParam('pid');

				} else {
					alert(data.errmsg);
					if (data.errcode == "10005") {
						window.top.location.href = 'wxlogin.html';
						//window.location.href = 'login.html';
					}
				}
			}
		});
	}

}

function goBack() {
	window.location.href = 'historyRemark.html?pid=' + getUrlParam('pid');
}