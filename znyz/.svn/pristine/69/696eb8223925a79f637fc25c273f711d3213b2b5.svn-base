<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layui</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
  
</head>
<script src="../../statics/plugins/layui/layui.js"></script>
<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
<body> 
    <div class="layui-upload">
      <label class="layui-form-label">文件信息：</label>
      <input type="file" name="uploadFile" id="uploadFile"/>
    </div>
    <div class="layui-form-item" style="padding-left: 20px">
    <button class="layui-btn" lay-submit="" lay-filter="submit"><i class="fa fa-floppy-o">&nbsp;</i>上传</button>
    </div>
<script>
	var farmId;
	var groupId;
	var userId;
	var authToken=localStorage.getItem("authToken");
	var user =localStorage.getItem("user");
	if(!checkToken()){
  		alert("登录超时，请重新登录！");
 			window.top.location.href = '../../login.html';
	}
	farmId = JSON.parse(user).farmId; 
	groupId = JSON.parse(user).groupId;
	userId = JSON.parse(user).id;
	
  var type = GetQueryString("type");//type=0为导入，type=1为历史导入
  layui.use(['form','upload'], function(){
  	var $ = layui.$;
  	var form = layui.form;
    var upload = layui.upload;
    form.on('submit(submit)', function(res){
			var url = commonIP + 'api/resource/upload?type=1';
			var formData = new FormData();
			formData.append("type", 1);
			formData.append("file", $('#uploadFile').get(0).files[0]);
				$.ajax({
					url: url,
					type: 'POST',
					data: formData,
					async: false,
					cache: false,
					contentType: false,
					processData: false,
					async: false,
					success: function(data) {
						console.log(data)
						if (data.errcode == 200) {
							resourcePath = data.dataSource.list[0].resourcePath;
							//根据excel地址解析
							var url = commonIP + 'api/pig/weaningbusiness/insertWeaning?authToken='+authToken+'&excelUrl='+resourcePath+'&groupId='+groupId+'&farmId='+farmId+'&user='+userId+'&isHistory='+type;
							
							$.ajax({
								type: "GET",
								url: url,
								contentType: 'application/json',
								success: function(result) {
									var rs =  $.parseJSON(result); 
									if (rs.errcode == 200) {
										alert("导入成功")
										layer.close(layer.index);  
                    window.parent.location.reload();  
									}else{
										alert(rs.errmsg);
									}
								}
							});
						} else {
							alert(data.errmsg);
							if (data.errcode == "10005") {
								window.top.location.href = 'login.html';
							}
						}
					},
					error: function(data) {
						alert(JSON.stringify(data));
					}
				})
    });  
  });
  
  function GetQueryString(name)
	{
	     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	     var r = window.location.search.substr(1).match(reg);
	     if(r!=null)return  unescape(r[2]); return null;
	}
</script>

</body>
</html>