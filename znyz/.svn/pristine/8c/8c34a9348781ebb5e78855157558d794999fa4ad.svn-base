<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>种猪档案</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../statics/plugins/layui/css/layui.css" media="all">
  
</head>
<script src="../../statics/plugins/layui/layui.js"></script>
<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
<body> 
    <div class="layui-form-item" id="button" style="margin-top: 10px;">
    	<div class="layui-form-item" style="padding-right: 20px">
			<form class="layui-form">
				<label class="layui-form-label"><span data-i18n="common.houseName"></span>:</label>
				<div class="layui-input-inline">
				  <select id="houseId" name="houseId" style="height: 38px;border-color: #F0F0F0;" lay-search>
				        	<option value="" data-i18n="field.houseOptionDefault"></option>
				    	</select>
				    </div>
    		<label class="layui-form-label"><span data-i18n="common.pigType"></span>:</label>
				<div class="layui-input-inline">			
	      <select id="type" name="type" style="height: 38px;border-color: #F0F0F0;">
	        	<option value="" data-i18n="pig.pigTypeValDefault"></option>
	        	<option value="00032" data-i18n="pig.pigTypeVal1"></option>
	        	<option value="00031" data-i18n="pig.pigTypeVal2"></option>
	        	<option value="00033" data-i18n="pig.pigTypeVal3"></option>
	        	<option value="00034" data-i18n="pig.pigTypeVal4"></option>
	    	</select>
		    </div>
		    <label class="layui-form-label"><span data-i18n="common.pigNumber"></span>:</label>
		    <div class="layui-input-inline">
				<select id="code" name="code" lay-filter="code" style="height: 38px;border-color: #F0F0F0;" lay-search>
					<option value=""></option>
				</select>
		    </div>
		    <label class="layui-form-label" data-i18n="[prepend]common.pregnancyState">:</label>
        <div class="layui-input-inline">
          <select id="status" name="status" style="height: 38px;border-color: #F0F0F0;">
		        	<option value="" data-i18n="pig.pregnancyStateValDefault"></option>
		    	</select>
		    </div>
			<label class="layui-form-label"><span data-i18n="common.fetalTimes"></span>:</label>
			  <div class="layui-input-inline">
			<input type="text" id="parity" autocomplete="off"   name="parity" class="layui-input"  oninput = "value=value.replace(/[^\d]/g,'')" maxlength="2">
			  </div>
		    </form>
			<div class="layui-form-item" style="padding-right: 50px">
				<button class="layui-btn" id="search" data-i18n="btnSearch"></button>
				<button class="layui-btn" id="reset" data-i18n = "btnReset"></button>
				<button class="layui-btn" id="add" data-i18n="btnAdd"></button>
				<button type="button" class="layui-btn" id="download"  ><i class="layui-icon">&#xe601;</i>下载导入模板</button>
				<button type="button" class="layui-btn" id="upload" data-i18n="[append]chooseFile"><i class="layui-icon">&#xe67c;</i></button>
			</div>
		
    </div>
    </div>
<table class="layui-hide" id="pigInfo" lay-filter="pigInfo"></table>
<script type="text/html" id="barDemo">
  <!--<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>-->
  
  <a class="layui-btn layui-btn-xs" lay-event="edit" data-i18n="btnEdit"></a>
	<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" data-i18n = "btnDel"></a>
	<!-- <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail" data-i18n="pig.pigCard"></a> -->
</script>
<!-- 国际化        -->
	<script src="../../statics/plugins/i18n/i18next.min.js"></script>
	<script src="../../statics/plugins/i18n/i18nextXHRBackend.min.js"></script>
	<script src='../../statics/plugins/i18n/loc-i18next.min.js'></script>
<script>
	var farmId;
	var groupId;
	var authToken=localStorage.getItem("authToken");
	//alert(authToken);
	var user =localStorage.getItem("user");
	i18n('../../locales', onLangReady) //国际化
	function onLangReady(){
	if(!checkToken()){
  		alert(i18next.t("timeout"));
   		window.top.location.href = '../../login.html';
	}
	farmId = JSON.parse(user).farmId; 
	groupId = JSON.parse(user).groupId; 

	layui.use(['form','table','laydate'], function(){
		var table = layui.table;
		var form = layui.form;
		var laydate = layui.laydate;
		var $ = layui.$;
		  //方法级渲染
		table.render({
		    elem: '#pigInfo'
		    ,url: commonIP + "api/pig/info/getListPage?authToken="+authToken +'&farm_id='+ farmId //数据请求路径 
		    ,parseData: function(res){ //res 即为原始返回的数据
			    return {
			    	"code": res.code, //解析接口状态
      			"msg": res.msg, //解析提示文本
      			"count": res.count, //解析数据长度
			     	"data": res.errcode === '200' ? res.dataSource.list : [] //解析数据列表
			    };
  			}		    
		    ,cellMinWidth: 80
		    ,cols: [[
		      {type:'numbers',width:'2%'}
		      ,{field:'houseName', title:i18next.t("common.houseName"),width:'6%'}
		      ,{field:'code', title:i18next.t("common.fieldCode"),width:'8%'}
		      ,{field:'pigTypeName', title:i18next.t("common.pigType"),width:'8%'}
		      ,{field:'pigs_number', title:i18next.t("common.pigNumber"),width:'6%'}
		      ,{field:'ear_num', title:i18next.t("common.pigEarNumber"),width:'8%'}
		      ,{field:'production_status_name', title:i18next.t("common.pregnancyState"),width:'10%'}
		      ,{field:'status_start_time', title:i18next.t("pig.stateDate"),width:'7%'}
		      ,{field:'pigVarietyName', title:i18next.t("common.variety"),width:'5%'}
		      ,{field:'strainName', title:i18next.t("common.strain"),width:'5%'}
		      ,{field:'born_date', title:i18next.t("common.birthDate"),width:'8%'}
		      ,{field:'enter_date', title:i18next.t("common.admissionDate"),width:'8%'}
		      ,{field:'parity', title:i18next.t("common.fetalTimes"),width:'8%'}
		      ,{fixed: 'right',title: i18next.t("opt"), width:'11%',  align:'center', toolbar: '#barDemo'}//一个工具栏  具体请查看layui官网
		    ]]
		    ,even: true //开启隔行背景
		    ,page: true   //开启分页
		    ,limit:10   //默认十条数据一页
		    ,limits:[10,20,30,50]  //数据分页条
		    ,id: 'testReload'
		    ,done:function(){
		    	i18n('../../locales') //国际化
		    }
		});
		var page = 1;
		var pageSize = 30;
		var pigsType ='00034';
		//获取猪只下拉列表(母猪编号)
		$.ajax({
		  //  url: commonIP + 'api/pig/info/getListPage?authToken='+authToken +'&farm_id='+farmId + '&page='+page+'&limit='+pageSize+'&pigs_type=00032',
		  url: commonIP + 'api/pig/info/getListPage?authToken='+authToken +'&farm_id='+farmId + '&page='+0+'&limit='+0+'&pigs_type=00032',
		
		  success: function (res) {
		
			var dataObj = JSON.parse(res);
		    if(dataObj!=null && dataObj.dataSource.list.length>0){
		        var groupOption;
		        for (var i = 0; i < dataObj.dataSource.list.length; i++) {
		        	groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].pigs_archives_id+'">'+dataObj.dataSource.list[i].pigs_number+'</option>';
		        }
		        $("#code").append(groupOption);
		        form.render('select');//一定要加form.render();
			  }
		}
		});
		//获取栋舍下拉列表
   	$.ajax({
        url: commonIP + 'api/system/house/getHouseListPage?authToken='+authToken+'&page=0&limit=0&farmId='+ farmId,
        success: function (res) {
    	var dataObj = JSON.parse(res);
	    if(dataObj!=null && dataObj.dataSource.list.length>0){
            var groupOption;
            for (var i = 0; i < dataObj.dataSource.list.length; i++) {
            	groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
            }
            $("#houseId").append(groupOption);
            form.render('select');//一定要加form.render();
    	  }
    }
    }); 
    //获取生产状态下拉列表
	   	$.ajax({
	        url: commonIP + 'api/pig/info/getStatusListSelect?authToken='+authToken+'&groupId='+groupId,
	        success: function (res) {
	    	var dataObj = JSON.parse(res);
		    if(dataObj!=null && dataObj.dataSource.list.length>0){
	            var groupOption;
	            for (var i = 0; i < dataObj.dataSource.list.length; i++) {
	            	groupOption = groupOption+'<option value="'+dataObj.dataSource.list[i].id+'">'+dataObj.dataSource.list[i].name+'</option>';
	            }
	            $("#status").append(groupOption);
	            form.render('select');//一定要加form.render();
	    	  }
	    }
	    }); 
	    
		//监听工具条
			table.on('tool(pigInfo)', function(obj){
			    var data = obj.data;
			    // if(obj.event === 'detail'){
			    //   		var index = layer.open({
							// 			    type: 2,
							// 			    content: "printPigInfo.html?id="+data.pigs_archives_id,
							// 			    area: ['800px', '650px'],
							// 			    maxmin: true
							// 			});  
			    // } else 
				if(obj.event === 'del'){
			        layer.confirm(i18next.t("delConfirm"), function(index){
			      		  $.ajax({  
					            url: commonIP + "api/pig/info/delete?authToken="+authToken,
					            type: 'POST',
											contentType: 'application/json',
											data: JSON.stringify({"pigs_archives_id":data.pigs_archives_id}),
			                success: function(text) {
			                	var dataObj = JSON.parse(text);
			                		if(dataObj.code == 0){
					                		layer.msg(dataObj.msg, {icon: 6});
											        obj.del();
											        layer.close(index);  
			                		}else{
			                				layer.msg(dataObj.msg, {icon: 5});
			                		}
			                }
				            });  
			      		});
			    } else if(obj.event === 'edit'){
			      				    var index = layer.open({
										    type: 2,
										    content: "addPigInfo.html?id="+data.pigs_archives_id,
										    area: ['800px', '600px'],
										    maxmin: true
										});  
			    }
		  });
			  
		  $('#add').on('click', function(){
		   		var index = layer.open({
					    type: 2,
					    content: 'addPigInfo.html',
					    area: ['800px', '600px'],
					    maxmin: true
					});
//					layer.full(index);
		  });
		  
		  $('#upload').on('click', function(){
		   		var index = layer.open({
					    type: 2,
					    content: 'uploadPigInfo.html',
					    area: ['450px', '200px'],
					    maxmin: true
					});
		  });
		  $('#download').on('click', function(){
		   		window.location.href="http://azp.longoor.com/excel_template/导入猪只档案模板.xls"
		  });
		var active = {
		    reload: function(){
		      //执行重载
		      table.reload('testReload', {
		        page: {
		          curr: 1 //重新从第 1 页开始
		        }
		        ,where: {
	            	houseId: $("#houseId").val(),
	            	pigs_number: $('#code option:selected').text(),
	            	pigs_type: $("#type").val(),
	            	production_status_id: $("#status").val(),
					parity: $("#parity").val()
		        }
		      });
		    },
		};

    //创建时间 日期控件
    laydate.render({
		  	elem: '#createDate' //指定元素
		  	,range: true //是否开启范围选择，即双控件
		  	,theme: 'molv'
		  	,calendar: true //重要节日
//		  	,mark: {'2018-5-14': '生日','2018-5-28': '纪念日'} //日期备注，如重要事件或活动标记
		});
		$('#search').on('click', function(){
		    active['reload'].call(this);
		});
		$('#reset').on('click', function(){
			$('#houseId').val("");
			$('#code').val("");
			$('#type').val("");
			$('#status').val("");
			//清空后重新刷新下拉菜单
			$('#code').val("");
			form.render("select");
			     
			/*$("#farmId option:first").prop("selected", 'selected');  */
		});
	});
	}
</script>

</body>
</html>