<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" /><!--强制让文档的宽度与设备的宽度保持1:1，并且文档最大的宽度比例是1.0，且不允许用户点击屏幕放大浏览-->
	<meta content="yes" name="apple-mobile-web-app-capable" /><!--iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览-->
	<meta content="black" name="apple-mobile-web-app-status-bar-style" /><!--iphone的私有标签，它指定的iphone中safari顶端的状态条的样式-->
	<meta name="format-detection" content="telephone=no" /><!--告诉设备忽略将页面中的数字识别为电话号码-->
	<meta content="false" name="twcClient" id="twcClient" /><!--判断页面是否在本地Native（本地APP）环境中-->	
	<title>测重系统</title>
	<link rel="stylesheet" type="text/css" href="iconfont/iconfont.css"/>
	<link rel="stylesheet" type="text/css" href="style/style.css"/>
    <link rel="stylesheet" type="text/css" href="style/common.css"/>
	<script src="script/flexible.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/flexible_css.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="script/common.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
	<div class="page_top">
		<img src="style/logo.png" width="100" class="logo" style="margin-top: 15px;"/>
	</div>
	<div class="login">
    	<ul>
         	<li><span class="iconfont icon-yonghu"></span><input type="text" name="" id="login_name" value="" placeholder="用户名"/></li>
          	<li><span class="iconfont icon-mima"></span><input type="password" name="" id="password" value="" placeholder="密码" /></li>
     	</ul>
	</div>
	<div class="enter"><h3 onclick="login()">登录</h3></div>
	<script>		
		// 登录
		function login() {
			var openId = getUrlParam('openId');
			var loginName = $("#login_name").val();
			var password = $("#password").val();
			if(openId == null || openId == ''){
				openId = localStorage.getItem('openId');
			}
			if (loginName==null) {
				alert("请输入用户名");
				return false;
			}
			if (password==null) {
				alert("请输入密码");
				return false;
			}
			$.ajax({
				type: "POST",
//					url: commonIP + "api/users/newLoginByWeiXin",
			url: commonIP + "api/users/login",
				data: JSON.stringify({
					"loginName":loginName,
					"password":password,
					"openId":openId
				}) ,
				contentType: 'application/json',
				success: function(data) {
					if (data.errcode == 200) {
						var authToken = data.dataSource.list[0].authToken;
						var user = data.dataSource.list[0].user;
						// 设置登录后的authToken
						localStorage.setItem('authToken',authToken);					
						// 设置登录用户信息
						localStorage.setItem('user',JSON.stringify(user));
						localStorage.setItem('openId',openId);
						//获取用户角色信息
						checkRole(authToken,user.id);
					} else {
						alert(data.errmsg);
					}
				}
			});
		}	
		function checkRole(authToken,userId){
			$.ajax({
				type: "GET",
				url: commonIP + 'api/system/userrole/get',
				data: 'authToken='+authToken+'&userId='+userId,
				contentType: 'application/json',
				dataType: 'json',
				success: function(data) {
					if (data.errcode == 200) {
						if(data.dataSource.total<=0){
							alert("该用户没有指定角色，请联系管理员！");
						}else if(data.dataSource.total==1){
							localStorage.setItem('roleId',data.dataSource.list[0].roleId);
							localStorage.setItem('roleName',data.dataSource.list[0].roleName);
							window.location.href = 'index.html';
						}else{
							window.location.href = 'roleSelect.html';
						}
					}else{
						alert("该用户没有指定角色，请联系管理员！");
					}
				}
			});
		}
	</script>
</body>
</html>